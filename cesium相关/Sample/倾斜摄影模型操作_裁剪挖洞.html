<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">  <!-- Use Chrome Frame in IE -->
    <meta name="viewport"
          content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <meta name="description" content="A sample Vector dataset on terrain rendered with 3D Tiles.">
    <meta name="cesium-sandcastle-labels" content="Showcases, 3D Tiles">
    <title>倾斜摄影模型操作_裁剪挖洞</title>
    <link rel="stylesheet" href="../Build/bootstrap.css">
   <script type="text/javascript" src="../Build/CesiumUnminified/Cesium.js"></script>
    <script type="text/javascript" src="../Build/CustomCesiumSDK.js"></script>
    <script type="text/javascript" src="./config.js"></script>
</head>
<body class="sandcastle-loading" data-sandcastle-bucket="bucket-requirejs.html">
<style>
    html, body, #cesiumContainer {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }

    .cesium-viewer, .cesium-viewer-cesiumWidgetContainer, .cesium-widget {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }

    canvas {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }
</style>
<span style="position: absolute;top:10px;left:10px;">
    <button class="btn btn-primary" onclick="cut()">模型裁剪</button>
    <button class="btn btn-info" onclick="flat()">模型压平</button>
    <button class="btn btn-success" onclick="modelDig()">模型挖洞</button>
    <button class="btn btn-warning" onclick="terrainDig()">地表挖洞</button>
</span>
<div id="cesiumContainer" class="fullSize"></div>
<div id="loadingOverlay"><h1>Loading...</h1></div>
<div id="toolbar"></div>
<script id="cesium_sandcastle_script">
    var viewer;
    var tilesetClip;
    var terrainClip;
    var tilesetFlat;
    var terrainPolygon;
    function startup(Cesium) {
		createMap();
    }

    function cut(){
         tilesetClip.addPolygon([
            Cesium.Cartesian3.fromDegrees(118.925692,31.356770, 0),
            Cesium.Cartesian3.fromDegrees(118.929712,31.359983, 0),
            Cesium.Cartesian3.fromDegrees(118.932843,31.355417, 0),
            Cesium.Cartesian3.fromDegrees(118.929225,31.353386, 0),
        ]);

        if(terrainPolygon){
            terrainClip.removePolygon(terrainPolygon);
        }
    }

    function flat(){
        tilesetFlat.addPolygon([
            Cesium.Cartesian3.fromDegrees(118.925692,31.356770, 0),
            Cesium.Cartesian3.fromDegrees(118.929712,31.359983, 0),
            Cesium.Cartesian3.fromDegrees(118.932843,31.355417, 0),
            Cesium.Cartesian3.fromDegrees(118.929225,31.353386, 0),
        ]);
    }

    function modelDig(){
        tilesetClip.addPolygon([
            // Cesium.Cartesian3.fromDegrees(118.925692,31.356770, 0),
            // Cesium.Cartesian3.fromDegrees(118.929712,31.359983, 0),
            // Cesium.Cartesian3.fromDegrees(118.932843,31.355417, 0),
            // Cesium.Cartesian3.fromDegrees(118.929225,31.353386, 0),
            Cesium.Cartesian3.fromDegrees(109.679905,40.682311,0),
            Cesium.Cartesian3.fromDegrees(109.680715,40.681962,0),
            Cesium.Cartesian3.fromDegrees(109.680101,40.681325,0),
            Cesium.Cartesian3.fromDegrees(109.679373,40.681415,0),
        ]);

       terrainPolygon =  terrainClip.addPolygon(
            [
                // Cesium.Cartesian3.fromDegrees(118.925692,31.356770, 0),
                // Cesium.Cartesian3.fromDegrees(118.929712,31.359983, 0),
                // Cesium.Cartesian3.fromDegrees(118.932843,31.355417, 0),
                // Cesium.Cartesian3.fromDegrees(118.929225,31.353386, 0),
                Cesium.Cartesian3.fromDegrees(109.679905,40.682311,0),
                Cesium.Cartesian3.fromDegrees(109.680715,40.681962,0),
                Cesium.Cartesian3.fromDegrees(109.680101,40.681325,0),
                Cesium.Cartesian3.fromDegrees(109.679373,40.681415,0),
            ],
            { diffHeight: -1020 }
        )
    }

    function terrainDig(){
        terrainClip.addPolygon(
            [
                Cesium.Cartesian3.fromDegrees(109.679905,40.682311,0),
                Cesium.Cartesian3.fromDegrees(109.680715,40.681962,0),
                Cesium.Cartesian3.fromDegrees(109.680101,40.681325,0),
                Cesium.Cartesian3.fromDegrees(109.679373,40.681415,0),
            ],
            { diffHeight: -1020 }
        )
    }

    let cesiumTerrainProvider = new Cesium.CesiumTerrainProvider({
        url: '../data/kunshan'
    });

    function createMap() {
        viewer  = new Cesium.Viewer('cesiumContainer',{selectionIndicator: false,
            terrainProvider : cesiumTerrainProvider,
        useBrowserRecommendedResolution:false,
        animation: false,  //是否显示动画控件
        baseLayerPicker: false, //是否显示图层选择控件
        geocoder: false, //是否显示地名查找控件
        timeline: false, //是否显示时间线控件
        sceneModePicker: true, //是否显示投影方式控件
        navigationHelpButton: false, //是否显示帮助信息控件
        infoBox: false,  //是否显示点击要素之后显示的信息
        imageryProvider:false,
        fullscreenButton: true});

        viewer.scene.globe.preloadAncestors = false;

		viewer.scene.primitives.destroyPrimitives = false;
        viewer.scene.globe.depthTestAgainstTerrain = true;
        var imageryLayers = viewer.imageryLayers;

        Cesium.viewer = viewer;

        //天地图影像图层
        var tiandituImageLayer = new Cesium.ImageryLayer(new Cesium.WebMapTileServiceImageryProvider({
            url: baseMapUrl,
            layer: "tdtImg_c",
            style: "default",
            format: "tiles",
            tileMatrixSetID: "c",
            subdomains: ["t0", "t1", "t2", "t3", "t4", "t5", "t6", "t7"],
            tilingScheme: new Cesium.GeographicTilingScheme(),
            tileMatrixLabels: ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19"],
            maximumLevel: 18,
        }));
        viewer.imageryLayers.add(tiandituImageLayer);

        var tile3d = new Cesium.Cesium3DTileset({
            url: '../data/kunqu1/tileset.json',
        });

        tile3d.readyPromise.then(function(tileset){
            // viewer.flyTo(tileset);
            tilesetClip = new Custom.TilesetClip(viewer,{
                tileset: tile3d,
                clipOutSide: false
            });

            terrainClip = new Custom.TerrainClip(viewer,{
                image: "../image/excavate_side_min.jpg",
                imageBottom: "../image/excavate_bottom_min.jpg",
                splitNum: 80 // 井边界插值数
            });

            tilesetFlat = new Custom.TilesetFlat(viewer,{
                tileset: tile3d,
                height: 20
            });
        });

        viewer.scene.primitives.add(tile3d);

        viewer.camera.setView({
            destination:Cesium.Cartesian3.fromDegrees(109.67944982391408,40.679604089958424,1222.353253027183),
            orientation:{
                heading:Cesium.Math.toRadians(11.668971822157879),
                pitch:Cesium.Math.toRadians(-24.233614037762685),
                roll:Cesium.Math.toRadians(0.04223615065110393)
            }
        });

        var handler = new Cesium.ScreenSpaceEventHandler(viewer.canvas);
        handler.setInputAction(function (event) {
            var position = event.position;
            var cartesian =  viewer.scene.pickPosition(position);
            if (!Cesium.defined(cartesian)) {
                return;
            }

            var ellipsoid=viewer.scene.globe.ellipsoid;
            var cartographic=ellipsoid.cartesianToCartographic(cartesian);
            var lat=Cesium.Math.toDegrees(cartographic.latitude);
            var lng=Cesium.Math.toDegrees(cartographic.longitude);
            var height=cartographic.height;
            alert(lng.toFixed(6)+','+ lat.toFixed(6)+','+height);

        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
    }

    if (typeof Cesium !== 'undefined') {
        startup(Cesium);
    }
</script>
</body>
</html>
