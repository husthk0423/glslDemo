define(["./Resource-721e53e7","./GeographicTilingScheme-df19049e","./Cartesian2-cce28994","./defaultValue-81eec7ed","./Rectangle-1bad9972","./WebMercatorProjection-0f98790d","./when-422ea0ae","./UPNG","./ElevationTool","./TerrainUpsample","./Cache","./createTaskProcessorWorker","./Check-edea0f91","./combine-0897f2e3","./Math-29cbc3fa","./RuntimeError-94b0bf5f","./GeographicProjection-54ec8d9d","./LinkedQueue"],(function(e,t,r,n,i,o,s,l,a,u,c,h,f,g,p,d,y,_){"use strict";function x(e){if(e=n.defaultValue(e,n.defaultValue.EMPTY_OBJECT),this._ellipsoid=n.defaultValue(e.ellipsoid,r.Ellipsoid.WGS84),this._numberOfLevelZeroTilesX=n.defaultValue(e.numberOfLevelZeroTilesX,1),this._numberOfLevelZeroTilesY=n.defaultValue(e.numberOfLevelZeroTilesY,1),this._projection=new o.WebMercatorProjection(this._ellipsoid),n.defined(e.rectangleSouthwestInMeters)&&n.defined(e.rectangleNortheastInMeters))this._rectangleSouthwestInMeters=e.rectangleSouthwestInMeters,this._rectangleNortheastInMeters=e.rectangleNortheastInMeters;else{var t=this._ellipsoid.maximumRadius*Math.PI;this._rectangleSouthwestInMeters=new r.Cartesian2(-t,-t),this._rectangleNortheastInMeters=new r.Cartesian2(t,t)}var s=this._projection.unproject(this._rectangleSouthwestInMeters),l=this._projection.unproject(this._rectangleNortheastInMeters);this._rectangle=new i.Rectangle(s.longitude,s.latitude,l.longitude,l.latitude)}Object.defineProperties(x.prototype,{ellipsoid:{get:function(){return this._ellipsoid}},rectangle:{get:function(){return this._rectangle}},projection:{get:function(){return this._projection}}}),x.prototype.getNumberOfXTilesAtLevel=function(e){return this._numberOfLevelZeroTilesX<<e},x.prototype.getNumberOfYTilesAtLevel=function(e){return this._numberOfLevelZeroTilesY<<e},x.prototype.rectangleToNativeRectangle=function(e,t){var r=this._projection,o=r.project(i.Rectangle.southwest(e)),s=r.project(i.Rectangle.northeast(e));return n.defined(t)?(t.west=o.x,t.south=o.y,t.east=s.x,t.north=s.y,t):new i.Rectangle(o.x,o.y,s.x,s.y)},x.prototype.tileXYToNativeRectangle=function(e,t,r,o){var s=this.getNumberOfXTilesAtLevel(r),l=this.getNumberOfYTilesAtLevel(r),a=(this._rectangleNortheastInMeters.x-this._rectangleSouthwestInMeters.x)/s,u=this._rectangleSouthwestInMeters.x+e*a,c=this._rectangleSouthwestInMeters.x+(e+1)*a,h=(this._rectangleNortheastInMeters.y-this._rectangleSouthwestInMeters.y)/l,f=this._rectangleNortheastInMeters.y-t*h,g=this._rectangleNortheastInMeters.y-(t+1)*h;return n.defined(o)?(o.west=u,o.south=g,o.east=c,o.north=f,o):new i.Rectangle(u,g,c,f)},x.prototype.tileXYToRectangle=function(e,t,n,i){var o=this.tileXYToNativeRectangle(e,t,n,i),s=this._projection,l=s.unproject(new r.Cartesian2(o.west,o.south)),a=s.unproject(new r.Cartesian2(o.east,o.north));return o.west=l.longitude,o.south=l.latitude,o.east=a.longitude,o.north=a.latitude,o},x.prototype.positionToTileXY=function(e,t,o){var s=this._rectangle;if(i.Rectangle.contains(s,e)){var l=this.getNumberOfXTilesAtLevel(t),a=this.getNumberOfYTilesAtLevel(t),u=(this._rectangleNortheastInMeters.x-this._rectangleSouthwestInMeters.x)/l,c=(this._rectangleNortheastInMeters.y-this._rectangleSouthwestInMeters.y)/a,h=this._projection.project(e),f=(h.x-this._rectangleSouthwestInMeters.x)/u|0;f>=l&&(f=l-1);var g=(this._rectangleNortheastInMeters.y-h.y)/c|0;return g>=a&&(g=a-1),n.defined(o)?(o.x=f,o.y=g,o):new r.Cartesian2(f,g)}};let w,m,v=65,M={},z=16,S=512,I=new c(100),T={};function N(t,r,n){var i=t.url,o=new e.Resource({url:i});o.request.throttle=!1,o.request.throttleByServer=!0,o.request.type=1;var s=o.fetchArrayBuffer();s?s.then(function(e,r){let i=l.decode(r),o=l.toRGBA8(i)[0],s=function(e,t){let r=new Int16Array(t*t);const n=t;for(let t=0;t<n;t++)for(let i=0;i<n;i++){const o=4*(t*n+i);r[t*n+i]=j(e[o],e[o+1],e[o+2])}return r}(new Uint8Array(o),i.width);t.xyz.z==z&&I.set(t.xyzStr,s);let u=b(s,i.width,n);a.updateElevation(M[w],w,t.xyzStr,s).promise.then((function(t){e.resolve(u)}),(function(t){e.resolve(u)}))}.bind(this,r)):r.reject(null)}function b(e,t,r){let n=Math.floor(t/(v-1)),i=new Int16Array(v*v),o=1e4,s=-2e4;for(let r=0;r<v;r++){let l=r*n*t;r==v-1&&(l=t*t-t);let a=l+t-1;for(let t=0;t<v;t++){let u=t*n+l;t==v-1&&(u=a),i[t+r*v]=e[u],o>e[u]&&(o=e[u]),s<e[u]&&(s=e[u])}}return r.push(i.buffer),{sData:i,_minimumHeight:o,_maximumHeight:s}}function j(e,t,r){return Math.round((256*e*256+256*t+r)/10-1e4)}return h((function(e,r){if(1==e.init)return function(e){return v=e.w,w=e.indexDbName,S=e.tileSize,m="GeographicTilingScheme"==e.tilingSchemeName?new t.GeographicTilingScheme({tileSize:S}):new x({tileSize:S}),z=e.maxLevel,a.getDBMap([w],M)}(e);let n=s.when.defer();return e.xyzStr=e.xyz.x+"_"+e.xyz.y+"_"+e.xyz.z,a.getElevation(M,[w],e.xyzStr).promise.then((function(t){for(let e in t){let i=t[e];if(i){let e=b(i.data,S,r);return void n.resolve(e)}}if(e.xyz.z>z)return function(e,t,r,n){let i=Math.pow(2,e.xyz.z-t),o={x:Math.floor(e.xyz.x/i),y:Math.floor(e.xyz.y/i),z:t},l=e.xyz,c=o.x+"_"+o.y+"_"+o.z,h=I.get(c);if(h){let t=u.upsample(m,h,S,S,o,l),i=b(t,S,n);a.updateElevation(M[w],w,e.xyzStr,t).promise.always((function(e){r.resolve(i)}))}else{let t=e.resourceUrl;if(t=t.replace("{x}",o.x),t=t.replace("{y}",o.y),t=t.replace("{z}",o.z),e.url=t,e.xyz=o,e.xyzStr=e.xyz.x+"_"+e.xyz.y+"_"+e.xyz.z,T[t])r.reject(null);else{let i=s.when.defer();N(e,i,n),T[t]=!0,i.promise.then((function(){let i=I.get(e.xyzStr),s=u.upsample(m,i,S,S,o,l),c=b(s,S,n),h=l.x+"_"+l.y+"_"+l.z;a.updateElevation(M[w],w,h,s).promise.always((function(e){delete T[t],r.resolve(c)}))}),(function(){delete T[t],r.reject(null)}))}}}(e,z,n,r),n.promise;N(e,n,r)})),n.promise}))}));
