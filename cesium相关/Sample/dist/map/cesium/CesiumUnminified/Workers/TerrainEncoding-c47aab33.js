define(["exports","./BoundingSphere-2b618cd6","./Cartesian2-cce28994","./Check-edea0f91","./defaultValue-81eec7ed","./Rectangle-1bad9972","./AttributeCompression-dc008507","./ComponentDatatype-c1201c79","./Math-29cbc3fa","./Matrix4-da4bb68c"],(function(e,t,i,a,r,o,n,s,c,d){"use strict";function u(e,t){this._ellipsoid=e,this._cameraPosition=new i.Cartesian3,this._cameraPositionInScaledSpace=new i.Cartesian3,this._distanceToLimbInScaledSpaceSquared=0,r.defined(t)&&(this.cameraPosition=t)}Object.defineProperties(u.prototype,{ellipsoid:{get:function(){return this._ellipsoid}},cameraPosition:{get:function(){return this._cameraPosition},set:function(e){var t=this._ellipsoid.transformPositionToScaledSpace(e,this._cameraPositionInScaledSpace),a=i.Cartesian3.magnitudeSquared(t)-1;i.Cartesian3.clone(e,this._cameraPosition),this._cameraPositionInScaledSpace=t,this._distanceToLimbInScaledSpaceSquared=a}}});var m=new i.Cartesian3;u.prototype.isPointVisible=function(e){return y(this._ellipsoid.transformPositionToScaledSpace(e,m),this._cameraPositionInScaledSpace,this._distanceToLimbInScaledSpaceSquared)},u.prototype.isScaledSpacePointVisible=function(e){return y(e,this._cameraPositionInScaledSpace,this._distanceToLimbInScaledSpaceSquared)};var l=new i.Cartesian3;u.prototype.isScaledSpacePointVisiblePossiblyUnderEllipsoid=function(e,t){var i,a,o=this._ellipsoid;return r.defined(t)&&t<0&&o.minimumRadius>-t?((a=l).x=this._cameraPosition.x/(o.radii.x+t),a.y=this._cameraPosition.y/(o.radii.y+t),a.z=this._cameraPosition.z/(o.radii.z+t),i=a.x*a.x+a.y*a.y+a.z*a.z-1):(a=this._cameraPositionInScaledSpace,i=this._distanceToLimbInScaledSpaceSquared),y(e,a,i)},u.prototype.computeHorizonCullingPoint=function(e,t,i){return S(this._ellipsoid,e,t,i)};var h=i.Ellipsoid.clone(i.Ellipsoid.UNIT_SPHERE);u.prototype.computeHorizonCullingPointPossiblyUnderEllipsoid=function(e,t,i,a){return S(x(this._ellipsoid,i,h),e,t,a)},u.prototype.computeHorizonCullingPointFromVertices=function(e,t,i,a,r){return g(this._ellipsoid,e,t,i,a,r)},u.prototype.computeHorizonCullingPointFromVerticesPossiblyUnderEllipsoid=function(e,t,i,a,r,o){return g(x(this._ellipsoid,r,h),e,t,i,a,o)};var f=[];u.prototype.computeHorizonCullingPointFromRectangle=function(e,a,r){var n=o.Rectangle.subsample(e,a,0,f),s=t.BoundingSphere.fromPoints(n);if(!(i.Cartesian3.magnitude(s.center)<.1*a.minimumRadius))return this.computeHorizonCullingPoint(s.center,n,r)};var p=new i.Cartesian3;function x(e,t,a){if(r.defined(t)&&t<0&&e.minimumRadius>-t){var o=i.Cartesian3.fromElements(e.radii.x+t,e.radii.y+t,e.radii.z+t,p);e=i.Ellipsoid.fromCartesian3(o,a)}return e}function S(e,t,a,o){r.defined(o)||(o=new i.Cartesian3);for(var n=P(e,t),s=0,c=0,d=a.length;c<d;++c){var u=M(e,a[c],n);if(u<0)return;s=Math.max(s,u)}return b(n,s,o)}var C=new i.Cartesian3;function g(e,t,a,o,n,s){r.defined(s)||(s=new i.Cartesian3),o=r.defaultValue(o,3),n=r.defaultValue(n,i.Cartesian3.ZERO);for(var c=P(e,t),d=0,u=0,m=a.length;u<m;u+=o){C.x=a[u]+n.x,C.y=a[u+1]+n.y,C.z=a[u+2]+n.z;var l=M(e,C,c);if(l<0)return;d=Math.max(d,l)}return b(c,d,s)}function y(e,t,a){var r=t,o=a,n=i.Cartesian3.subtract(e,r,m),s=-i.Cartesian3.dot(n,r);return!(o<0?s>0:s>o&&s*s/i.Cartesian3.magnitudeSquared(n)>o)}var v=new i.Cartesian3,N=new i.Cartesian3;function M(e,t,a){var r=e.transformPositionToScaledSpace(t,v),o=i.Cartesian3.magnitudeSquared(r),n=Math.sqrt(o),s=i.Cartesian3.divideByScalar(r,n,N);o=Math.max(1,o);var c=1/(n=Math.max(1,n));return 1/(i.Cartesian3.dot(s,a)*c-i.Cartesian3.magnitude(i.Cartesian3.cross(s,a,s))*(Math.sqrt(o-1)*c))}function b(e,t,a){if(!(t<=0||t===1/0||t!=t))return i.Cartesian3.multiplyByScalar(e,t,a)}var T=new i.Cartesian3;function P(e,t){return i.Cartesian3.equals(t,i.Cartesian3.ZERO)?t:(e.transformPositionToScaledSpace(t,T),i.Cartesian3.normalize(T,T))}var z={getHeight:function(e,t,i){return(e-i)*t+i}},_=new i.Cartesian3;z.getPosition=function(e,t,a,r,o){var n=t.cartesianToCartographic(e,_),s=z.getHeight(n.height,a,r);return i.Cartesian3.fromRadians(n.longitude,n.latitude,s,t,o)};var E=Object.freeze({NONE:0,BITS12:1}),H=new i.Cartesian3,w=new i.Cartesian3,A=new i.Cartesian2,I=new d.Matrix4,V=new d.Matrix4,q=Math.pow(2,12);function G(e,t,a,o,n,s,c,u,m,l){var h,f,p=E.NONE;if(r.defined(t)&&r.defined(a)&&r.defined(o)&&r.defined(n)){var x=t.minimum,S=t.maximum,C=i.Cartesian3.subtract(S,x,w),g=o-a;p=Math.max(i.Cartesian3.maximumComponent(C),g)<q-1?E.BITS12:E.NONE,h=d.Matrix4.inverseTransformation(n,new d.Matrix4);var y=i.Cartesian3.negate(x,H);d.Matrix4.multiply(d.Matrix4.fromTranslation(y,I),h,h);var v=H;v.x=1/C.x,v.y=1/C.y,v.z=1/C.z,d.Matrix4.multiply(d.Matrix4.fromScale(v,I),h,h),f=d.Matrix4.clone(n),d.Matrix4.setTranslation(f,i.Cartesian3.ZERO,f),n=d.Matrix4.clone(n,new d.Matrix4);var N=d.Matrix4.fromTranslation(x,I),M=d.Matrix4.fromScale(C,V),b=d.Matrix4.multiply(N,M,I);d.Matrix4.multiply(n,b,n),d.Matrix4.multiply(f,b,f)}this.quantization=p,this.minimumHeight=a,this.maximumHeight=o,this.center=i.Cartesian3.clone(e),this.toScaledENU=h,this.fromScaledENU=n,this.matrix=f,this.hasVertexNormals=s,this.hasWebMercatorT=r.defaultValue(c,!1),this.hasGeodeticSurfaceNormals=r.defaultValue(u,!1),this.exaggeration=r.defaultValue(m,1),this.exaggerationRelativeHeight=r.defaultValue(l,0),this.stride=0,this._offsetGeodeticSurfaceNormal=0,this._offsetVertexNormal=0,this._calculateStrideAndOffsets()}G.prototype.encode=function(e,t,a,r,o,s,u,m){var l=r.x,h=r.y;if(this.quantization===E.BITS12){(a=d.Matrix4.multiplyByPoint(this.toScaledENU,a,H)).x=c.CesiumMath.clamp(a.x,0,1),a.y=c.CesiumMath.clamp(a.y,0,1),a.z=c.CesiumMath.clamp(a.z,0,1);var f=this.maximumHeight-this.minimumHeight,p=c.CesiumMath.clamp((o-this.minimumHeight)/f,0,1);i.Cartesian2.fromElements(a.x,a.y,A);var x=n.AttributeCompression.compressTextureCoordinates(A);i.Cartesian2.fromElements(a.z,p,A);var S=n.AttributeCompression.compressTextureCoordinates(A);i.Cartesian2.fromElements(l,h,A);var C=n.AttributeCompression.compressTextureCoordinates(A);if(e[t++]=x,e[t++]=S,e[t++]=C,this.hasWebMercatorT){i.Cartesian2.fromElements(u,0,A);var g=n.AttributeCompression.compressTextureCoordinates(A);e[t++]=g}}else i.Cartesian3.subtract(a,this.center,H),e[t++]=H.x,e[t++]=H.y,e[t++]=H.z,e[t++]=o,e[t++]=l,e[t++]=h,this.hasWebMercatorT&&(e[t++]=u);return this.hasVertexNormals&&(e[t++]=n.AttributeCompression.octPackFloat(s)),this.hasGeodeticSurfaceNormals&&(e[t++]=m.x,e[t++]=m.y,e[t++]=m.z),t};var B=new i.Cartesian3,O=new i.Cartesian3;G.prototype.addGeodeticSurfaceNormals=function(e,t,i){if(!this.hasGeodeticSurfaceNormals){var a=this.stride,r=e.length/a;this.hasGeodeticSurfaceNormals=!0,this._calculateStrideAndOffsets();for(var o=this.stride,n=0;n<r;n++){for(var s=0;s<a;s++){var c=n*a+s;t[n*o+s]=e[c]}var d=this.decodePosition(t,n,B),u=i.geodeticSurfaceNormal(d,O),m=n*o+this._offsetGeodeticSurfaceNormal;t[m]=u.x,t[m+1]=u.y,t[m+2]=u.z}}},G.prototype.removeGeodeticSurfaceNormals=function(e,t){if(this.hasGeodeticSurfaceNormals){var i=this.stride,a=e.length/i;this.hasGeodeticSurfaceNormals=!1,this._calculateStrideAndOffsets();for(var r=this.stride,o=0;o<a;o++)for(var n=0;n<r;n++){var s=o*i+n;t[o*r+n]=e[s]}}},G.prototype.decodePosition=function(e,t,a){if(r.defined(a)||(a=new i.Cartesian3),t*=this.stride,this.quantization===E.BITS12){var o=n.AttributeCompression.decompressTextureCoordinates(e[t],A);a.x=o.x,a.y=o.y;var s=n.AttributeCompression.decompressTextureCoordinates(e[t+1],A);return a.z=s.x,d.Matrix4.multiplyByPoint(this.fromScaledENU,a,a)}return a.x=e[t],a.y=e[t+1],a.z=e[t+2],i.Cartesian3.add(a,this.center,a)},G.prototype.getExaggeratedPosition=function(e,t,i){i=this.decodePosition(e,t,i);var a=this.exaggeration,r=this.exaggerationRelativeHeight;if(1!==a&&this.hasGeodeticSurfaceNormals){var o=this.decodeGeodeticSurfaceNormal(e,t,O),n=this.decodeHeight(e,t),s=z.getHeight(n,a,r)-n;i.x+=o.x*s,i.y+=o.y*s,i.z+=o.z*s}return i},G.prototype.decodeTextureCoordinates=function(e,t,a){return r.defined(a)||(a=new i.Cartesian2),t*=this.stride,this.quantization===E.BITS12?n.AttributeCompression.decompressTextureCoordinates(e[t+2],a):i.Cartesian2.fromElements(e[t+4],e[t+5],a)},G.prototype.decodeHeight=function(e,t){return t*=this.stride,this.quantization===E.BITS12?n.AttributeCompression.decompressTextureCoordinates(e[t+1],A).y*(this.maximumHeight-this.minimumHeight)+this.minimumHeight:e[t+3]},G.prototype.decodeWebMercatorT=function(e,t){return t*=this.stride,this.quantization===E.BITS12?n.AttributeCompression.decompressTextureCoordinates(e[t+3],A).x:e[t+6]},G.prototype.getOctEncodedNormal=function(e,t,a){var r=e[t=t*this.stride+this._offsetVertexNormal]/256,o=Math.floor(r),n=256*(r-o);return i.Cartesian2.fromElements(o,n,a)},G.prototype.decodeGeodeticSurfaceNormal=function(e,t,i){return t=t*this.stride+this._offsetGeodeticSurfaceNormal,i.x=e[t],i.y=e[t+1],i.z=e[t+2],i},G.prototype._calculateStrideAndOffsets=function(){var e=0;if(this.quantization===E.BITS12)e+=3;else e+=6;this.hasWebMercatorT&&(e+=1),this.hasVertexNormals&&(this._offsetVertexNormal=e,e+=1),this.hasGeodeticSurfaceNormals&&(this._offsetGeodeticSurfaceNormal=e,e+=3),this.stride=e};var R={position3DAndHeight:0,textureCoordAndEncodedNormals:1,geodeticSurfaceNormal:2},U={compressed0:0,compressed1:1,geodeticSurfaceNormal:2};G.prototype.getAttributes=function(e){var t=s.ComponentDatatype.FLOAT,i=s.ComponentDatatype.getSizeInBytes(t),a=this.stride*i,r=0,o=[];function n(n,s){o.push({index:n,vertexBuffer:e,componentDatatype:t,componentsPerAttribute:s,offsetInBytes:r,strideInBytes:a}),r+=s*i}if(this.quantization===E.NONE){n(R.position3DAndHeight,4);var c=2;c+=this.hasWebMercatorT?1:0,c+=this.hasVertexNormals?1:0,n(R.textureCoordAndEncodedNormals,c),this.hasGeodeticSurfaceNormals&&n(R.geodeticSurfaceNormal,3)}else{var d=this.hasWebMercatorT||this.hasVertexNormals,u=this.hasWebMercatorT&&this.hasVertexNormals;n(U.compressed0,d?4:3),u&&n(U.compressed1,1),this.hasGeodeticSurfaceNormals&&n(U.geodeticSurfaceNormal,3)}return o},G.prototype.getAttributeLocations=function(){return this.quantization===E.NONE?R:U},G.clone=function(e,t){if(r.defined(e))return r.defined(t)||(t=new G),t.quantization=e.quantization,t.minimumHeight=e.minimumHeight,t.maximumHeight=e.maximumHeight,t.center=i.Cartesian3.clone(e.center),t.toScaledENU=d.Matrix4.clone(e.toScaledENU),t.fromScaledENU=d.Matrix4.clone(e.fromScaledENU),t.matrix=d.Matrix4.clone(e.matrix),t.hasVertexNormals=e.hasVertexNormals,t.hasWebMercatorT=e.hasWebMercatorT,t.hasGeodeticSurfaceNormals=e.hasGeodeticSurfaceNormals,t.exaggeration=e.exaggeration,t.exaggerationRelativeHeight=e.exaggerationRelativeHeight,t._calculateStrideAndOffsets(),t},e.EllipsoidalOccluder=u,e.TerrainEncoding=G}));
