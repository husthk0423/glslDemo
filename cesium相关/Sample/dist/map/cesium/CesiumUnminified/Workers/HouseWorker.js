define(["./createTaskProcessorWorker","./Resource-721e53e7","./Cartesian2-cce28994","./HouseDrawer","./snappyJs","./GetPrimitiveData","./when-422ea0ae","./ScanLine","./ElevationTool","./Cache","./defaultValue-81eec7ed","./Check-edea0f91","./combine-0897f2e3","./Math-29cbc3fa","./RuntimeError-94b0bf5f","./Color-f5223c05","./Transforms-599d3866","./Matrix4-da4bb68c","./ComponentDatatype-c1201c79","./WebGLConstants-1c8239cc","./GeometryInstance-0944d7d9","./PolygonGeometry-19cf3721","./ArcType-98ec98bf","./GeometryOffsetAttribute-0a70352a","./BoundingRectangle-01a4d1a7","./GeographicProjection-54ec8d9d","./BoundingSphere-2b618cd6","./Rectangle-1bad9972","./EllipsoidGeodesic-bc3178c0","./EllipsoidTangentPlane-3ee186ca","./AxisAlignedBoundingBox-a270696e","./IntersectionTests-878c0e54","./Plane-d04f021c","./GeometryAttribute-c4e682f4","./Matrix2-c857e514","./GeometryPipeline-b8be120b","./AttributeCompression-dc008507","./EncodedCartesian3-d8b5d6fd","./IndexDatatype-2503dc5a","./PolygonGeometryLibrary-348aa659","./arrayRemoveDuplicates-9a47c9b6","./EllipsoidRhumbLine-52cdeee5","./GeometryAttributes-32b29525","./PolygonPipeline-8ba20582","./VertexFormat-aef87cc2","./PolygonOutlineGeometry-cd5f1454","./PixelFormat-eb286997","./PrimitivePipeline-86b65bb6","./WebMercatorProjection-0f98790d","./GetRidingLanternGeometry","./LinkedQueue"],(function(e,t,r,n,l,o,i,a,c,s,f,u,h,d,g,y,p,m,b,P,v,w,x,A,G,C,D,S,M,E,L,R,B,F,T,I,N,O,k,H,V,j,q,z,J,W,_,Q,U,K,X){"use strict";let Y,Z,$,ee=512,te="",re={},ne={},le=new s(1e5);function oe(e){let t=1e3,r=0;for(let n=0;n<e.length;n++){let l=e[n];for(let e=0;e<l.length-1;e++){let n=Math.round(l[e+1]);n<t&&(t=n),n>r&&(r=n),e++}}return{ymax:r,ymin:t}}function ie(e,t){let n=t.rectangle;for(var l=[],o=0;o<e.length;o++){var i=ae(e[o],e[o+1],n),a=r.Cartesian3.fromDegrees(i[0],i[1]);l.push(a),o++}return l}function ae(e,t,r){var n=ce(r.west+r.width/ee*e),l=ce(r.north-r.height/ee*t);return[n=Number(n.toFixed(6)),l=Number(l.toFixed(6))]}function ce(e){return 180*e/Math.PI}function se(e,t){if(Array.isArray(t[0])){let r=t.length;for(let n=0;n<r;n++){se(e,t[n])}}else e.push(t)}function fe(e,t){if("F"!=e[0])if(Array.isArray(e[0])){let r=e.length;for(let n=0;n<r;n++){fe(e[n],t)}}else t&&function(e){let t=[e[0],e[1]];for(let r=2;r<e.length;r++){let n=t[0]+e[r],l=t[1]+e[r+1];e[r]=n,e[r+1]=l,t=[n,l],r++}}(e);else e[0]=[.05*-ee,.05*-ee,1.05*ee,.05*-ee,1.05*ee,1.05*ee,.05*-ee,1.05*ee]}return e((function(e,r){if(1==e.init)return function(e){return Y=new Function("drawer","level",e.styleStr),ee=e.tileSize,te=e.return_type,re=e,Z=e.indexDbNames,$=e.indexDbName,c.getDBMap(Z,ne)}(e);var s,f=e.url,u=new t.Resource({url:f});if(u.request.throttle=!1,u.request.throttleByServer=!0,u.request.type=1,!(s="stream_snappy"==te?u.fetchArrayBuffer():u.fetchJson()))return!0;let h=[];h.push(s);let d=Z.slice(0,Z.length-1);h.push(c.getElevation(ne,d,e.xyz));let g=i.when.defer();return i.when.all(h,(function(t){let i=t[0];if(i||(i={}),"stream_snappy"==te){i=l(i);let e=function(e){let t=[],r=0,n=0;for(;r<e.length;){let l=e[r++];if(l<128)t[n++]=l;else if(l>191&&l<224){let o=e[r++];t[n++]=(31&l)<<6|63&o}else if(l>239&&l<365){let o=((7&l)<<18|(63&e[r++])<<12|(63&e[r++])<<6|63&e[r++])-65536;t[n++]=55296+(o>>10),t[n++]=56320+(1023&o)}else{let o=e[r++],i=e[r++];t[n++]=(15&l)<<12|(63&o)<<6|63&i}}let l=[],o=0,i=0,a=0,c=5e4,s=t.length/c-1;for(o=0;o<s;o++)i=o*c,a=(o+1)*c,l.push(String.fromCharCode.apply({},t.slice(i,a)));return i=o*c,a=t.length,l.push(String.fromCharCode.apply({},t.slice(i,a))),l=l.join(""),l}(new Uint8Array(i));i=JSON.parse(e)}let s=function(e,t){if(e&&e.layer){(function(e,t){for(let r in e){let n=e[r].features;n||(n=e[r].datas);for(let e=0;e<n.length;e++)fe(n[e][2],t)}})(e=e.layer,t.needDecode);let r={},l=new n([e],t.level,r,t.controlVector,t.highLightVector,t.filterLayerId);return Y.call({},l,t.level),function(e){for(let t in e){let r=e[t];for(let e=0;e<r.length;e++){let t=r[e],n=[];se(n,t.data),delete t.data,t.geometrys=n;let l=0;if(re.hasOwnProperty("heightProperty")){let e=re.heightProperty;l=t.properties[e],re.hasOwnProperty("heightScale")&&(l*=parseFloat(re.heightScale))}t.height=l,t.totalHeight=l}}}(r),r}return{}}(i,e);re.hasTerrain&&function(e,t){var r=1e3,n=0;for(let l in e){let o=e[l];for(let e=0;e<o.length;e++){let l=o[e],i=-2e4,a=le.get(l.properties.id);if(a)i=a;else{for(let e=0;e<l.geometrys.length;e++){let o=l.geometrys[e];for(let e=0;e<o.length-1;e++){let l=Math.round(o[e]),a=Math.round(o[e+1]);if(a<r&&(r=a),a>n&&(n=a),e++,l<0||l>ee-1||a<0||a>ee-1)continue;let c=a*ee+l,s=0;for(let e in t){s+=t[e].data[c]}s>i&&(i=s)}}-2e4==i&&(i=0),le.set(l.properties.id,i)}l.terrainHeight=i,l.totalHeight=i+l.height}}}(s,t[1]);let f=function(e,t){let r=new Int32Array(t*t);for(let n in e){let l=e[n];for(let e=0;e<l.length;e++){let n=l[e],o=oe(n.geometrys);a(r,n,t,o.ymax,o.ymin)}}return r}(s,ee);!function(e,t){for(let r in e){let n=e[r];for(let e=0;e<n.length;e++){let r=n[e];r.polygons=[];for(let e=0;e<r.geometrys.length;e++){let n=ie(r.geometrys[e],t);r.polygons.push(n)}delete r.geometrys}}}(s,e);let u=o(s,e.level,re,r);c.updateElevation(ne[$],$,e.xyz,f).promise.then((function(e){g.resolve(u)}),(function(e){g.resolve(u)}))})),g.promise}))}));
