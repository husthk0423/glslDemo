define(["./when-c2e8ef35","./Check-c4f3a3fc","./Math-d30358ed","./Cartesian2-f9492f23","./BoundingSphere-dcb1d5fc","./Transforms-8b7e0d39","./RuntimeError-6122571f","./Rectangle-3285eeb3","./WebGLConstants-4ae0db90","./ComponentDatatype-5d3f6452","./AttributeCompression-72a6590f","./IntersectionTests-525ff5aa","./Plane-dbdf17bf","./WebMercatorProjection-6d7fb40a","./createTaskProcessorWorker","./EllipsoidTangentPlane-98a8a37e","./OrientedBoundingBox-fd425b2c","./TerrainEncoding-dc4d155b"],(function(e,t,i,n,a,r,o,s,u,h,d,c,g,l,m,p,f,v){"use strict";var I=Uint16Array.BYTES_PER_ELEMENT,E=Int32Array.BYTES_PER_ELEMENT,T=Uint32Array.BYTES_PER_ELEMENT,C=Float32Array.BYTES_PER_ELEMENT,M=Float64Array.BYTES_PER_ELEMENT;function N(t,n,a){a=e.defaultValue(a,i.CesiumMath);for(var r=t.length,o=0;o<r;++o)if(a.equalsEpsilon(t[o],n,i.CesiumMath.EPSILON12))return o;return-1}var x=new n.Cartographic,b=new n.Cartesian3,S=new n.Cartesian3,w=new n.Cartesian3,P=new r.Matrix4;function B(t,a,o,s,u,h,d,c,g,l){for(var m=d.length,p=0;p<m;++p){var f=d[p],v=f.cartographic,I=f.index,E=t.length,T=v.longitude,C=v.latitude;C=i.CesiumMath.clamp(C,-i.CesiumMath.PI_OVER_TWO,i.CesiumMath.PI_OVER_TWO);var M=v.height-h.skirtHeight;h.hMin=Math.min(h.hMin,M),n.Cartographic.fromRadians(T,C,M,x),g&&(x.longitude+=c),g?p===m-1?x.latitude+=l:0===p&&(x.latitude-=l):x.latitude+=c;var N=h.ellipsoid.cartographicToCartesian(x);t.push(N),a.push(M),o.push(n.Cartesian2.clone(o[I])),s.length>0&&s.push(s[I]),r.Matrix4.multiplyByPoint(h.toENU,N,b);var S=h.minimum,w=h.maximum;n.Cartesian3.minimumByComponent(b,S,S),n.Cartesian3.maximumByComponent(b,w,w);var P=h.lastBorderPoint;if(e.defined(P)){var B=P.index;u.push(B,E-1,E,E,I,B)}h.lastBorderPoint=f}}return m((function(t,u){t.ellipsoid=n.Ellipsoid.clone(t.ellipsoid),t.rectangle=s.Rectangle.clone(t.rectangle);var h=function(t,s,u,h,d,c,g,m,R,y){var A,_,W,F,O,Y;e.defined(h)?(A=h.west,_=h.south,W=h.east,F=h.north,O=h.width,Y=h.height):(A=i.CesiumMath.toRadians(d.west),_=i.CesiumMath.toRadians(d.south),W=i.CesiumMath.toRadians(d.east),F=i.CesiumMath.toRadians(d.north),O=i.CesiumMath.toRadians(h.width),Y=i.CesiumMath.toRadians(h.height));var k,U,V=[_,F],H=[A,W],L=r.Transforms.eastNorthUpToFixedFrame(s,u),D=r.Matrix4.inverseTransformation(L,P);m&&(k=l.WebMercatorProjection.geodeticLatitudeToMercatorAngle(_),U=1/(l.WebMercatorProjection.geodeticLatitudeToMercatorAngle(F)-k));var G=new DataView(t),j=Number.POSITIVE_INFINITY,z=Number.NEGATIVE_INFINITY,q=S;q.x=Number.POSITIVE_INFINITY,q.y=Number.POSITIVE_INFINITY,q.z=Number.POSITIVE_INFINITY;var J=w;J.x=Number.NEGATIVE_INFINITY,J.y=Number.NEGATIVE_INFINITY,J.z=Number.NEGATIVE_INFINITY;var K,Q,X=0,Z=0,$=0;for(Q=0;Q<4;++Q){var ee=X;K=G.getUint32(ee,!0),ee+=T;var te=i.CesiumMath.toRadians(180*G.getFloat64(ee,!0));ee+=M,-1===N(H,te)&&H.push(te);var ie=i.CesiumMath.toRadians(180*G.getFloat64(ee,!0));ee+=M,-1===N(V,ie)&&V.push(ie),ee+=2*M;var ne=G.getInt32(ee,!0);ee+=E,Z+=ne,$+=3*(ne=G.getInt32(ee,!0)),X+=K+T}var ae=[],re=[],oe=new Array(Z),se=new Array(Z),ue=new Array(Z),he=m?new Array(Z):[],de=new Array($),ce=[],ge=[],le=[],me=[],pe=0,fe=0;for(X=0,Q=0;Q<4;++Q){K=G.getUint32(X,!0);var ve=X+=T,Ie=i.CesiumMath.toRadians(180*G.getFloat64(X,!0));X+=M;var Ee=i.CesiumMath.toRadians(180*G.getFloat64(X,!0));X+=M;var Te=i.CesiumMath.toRadians(180*G.getFloat64(X,!0)),Ce=.5*Te;X+=M;var Me=i.CesiumMath.toRadians(180*G.getFloat64(X,!0)),Ne=.5*Me;X+=M;var xe=G.getInt32(X,!0);X+=E;var be=G.getInt32(X,!0);X+=E,X+=E;for(var Se=new Array(xe),we=0;we<xe;++we){var Pe=Ie+G.getUint8(X++)*Te;x.longitude=Pe;var Be=Ee+G.getUint8(X++)*Me;x.latitude=Be;var Re=G.getFloat32(X,!0);if(X+=C,0!==Re&&Re<y&&(Re*=-Math.pow(2,R)),Re*=6371010*c,x.height=Re,-1!==N(H,Pe)||-1!==N(V,Be)){var ye=N(ae,x,n.Cartographic);if(-1!==ye){Se[we]=re[ye];continue}ae.push(n.Cartographic.clone(x)),re.push(pe)}Se[we]=pe,Math.abs(Pe-A)<Ce?ce.push({index:pe,cartographic:n.Cartographic.clone(x)}):Math.abs(Pe-W)<Ce?le.push({index:pe,cartographic:n.Cartographic.clone(x)}):Math.abs(Be-_)<Ne?ge.push({index:pe,cartographic:n.Cartographic.clone(x)}):Math.abs(Be-F)<Ne&&me.push({index:pe,cartographic:n.Cartographic.clone(x)}),j=Math.min(Re,j),z=Math.max(Re,z),ue[pe]=Re;var Ae=u.cartographicToCartesian(x);oe[pe]=Ae,m&&(he[pe]=(l.WebMercatorProjection.geodeticLatitudeToMercatorAngle(Be)-k)*U),r.Matrix4.multiplyByPoint(D,Ae,b),n.Cartesian3.minimumByComponent(b,q,q),n.Cartesian3.maximumByComponent(b,J,J);var _e=(Pe-A)/(W-A);_e=i.CesiumMath.clamp(_e,0,1);var We=(Be-_)/(F-_);We=i.CesiumMath.clamp(We,0,1),se[pe]=new n.Cartesian2(_e,We),++pe}for(var Fe=3*be,Oe=0;Oe<Fe;++Oe,++fe)de[fe]=Se[G.getUint16(X,!0)],X+=I;if(K!==X-ve)throw new o.RuntimeError("Invalid terrain tile.")}oe.length=pe,se.length=pe,ue.length=pe,m&&(he.length=pe);var Ye=pe,ke=fe,Ue={hMin:j,lastBorderPoint:void 0,skirtHeight:g,toENU:D,ellipsoid:u,minimum:q,maximum:J};ce.sort((function(e,t){return t.cartographic.latitude-e.cartographic.latitude})),ge.sort((function(e,t){return e.cartographic.longitude-t.cartographic.longitude})),le.sort((function(e,t){return e.cartographic.latitude-t.cartographic.latitude})),me.sort((function(e,t){return t.cartographic.longitude-e.cartographic.longitude}));var Ve=1e-5;if(B(oe,ue,se,he,de,Ue,ce,-Ve*O,!0,-Ve*Y),B(oe,ue,se,he,de,Ue,ge,-Ve*Y,!1),B(oe,ue,se,he,de,Ue,le,Ve*O,!0,Ve*Y),B(oe,ue,se,he,de,Ue,me,Ve*Y,!1),ce.length>0&&me.length>0){var He=ce[0].index,Le=Ye,De=me[me.length-1].index,Ge=oe.length-1;de.push(De,Ge,Le,Le,He,De)}Z=oe.length;var je,ze=a.BoundingSphere.fromPoints(oe);e.defined(h)&&(je=f.OrientedBoundingBox.fromRectangle(h,j,z,u));for(var qe=new v.EllipsoidalOccluder(u).computeHorizonCullingPointPossiblyUnderEllipsoid(s,oe,j),Je=new p.AxisAlignedBoundingBox(q,J,s),Ke=new v.TerrainEncoding(Je,Ue.hMin,z,L,!1,m),Qe=new Float32Array(Z*Ke.getStride()),Xe=0,Ze=0;Ze<Z;++Ze)Xe=Ke.encode(Qe,Xe,oe[Ze],se[Ze],ue[Ze],void 0,he[Ze]);var $e=ce.map((function(e){return e.index})).reverse(),et=ge.map((function(e){return e.index})).reverse(),tt=le.map((function(e){return e.index})).reverse(),it=me.map((function(e){return e.index})).reverse();return et.unshift(tt[tt.length-1]),et.push($e[0]),it.unshift($e[$e.length-1]),it.push(tt[0]),{vertices:Qe,indices:new Uint16Array(de),maximumHeight:z,minimumHeight:j,encoding:Ke,boundingSphere3D:ze,orientedBoundingBox:je,occludeePointInScaledSpace:qe,vertexCountWithoutSkirts:Ye,indexCountWithoutSkirts:ke,westIndicesSouthToNorth:$e,southIndicesEastToWest:et,eastIndicesNorthToSouth:tt,northIndicesWestToEast:it}}(t.buffer,t.relativeToCenter,t.ellipsoid,t.rectangle,t.nativeRectangle,t.exaggeration,t.skirtHeight,t.includeWebMercatorT,t.negativeAltitudeExponentBias,t.negativeElevationThreshold),d=h.vertices;u.push(d.buffer);var c=h.indices;return u.push(c.buffer),{vertices:d.buffer,indices:c.buffer,numberOfAttributes:h.encoding.getStride(),minimumHeight:h.minimumHeight,maximumHeight:h.maximumHeight,boundingSphere3D:h.boundingSphere3D,orientedBoundingBox:h.orientedBoundingBox,occludeePointInScaledSpace:h.occludeePointInScaledSpace,encoding:h.encoding,vertexCountWithoutSkirts:h.vertexCountWithoutSkirts,indexCountWithoutSkirts:h.indexCountWithoutSkirts,westIndicesSouthToNorth:h.westIndicesSouthToNorth,southIndicesEastToWest:h.southIndicesEastToWest,eastIndicesNorthToSouth:h.eastIndicesNorthToSouth,northIndicesWestToEast:h.northIndicesWestToEast}}))}));
