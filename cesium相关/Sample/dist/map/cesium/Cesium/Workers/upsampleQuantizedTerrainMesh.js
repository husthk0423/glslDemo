define(["./when-c2e8ef35","./Check-c4f3a3fc","./Math-d30358ed","./Cartesian2-f9492f23","./BoundingSphere-dcb1d5fc","./Transforms-8b7e0d39","./RuntimeError-6122571f","./Rectangle-3285eeb3","./WebGLConstants-4ae0db90","./ComponentDatatype-5d3f6452","./AttributeCompression-72a6590f","./IndexDatatype-e3260434","./IntersectionTests-525ff5aa","./Plane-dbdf17bf","./createTaskProcessorWorker","./EllipsoidTangentPlane-98a8a37e","./OrientedBoundingBox-fd425b2c","./TerrainEncoding-dc4d155b"],(function(e,t,i,n,s,r,h,u,o,a,d,p,f,l,c,g,m,x){"use strict";var v={clipTriangleAtAxisAlignedThreshold:function(t,i,n,s,r,h){var u,o,a;e.defined(h)?h.length=0:h=[],i?(u=n<t,o=s<t,a=r<t):(u=n>t,o=s>t,a=r>t);var d,p,f,l,c,g,m=u+o+a;return 1===m?u?(d=(t-n)/(s-n),p=(t-n)/(r-n),h.push(1),h.push(2),1!==p&&(h.push(-1),h.push(0),h.push(2),h.push(p)),1!==d&&(h.push(-1),h.push(0),h.push(1),h.push(d))):o?(f=(t-s)/(r-s),l=(t-s)/(n-s),h.push(2),h.push(0),1!==l&&(h.push(-1),h.push(1),h.push(0),h.push(l)),1!==f&&(h.push(-1),h.push(1),h.push(2),h.push(f))):a&&(c=(t-r)/(n-r),g=(t-r)/(s-r),h.push(0),h.push(1),1!==g&&(h.push(-1),h.push(2),h.push(1),h.push(g)),1!==c&&(h.push(-1),h.push(2),h.push(0),h.push(c))):2===m?u||n===t?o||s===t?a||r===t||(p=(t-n)/(r-n),f=(t-s)/(r-s),h.push(2),h.push(-1),h.push(0),h.push(2),h.push(p),h.push(-1),h.push(1),h.push(2),h.push(f)):(g=(t-r)/(s-r),d=(t-n)/(s-n),h.push(1),h.push(-1),h.push(2),h.push(1),h.push(g),h.push(-1),h.push(0),h.push(1),h.push(d)):(l=(t-s)/(n-s),c=(t-r)/(n-r),h.push(0),h.push(-1),h.push(1),h.push(0),h.push(l),h.push(-1),h.push(2),h.push(0),h.push(c)):3!==m&&(h.push(0),h.push(1),h.push(2)),h},computeBarycentricCoordinates:function(t,i,s,r,h,u,o,a,d){var p=s-o,f=o-h,l=u-a,c=r-a,g=1/(l*p+f*c),m=i-a,x=t-o,v=(l*x+f*m)*g,w=(-c*x+p*m)*g,C=1-v-w;return e.defined(d)?(d.x=v,d.y=w,d.z=C,d):new n.Cartesian3(v,w,C)},computeLineSegmentLineSegmentIntersection:function(t,i,s,r,h,u,o,a,d){var p=(a-u)*(s-t)-(o-h)*(r-i);if(0!==p){var f=((o-h)*(i-u)-(a-u)*(t-h))/p,l=((s-t)*(i-u)-(r-i)*(t-h))/p;return f>=0&&f<=1&&l>=0&&l<=1?(e.defined(d)||(d=new n.Cartesian2),d.x=t+f*(s-t),d.y=i+f*(r-i),d):void 0}}},w=32767,C=16383,y=[],B=[],I=[],b=new n.Cartographic,A=new n.Cartesian3,T=[],z=[],M=[],N=[],V=[],E=new n.Cartesian3,R=new s.BoundingSphere,H=new m.OrientedBoundingBox,O=new n.Cartesian2,S=new n.Cartesian3;function U(){this.vertexBuffer=void 0,this.index=void 0,this.first=void 0,this.second=void 0,this.ratio=void 0}U.prototype.clone=function(t){return e.defined(t)||(t=new U),t.uBuffer=this.uBuffer,t.vBuffer=this.vBuffer,t.heightBuffer=this.heightBuffer,t.normalBuffer=this.normalBuffer,t.index=this.index,t.first=this.first,t.second=this.second,t.ratio=this.ratio,t},U.prototype.initializeIndexed=function(e,t,i,n,s){this.uBuffer=e,this.vBuffer=t,this.heightBuffer=i,this.normalBuffer=n,this.index=s,this.first=void 0,this.second=void 0,this.ratio=void 0},U.prototype.initializeFromClipResult=function(e,t,i){var n=t+1;return-1!==e[t]?i[e[t]].clone(this):(this.vertexBuffer=void 0,this.index=void 0,this.first=i[e[n]],++n,this.second=i[e[n]],++n,this.ratio=e[n],++n),n},U.prototype.getKey=function(){return this.isIndexed()?this.index:JSON.stringify({first:this.first.getKey(),second:this.second.getKey(),ratio:this.ratio})},U.prototype.isIndexed=function(){return e.defined(this.index)},U.prototype.getH=function(){return e.defined(this.index)?this.heightBuffer[this.index]:i.CesiumMath.lerp(this.first.getH(),this.second.getH(),this.ratio)},U.prototype.getU=function(){return e.defined(this.index)?this.uBuffer[this.index]:i.CesiumMath.lerp(this.first.getU(),this.second.getU(),this.ratio)},U.prototype.getV=function(){return e.defined(this.index)?this.vBuffer[this.index]:i.CesiumMath.lerp(this.first.getV(),this.second.getV(),this.ratio)};var F=new n.Cartesian2,P=-1,k=[new n.Cartesian3,new n.Cartesian3],D=[new n.Cartesian3,new n.Cartesian3];function W(e,t){++P;var i=k[P],s=D[P];return i=d.AttributeCompression.octDecode(e.first.getNormalX(),e.first.getNormalY(),i),s=d.AttributeCompression.octDecode(e.second.getNormalX(),e.second.getNormalY(),s),A=n.Cartesian3.lerp(i,s,e.ratio,A),n.Cartesian3.normalize(A,A),d.AttributeCompression.octEncode(A,t),--P,t}U.prototype.getNormalX=function(){return e.defined(this.index)?this.normalBuffer[2*this.index]:(F=W(this,F)).x},U.prototype.getNormalY=function(){return e.defined(this.index)?this.normalBuffer[2*this.index+1]:(F=W(this,F)).y};var X=[];function K(t,i,n,s,r,h,u,o,a){if(0!==u.length){for(var d=0,p=0;p<u.length;)p=X[d++].initializeFromClipResult(u,p,o);for(var f=0;f<d;++f){var l=X[f];if(l.isIndexed())l.newIndex=h[l.index],l.uBuffer=t,l.vBuffer=i,l.heightBuffer=n,a&&(l.normalBuffer=s);else{var c=l.getKey();if(e.defined(h[c]))l.newIndex=h[c];else{var g=t.length;t.push(l.getU()),i.push(l.getV()),n.push(l.getH()),a&&(s.push(l.getNormalX()),s.push(l.getNormalY())),l.newIndex=g,h[c]=g}}}3===d?(r.push(X[0].newIndex),r.push(X[1].newIndex),r.push(X[2].newIndex)):4===d&&(r.push(X[0].newIndex),r.push(X[1].newIndex),r.push(X[2].newIndex),r.push(X[0].newIndex),r.push(X[2].newIndex),r.push(X[3].newIndex))}}return X.push(new U),X.push(new U),X.push(new U),X.push(new U),c((function(e,t){var r=e.isEastChild,h=e.isNorthChild,o=r?C:0,a=r?w:C,d=h?C:0,f=h?w:C,l=T,c=z,g=M,F=V;l.length=0,c.length=0,g.length=0,F.length=0;var P=N;P.length=0;var k={},D=e.vertices,W=e.indices;W=W.subarray(0,e.indexCountWithoutSkirts);var X,L,Y,_,G,J=x.TerrainEncoding.clone(e.encoding),Z=J.hasVertexNormals,j=e.exaggeration,q=0,Q=e.vertexCountWithoutSkirts,$=e.minimumHeight,ee=e.maximumHeight,te=new Array(Q),ie=new Array(Q),ne=new Array(Q),se=Z?new Array(2*Q):void 0;for(L=0,Y=0;L<Q;++L,Y+=2){var re=J.decodeTextureCoordinates(D,L,O);if(X=J.decodeHeight(D,L)/j,_=i.CesiumMath.clamp(re.x*w|0,0,w),G=i.CesiumMath.clamp(re.y*w|0,0,w),ne[L]=i.CesiumMath.clamp((X-$)/(ee-$)*w|0,0,w),_<20&&(_=0),G<20&&(G=0),w-_<20&&(_=w),w-G<20&&(G=w),te[L]=_,ie[L]=G,Z){var he=J.getOctEncodedNormal(D,L,S);se[Y]=he.x,se[Y+1]=he.y}(r&&_>=C||!r&&_<=C)&&(h&&G>=C||!h&&G<=C)&&(k[L]=q,l.push(_),c.push(G),g.push(ne[L]),Z&&(F.push(se[Y]),F.push(se[Y+1])),++q)}var ue=[];ue.push(new U),ue.push(new U),ue.push(new U);var oe,ae=[];for(ae.push(new U),ae.push(new U),ae.push(new U),L=0;L<W.length;L+=3){var de=W[L],pe=W[L+1],fe=W[L+2],le=te[de],ce=te[pe],ge=te[fe];ue[0].initializeIndexed(te,ie,ne,se,de),ue[1].initializeIndexed(te,ie,ne,se,pe),ue[2].initializeIndexed(te,ie,ne,se,fe);var me=v.clipTriangleAtAxisAlignedThreshold(C,r,le,ce,ge,y);(oe=0)>=me.length||((oe=ae[0].initializeFromClipResult(me,oe,ue))>=me.length||(oe=ae[1].initializeFromClipResult(me,oe,ue))>=me.length||(oe=ae[2].initializeFromClipResult(me,oe,ue),K(l,c,g,F,P,k,v.clipTriangleAtAxisAlignedThreshold(C,h,ae[0].getV(),ae[1].getV(),ae[2].getV(),B),ae,Z),oe<me.length&&(ae[2].clone(ae[1]),ae[2].initializeFromClipResult(me,oe,ue),K(l,c,g,F,P,k,v.clipTriangleAtAxisAlignedThreshold(C,h,ae[0].getV(),ae[1].getV(),ae[2].getV(),B),ae,Z))))}var xe=r?-32767:0,ve=h?-32767:0,we=[],Ce=[],ye=[],Be=[],Ie=Number.MAX_VALUE,be=-Ie,Ae=I;Ae.length=0;var Te=n.Ellipsoid.clone(e.ellipsoid),ze=u.Rectangle.clone(e.childRectangle),Me=ze.north,Ne=ze.south,Ve=ze.east,Ee=ze.west;for(Ve<Ee&&(Ve+=i.CesiumMath.TWO_PI),L=0;L<l.length;++L)(_=Math.round(l[L]))<=o?(we.push(L),_=0):_>=a?(ye.push(L),_=w):_=2*_+xe,l[L]=_,(G=Math.round(c[L]))<=d?(Ce.push(L),G=0):G>=f?(Be.push(L),G=w):G=2*G+ve,c[L]=G,(X=i.CesiumMath.lerp($,ee,g[L]/w))<Ie&&(Ie=X),X>be&&(be=X),g[L]=X,b.longitude=i.CesiumMath.lerp(Ee,Ve,_/w),b.latitude=i.CesiumMath.lerp(Ne,Me,G/w),b.height=X,Te.cartographicToCartesian(b,A),Ae.push(A.x),Ae.push(A.y),Ae.push(A.z);var Re=s.BoundingSphere.fromVertices(Ae,n.Cartesian3.ZERO,3,R),He=m.OrientedBoundingBox.fromRectangle(ze,Ie,be,Te,H),Oe=new x.EllipsoidalOccluder(Te).computeHorizonCullingPointFromVerticesPossiblyUnderEllipsoid(Re.center,Ae,3,Re.center,Ie,E),Se=be-Ie,Ue=new Uint16Array(l.length+c.length+g.length);for(L=0;L<l.length;++L)Ue[L]=l[L];var Fe=l.length;for(L=0;L<c.length;++L)Ue[Fe+L]=c[L];for(Fe+=c.length,L=0;L<g.length;++L)Ue[Fe+L]=w*(g[L]-Ie)/Se;var Pe,ke=p.IndexDatatype.createTypedArray(l.length,P);if(Z){var De=new Uint8Array(F);t.push(Ue.buffer,ke.buffer,De.buffer),Pe=De.buffer}else t.push(Ue.buffer,ke.buffer);return{vertices:Ue.buffer,encodedNormals:Pe,indices:ke.buffer,minimumHeight:Ie,maximumHeight:be,westIndices:we,southIndices:Ce,eastIndices:ye,northIndices:Be,boundingSphere:Re,orientedBoundingBox:He,horizonOcclusionPoint:Oe}}))}));
