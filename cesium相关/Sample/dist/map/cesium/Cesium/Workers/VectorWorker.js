define(["./ColorUtil","./when-c2e8ef35","./Check-c4f3a3fc","./Math-d30358ed","./Cartesian2-f9492f23","./Transforms-8b7e0d39","./RuntimeError-6122571f","./createTaskProcessorWorker","./snappyJs","./VectorDrawer"],(function(e,t,n,i,r,s,o,a,h,l){"use strict";class d{constructor(e){this.segments=e||[]}prepareSegment(e,t,n,i){let r=this.segments[this.segments.length-1];return e>d.MAX_VERTEX_ARRAY_LENGTH&&console.log(`Max vertices per segment is ${d.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${e}`),(!r||r.vertexLength+e>d.MAX_VERTEX_ARRAY_LENGTH||r.sortKey!==i)&&(r={vertexOffset:t.length,primitiveOffset:n.length,vertexLength:0,primitiveLength:0},void 0!==i&&(r.sortKey=i),this.segments.push(r)),r}get(){return this.segments}destroy(){for(const e of this.segments)e.vao&&e.vao.destroy()}static simpleSegment(e,t,n,i){return new d([{vertexOffset:e,primitiveOffset:t,vertexLength:n,primitiveLength:i,sortKey:0}])}}d.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1;class u{constructor(e){this.style=e.style,this.type=e.type,this.tileSize=e.tileSize}serialize(e){}destroy(){}}function c(e,t,n,i,r){f(e,t,n||0,i||e.length-1,r||p)}function f(e,t,n,i,r){for(;i>n;){if(i-n>600){var s=i-n+1,o=t-n+1,a=Math.log(s),h=.5*Math.exp(2*a/3),l=.5*Math.sqrt(a*h*(s-h)/s)*(o-s/2<0?-1:1);f(e,t,Math.max(n,Math.floor(t-o*h/s+l)),Math.min(i,Math.floor(t+(s-o)*h/s+l)),r)}var d=e[t],u=n,c=i;for(g(e,n,t),r(e[i],d)>0&&g(e,n,i);u<c;){for(g(e,u,c),u++,c--;r(e[u],d)<0;)u++;for(;r(e[c],d)>0;)c--}0===r(e[n],d)?g(e,n,c):g(e,++c,i),c<=t&&(n=c+1),t<=c&&(i=c-1)}}function g(e,t,n){var i=e[t];e[t]=e[n],e[n]=i}function p(e,t){return e<t?-1:e>t?1:0}function x(e){let t=0;for(let n,i,r=0,s=e.length,o=s-1;r<s;o=r++)n=e[r],i=e[o],t+=(i.x-n.x)*(n.y+i.y);return t}function y(e,t){return t.area-e.area}var m={WINDING_ODD:0,WINDING_NONZERO:1,WINDING_POSITIVE:2,WINDING_NEGATIVE:3,WINDING_ABS_GEQ_TWO:4,POLYGONS:0,CONNECTED_POLYGONS:1,BOUNDARY_CONTOURS:2,tesselate:function(e){for(var t=e.debug||!1,n=new V,i=0;i<e.contours.length;i++)n.addContour(e.vertexSize||2,e.contours[i]);return n.tesselate(e.windingRule||m.WINDING_ODD,e.elementType||m.POLYGONS,e.polySize||3,e.vertexSize||2,e.normal||[0,0,1]),{vertices:n.vertices,vertexIndices:n.vertexIndices,vertexCount:n.vertexCount,elements:n.elements,elementCount:n.elementCount,mesh:t?n.mesh:void 0}}},v=function(e){if(!e)throw"Assertion Failed!"};function O(){this.next=null,this.prev=null,this.anEdge=null,this.coords=[0,0,0],this.s=0,this.t=0,this.pqHandle=0,this.n=0,this.idx=0}function L(){this.next=null,this.prev=null,this.anEdge=null,this.trail=null,this.n=0,this.marked=!1,this.inside=!1}function E(e){this.next=null,this.Sym=null,this.Onext=null,this.Lnext=null,this.Org=null,this.Lface=null,this.activeRegion=null,this.winding=0,this.side=e}function S(){var e=new O,t=new L,n=new E(0),i=new E(1);e.next=e.prev=e,e.anEdge=null,t.next=t.prev=t,t.anEdge=null,t.trail=null,t.marked=!1,t.inside=!1,n.next=n,n.Sym=i,n.Onext=null,n.Lnext=null,n.Org=null,n.Lface=null,n.winding=0,n.activeRegion=null,i.next=i,i.Sym=n,i.Onext=null,i.Lnext=null,i.Org=null,i.Lface=null,i.winding=0,i.activeRegion=null,this.vHead=e,this.fHead=t,this.eHead=n,this.eHeadSym=i}E.prototype={get Rface(){return this.Sym.Lface},set Rface(e){this.Sym.Lface=e},get Dst(){return this.Sym.Org},set Dst(e){this.Sym.Org=e},get Oprev(){return this.Sym.Lnext},set Oprev(e){this.Sym.Lnext=e},get Lprev(){return this.Onext.Sym},set Lprev(e){this.Onext.Sym=e},get Dprev(){return this.Lnext.Sym},set Dprev(e){this.Lnext.Sym=e},get Rprev(){return this.Sym.Onext},set Rprev(e){this.Sym.Onext=e},get Dnext(){return this.Sym.Onext.Sym},set Dnext(e){this.Sym.Onext.Sym=e},get Rnext(){return this.Sym.Lnext.Sym},set Rnext(e){this.Sym.Lnext.Sym=e}},S.prototype={makeEdge_:function(e){var t=new E(0),n=new E(1);e.Sym.side<e.side&&(e=e.Sym);var i=e.Sym.next;return n.next=i,i.Sym.next=t,t.next=e,e.Sym.next=n,t.Sym=n,t.Onext=t,t.Lnext=n,t.Org=null,t.Lface=null,t.winding=0,t.activeRegion=null,n.Sym=t,n.Onext=n,n.Lnext=t,n.Org=null,n.Lface=null,n.winding=0,n.activeRegion=null,t},splice_:function(e,t){var n=e.Onext,i=t.Onext;n.Sym.Lnext=t,i.Sym.Lnext=e,e.Onext=i,t.Onext=n},makeVertex_:function(e,t,n){var i=e;v(null!==i);var r=n.prev;i.prev=r,r.next=i,i.next=n,n.prev=i,i.anEdge=t;var s=t;do{s.Org=i,s=s.Onext}while(s!==t)},makeFace_:function(e,t,n){var i=e;v(null!==i);var r=n.prev;i.prev=r,r.next=i,i.next=n,n.prev=i,i.anEdge=t,i.trail=null,i.marked=!1,i.inside=n.inside;var s=t;do{s.Lface=i,s=s.Lnext}while(s!==t)},killEdge_:function(e){e.Sym.side<e.side&&(e=e.Sym);var t=e.next,n=e.Sym.next;t.Sym.next=n,n.Sym.next=t},killVertex_:function(e,t){var n=e.anEdge,i=n;do{i.Org=t,i=i.Onext}while(i!==n);var r=e.prev,s=e.next;s.prev=r,r.next=s},killFace_:function(e,t){var n=e.anEdge,i=n;do{i.Lface=t,i=i.Lnext}while(i!==n);var r=e.prev,s=e.next;s.prev=r,r.next=s},makeEdge:function(){var e=new O,t=new O,n=new L,i=this.makeEdge_(this.eHead);return this.makeVertex_(e,i,this.vHead),this.makeVertex_(t,i.Sym,this.vHead),this.makeFace_(n,i,this.fHead),i},splice:function(e,t){var n=!1,i=!1;if(e!==t){if(t.Org!==e.Org&&(i=!0,this.killVertex_(t.Org,e.Org)),t.Lface!==e.Lface&&(n=!0,this.killFace_(t.Lface,e.Lface)),this.splice_(t,e),!i){var r=new O;this.makeVertex_(r,t,e.Org),e.Org.anEdge=e}if(!n){var s=new L;this.makeFace_(s,t,e.Lface),e.Lface.anEdge=e}}},delete:function(e){var t=e.Sym,n=!1;if(e.Lface!==e.Rface&&(n=!0,this.killFace_(e.Lface,e.Rface)),e.Onext===e)this.killVertex_(e.Org,null);else if(e.Rface.anEdge=e.Oprev,e.Org.anEdge=e.Onext,this.splice_(e,e.Oprev),!n){var i=new L;this.makeFace_(i,e,e.Lface)}t.Onext===t?(this.killVertex_(t.Org,null),this.killFace_(t.Lface,null)):(e.Lface.anEdge=t.Oprev,t.Org.anEdge=t.Onext,this.splice_(t,t.Oprev)),this.killEdge_(e)},addEdgeVertex:function(e){var t=this.makeEdge_(e),n=t.Sym;this.splice_(t,e.Lnext),t.Org=e.Dst;var i=new O;return this.makeVertex_(i,n,t.Org),t.Lface=n.Lface=e.Lface,t},splitEdge:function(e,t){var n=this.addEdgeVertex(e).Sym;return this.splice_(e.Sym,e.Sym.Oprev),this.splice_(e.Sym,n),e.Dst=n.Org,n.Dst.anEdge=n.Sym,n.Rface=e.Rface,n.winding=e.winding,n.Sym.winding=e.Sym.winding,n},connect:function(e,t){var n=!1,i=this.makeEdge_(e),r=i.Sym;if(t.Lface!==e.Lface&&(n=!0,this.killFace_(t.Lface,e.Lface)),this.splice_(i,e.Lnext),this.splice_(r,t),i.Org=e.Dst,r.Org=t.Org,i.Lface=r.Lface=e.Lface,e.Lface.anEdge=r,!n){var s=new L;this.makeFace_(s,i,e.Lface)}return i},zapFace:function(e){var t,n,i,r,s,o=e.anEdge;n=o.Lnext;do{n=(t=n).Lnext,t.Lface=null,null===t.Rface&&(t.Onext===t?this.killVertex_(t.Org,null):(t.Org.anEdge=t.Onext,this.splice_(t,t.Oprev)),(i=t.Sym).Onext===i?this.killVertex_(i.Org,null):(i.Org.anEdge=i.Onext,this.splice_(i,i.Oprev)),this.killEdge_(t))}while(t!=o);r=e.prev,(s=e.next).prev=r,r.next=s},countFaceVerts_:function(e){var t=e.anEdge,n=0;do{n++,t=t.Lnext}while(t!==e.anEdge);return n},mergeConvexFaces:function(e){var t,n,i,r,s;for(t=this.fHead.next;t!==this.fHead;t=t.next)if(t.inside)for(s=(n=t.anEdge).Org;i=n.Lnext,(r=n.Sym)&&r.Lface&&r.Lface.inside&&this.countFaceVerts_(t)+this.countFaceVerts_(r.Lface)-2<=e&&_.vertCCW(n.Lprev.Org,n.Org,r.Lnext.Lnext.Org)&&_.vertCCW(r.Lprev.Org,r.Org,n.Lnext.Lnext.Org)&&(i=r.Lnext,this.delete(r),n=null,r=null),!n||n.Lnext.Org!==s;)n=i;return!0},check:function(){var e,t,n,i,r,s,o=this.fHead,a=this.vHead,h=this.eHead;for(t=o,t=o;(e=t.next)!==o;t=e){v(e.prev===t),r=e.anEdge;do{v(r.Sym!==r),v(r.Sym.Sym===r),v(r.Lnext.Onext.Sym===r),v(r.Onext.Sym.Lnext===r),v(r.Lface===e),r=r.Lnext}while(r!==e.anEdge)}for(v(e.prev===t&&null===e.anEdge),i=a,i=a;(n=i.next)!==a;i=n){v(n.prev===i),r=n.anEdge;do{v(r.Sym!==r),v(r.Sym.Sym===r),v(r.Lnext.Onext.Sym===r),v(r.Onext.Sym.Lnext===r),v(r.Org===n),r=r.Onext}while(r!==n.anEdge)}for(v(n.prev===i&&null===n.anEdge),s=h,s=h;(r=s.next)!==h;s=r)v(r.Sym.next===s.Sym),v(r.Sym!==r),v(r.Sym.Sym===r),v(null!==r.Org),v(null!==r.Dst),v(r.Lnext.Onext.Sym===r),v(r.Onext.Sym.Lnext===r);v(r.Sym.next===s.Sym&&r.Sym===this.eHeadSym&&r.Sym.Sym===r&&null===r.Org&&null===r.Dst&&null===r.Lface&&null===r.Rface)}};var _={};function w(){this.key=null,this.next=null,this.prev=null}function b(e,t){this.head=new w,this.head.next=this.head,this.head.prev=this.head,this.frame=e,this.leq=t}function R(){this.handle=null}function D(){this.key=null,this.node=null}function U(e,t){this.size=0,this.max=e,this.nodes=[],this.nodes.length=e+1;for(var n=0;n<this.nodes.length;n++)this.nodes[n]=new R;this.handles=[],this.handles.length=e+1;for(n=0;n<this.handles.length;n++)this.handles[n]=new D;this.initialized=!1,this.freeList=0,this.leq=t,this.nodes[1].handle=1,this.handles[1].key=null}function A(){this.eUp=null,this.nodeUp=null,this.windingNumber=0,this.inside=!1,this.sentinel=!1,this.dirty=!1,this.fixUpperEdge=!1}_.vertEq=function(e,t){return e.s===t.s&&e.t===t.t},_.vertLeq=function(e,t){return e.s<t.s||e.s===t.s&&e.t<=t.t},_.transLeq=function(e,t){return e.t<t.t||e.t===t.t&&e.s<=t.s},_.edgeGoesLeft=function(e){return _.vertLeq(e.Dst,e.Org)},_.edgeGoesRight=function(e){return _.vertLeq(e.Org,e.Dst)},_.vertL1dist=function(e,t){return Math.abs(e.s-t.s)+Math.abs(e.t-t.t)},_.edgeEval=function(e,t,n){v(_.vertLeq(e,t)&&_.vertLeq(t,n));var i=t.s-e.s,r=n.s-t.s;return i+r>0?i<r?t.t-e.t+(e.t-n.t)*(i/(i+r)):t.t-n.t+(n.t-e.t)*(r/(i+r)):0},_.edgeSign=function(e,t,n){v(_.vertLeq(e,t)&&_.vertLeq(t,n));var i=t.s-e.s,r=n.s-t.s;return i+r>0?(t.t-n.t)*i+(t.t-e.t)*r:0},_.transEval=function(e,t,n){v(_.transLeq(e,t)&&_.transLeq(t,n));var i=t.t-e.t,r=n.t-t.t;return i+r>0?i<r?t.s-e.s+(e.s-n.s)*(i/(i+r)):t.s-n.s+(n.s-e.s)*(r/(i+r)):0},_.transSign=function(e,t,n){v(_.transLeq(e,t)&&_.transLeq(t,n));var i=t.t-e.t,r=n.t-t.t;return i+r>0?(t.s-n.s)*i+(t.s-e.s)*r:0},_.vertCCW=function(e,t,n){return e.s*(t.t-n.t)+t.s*(n.t-e.t)+n.s*(e.t-t.t)>=0},_.interpolate=function(e,t,n,i){return(e=e<0?0:e)<=(n=n<0?0:n)?0==n?(t+i)/2:t+e/(e+n)*(i-t):i+n/(e+n)*(t-i)},_.intersect=function(e,t,n,i,r){var s,o,a;_.vertLeq(e,t)||(a=e,e=t,t=a),_.vertLeq(n,i)||(a=n,n=i,i=a),_.vertLeq(e,n)||(a=e,e=n,n=a,a=t,t=i,i=a),_.vertLeq(n,t)?_.vertLeq(t,i)?((s=_.edgeEval(e,n,t))+(o=_.edgeEval(n,t,i))<0&&(s=-s,o=-o),r.s=_.interpolate(s,n.s,o,t.s)):((s=_.edgeSign(e,n,t))+(o=-_.edgeSign(e,i,t))<0&&(s=-s,o=-o),r.s=_.interpolate(s,n.s,o,i.s)):r.s=(n.s+t.s)/2,_.transLeq(e,t)||(a=e,e=t,t=a),_.transLeq(n,i)||(a=n,n=i,i=a),_.transLeq(e,n)||(a=e,e=n,n=a,a=t,t=i,i=a),_.transLeq(n,t)?_.transLeq(t,i)?((s=_.transEval(e,n,t))+(o=_.transEval(n,t,i))<0&&(s=-s,o=-o),r.t=_.interpolate(s,n.t,o,t.t)):((s=_.transSign(e,n,t))+(o=-_.transSign(e,i,t))<0&&(s=-s,o=-o),r.t=_.interpolate(s,n.t,o,i.t)):r.t=(n.t+t.t)/2},b.prototype={min:function(){return this.head.next},max:function(){return this.head.prev},insert:function(e){return this.insertBefore(this.head,e)},search:function(e){var t=this.head;do{t=t.next}while(null!==t.key&&!this.leq(this.frame,e,t.key));return t},insertBefore:function(e,t){do{e=e.prev}while(null!==e.key&&!this.leq(this.frame,e.key,t));var n=new w;return n.key=t,n.next=e.next,e.next.prev=n,n.prev=e,e.next=n,n},delete:function(e){e.next.prev=e.prev,e.prev.next=e.next}},U.prototype={floatDown_:function(e){var t,n,i,r=this.nodes,s=this.handles;for(t=r[e].handle;;){if((i=e<<1)<this.size&&this.leq(s[r[i+1].handle].key,s[r[i].handle].key)&&++i,v(i<=this.max),n=r[i].handle,i>this.size||this.leq(s[t].key,s[n].key)){r[e].handle=t,s[t].node=e;break}r[e].handle=n,s[n].node=e,e=i}},floatUp_:function(e){var t,n,i,r=this.nodes,s=this.handles;for(t=r[e].handle;;){if(n=r[i=e>>1].handle,0==i||this.leq(s[n].key,s[t].key)){r[e].handle=t,s[t].node=e;break}r[e].handle=n,s[n].node=e,e=i}},init:function(){for(var e=this.size;e>=1;--e)this.floatDown_(e);this.initialized=!0},min:function(){return this.handles[this.nodes[1].handle].key},isEmpty:function(){this.size},insert:function(e){var t,n;if(2*(t=++this.size)>this.max){var i;this.max*=2,i=this.nodes.length,this.nodes.length=this.max+1;for(var r=i;r<this.nodes.length;r++)this.nodes[r]=new R;i=this.handles.length,this.handles.length=this.max+1;for(r=i;r<this.handles.length;r++)this.handles[r]=new D}return 0===this.freeList?n=t:(n=this.freeList,this.freeList=this.handles[n].node),this.nodes[t].handle=n,this.handles[n].node=t,this.handles[n].key=e,this.initialized&&this.floatUp_(t),n},extractMin:function(){var e=this.nodes,t=this.handles,n=e[1].handle,i=t[n].key;return this.size>0&&(e[1].handle=e[this.size].handle,t[e[1].handle].node=1,t[n].key=null,t[n].node=this.freeList,this.freeList=n,--this.size,this.size>0&&this.floatDown_(1)),i},delete:function(e){var t,n=this.nodes,i=this.handles;v(e>=1&&e<=this.max&&null!==i[e].key),n[t=i[e].node].handle=n[this.size].handle,i[n[t].handle].node=t,--this.size,t<=this.size&&(t<=1||this.leq(i[n[t>>1].handle].key,i[n[t].handle].key)?this.floatDown_(t):this.floatUp_(t)),i[e].key=null,i[e].node=this.freeList,this.freeList=e}};var k={};function V(){this.mesh=null,this.normal=[0,0,0],this.sUnit=[0,0,0],this.tUnit=[0,0,0],this.bmin=[0,0],this.bmax=[0,0],this.windingRule=m.WINDING_ODD,this.dict=null,this.pq=null,this.event=null,this.vertexIndexCounter=0,this.vertices=[],this.vertexIndices=[],this.vertexCount=0,this.elements=[],this.elementCount=0}k.regionBelow=function(e){return e.nodeUp.prev.key},k.regionAbove=function(e){return e.nodeUp.next.key},k.debugEvent=function(e){},k.addWinding=function(e,t){e.winding+=t.winding,e.Sym.winding+=t.Sym.winding},k.edgeLeq=function(e,t,n){var i=e.event,r=t.eUp,s=n.eUp;return r.Dst===i?s.Dst===i?_.vertLeq(r.Org,s.Org)?_.edgeSign(s.Dst,r.Org,s.Org)<=0:_.edgeSign(r.Dst,s.Org,r.Org)>=0:_.edgeSign(s.Dst,i,s.Org)<=0:s.Dst===i?_.edgeSign(r.Dst,i,r.Org)>=0:_.edgeEval(r.Dst,i,r.Org)>=_.edgeEval(s.Dst,i,s.Org)},k.deleteRegion=function(e,t){t.fixUpperEdge&&v(0===t.eUp.winding),t.eUp.activeRegion=null,e.dict.delete(t.nodeUp)},k.fixUpperEdge=function(e,t,n){v(t.fixUpperEdge),e.mesh.delete(t.eUp),t.fixUpperEdge=!1,t.eUp=n,n.activeRegion=t},k.topLeftRegion=function(e,t){var n,i=t.eUp.Org;do{t=k.regionAbove(t)}while(t.eUp.Org===i);if(t.fixUpperEdge){if(null===(n=e.mesh.connect(k.regionBelow(t).eUp.Sym,t.eUp.Lnext)))return null;k.fixUpperEdge(e,t,n),t=k.regionAbove(t)}return t},k.topRightRegion=function(e){var t=e.eUp.Dst;do{e=k.regionAbove(e)}while(e.eUp.Dst===t);return e},k.addRegionBelow=function(e,t,n){var i=new A;return i.eUp=n,i.nodeUp=e.dict.insertBefore(t.nodeUp,i),i.fixUpperEdge=!1,i.sentinel=!1,i.dirty=!1,n.activeRegion=i,i},k.isWindingInside=function(e,t){switch(e.windingRule){case m.WINDING_ODD:return 0!=(1&t);case m.WINDING_NONZERO:return 0!=t;case m.WINDING_POSITIVE:return t>0;case m.WINDING_NEGATIVE:return t<0;case m.WINDING_ABS_GEQ_TWO:return t>=2||t<=-2}return v(!1),!1},k.computeWinding=function(e,t){t.windingNumber=k.regionAbove(t).windingNumber+t.eUp.winding,t.inside=k.isWindingInside(e,t.windingNumber)},k.finishRegion=function(e,t){var n=t.eUp,i=n.Lface;i.inside=t.inside,i.anEdge=n,k.deleteRegion(e,t)},k.finishLeftRegions=function(e,t,n){for(var i,r=null,s=t,o=t.eUp;s!==n;){if(s.fixUpperEdge=!1,(i=(r=k.regionBelow(s)).eUp).Org!=o.Org){if(!r.fixUpperEdge){k.finishRegion(e,s);break}i=e.mesh.connect(o.Lprev,i.Sym),k.fixUpperEdge(e,r,i)}o.Onext!==i&&(e.mesh.splice(i.Oprev,i),e.mesh.splice(o,i)),k.finishRegion(e,s),o=r.eUp,s=r}return o},k.addRightEdges=function(e,t,n,i,r,s){var o,a,h,l,d=!0;h=n;do{v(_.vertLeq(h.Org,h.Dst)),k.addRegionBelow(e,t,h.Sym),h=h.Onext}while(h!==i);for(null===r&&(r=k.regionBelow(t).eUp.Rprev),a=t,l=r;(h=(o=k.regionBelow(a)).eUp.Sym).Org===l.Org;)h.Onext!==l&&(e.mesh.splice(h.Oprev,h),e.mesh.splice(l.Oprev,h)),o.windingNumber=a.windingNumber-h.winding,o.inside=k.isWindingInside(e,o.windingNumber),a.dirty=!0,!d&&k.checkForRightSplice(e,a)&&(k.addWinding(h,l),k.deleteRegion(e,a),e.mesh.delete(l)),d=!1,a=o,l=h;a.dirty=!0,v(a.windingNumber-h.winding===o.windingNumber),s&&k.walkDirtyRegions(e,a)},k.spliceMergeVertices=function(e,t,n){e.mesh.splice(t,n)},k.vertexWeights=function(e,t,n){var i=_.vertL1dist(t,e),r=_.vertL1dist(n,e),s=.5*r/(i+r),o=.5*i/(i+r);e.coords[0]+=s*t.coords[0]+o*n.coords[0],e.coords[1]+=s*t.coords[1]+o*n.coords[1],e.coords[2]+=s*t.coords[2]+o*n.coords[2]},k.getIntersectData=function(e,t,n,i,r,s){t.coords[0]=t.coords[1]=t.coords[2]=0,t.idx=-1,k.vertexWeights(t,n,i),k.vertexWeights(t,r,s)},k.checkForRightSplice=function(e,t){var n=k.regionBelow(t),i=t.eUp,r=n.eUp;if(_.vertLeq(i.Org,r.Org)){if(_.edgeSign(r.Dst,i.Org,r.Org)>0)return!1;_.vertEq(i.Org,r.Org)?i.Org!==r.Org&&(e.pq.delete(i.Org.pqHandle),k.spliceMergeVertices(e,r.Oprev,i)):(e.mesh.splitEdge(r.Sym),e.mesh.splice(i,r.Oprev),t.dirty=n.dirty=!0)}else{if(_.edgeSign(i.Dst,r.Org,i.Org)<0)return!1;k.regionAbove(t).dirty=t.dirty=!0,e.mesh.splitEdge(i.Sym),e.mesh.splice(r.Oprev,i)}return!0},k.checkForLeftSplice=function(e,t){var n,i=k.regionBelow(t),r=t.eUp,s=i.eUp;if(v(!_.vertEq(r.Dst,s.Dst)),_.vertLeq(r.Dst,s.Dst)){if(_.edgeSign(r.Dst,s.Dst,r.Org)<0)return!1;k.regionAbove(t).dirty=t.dirty=!0,n=e.mesh.splitEdge(r),e.mesh.splice(s.Sym,n),n.Lface.inside=t.inside}else{if(_.edgeSign(s.Dst,r.Dst,s.Org)>0)return!1;t.dirty=i.dirty=!0,n=e.mesh.splitEdge(s),e.mesh.splice(r.Lnext,s.Sym),n.Rface.inside=t.inside}return!0},k.checkForIntersect=function(e,t){var n,i,r=k.regionBelow(t),s=t.eUp,o=r.eUp,a=s.Org,h=o.Org,l=s.Dst,d=o.Dst,u=new O;if(v(!_.vertEq(d,l)),v(_.edgeSign(l,e.event,a)<=0),v(_.edgeSign(d,e.event,h)>=0),v(a!==e.event&&h!==e.event),v(!t.fixUpperEdge&&!r.fixUpperEdge),a===h)return!1;if(Math.min(a.t,l.t)>Math.max(h.t,d.t))return!1;if(_.vertLeq(a,h)){if(_.edgeSign(d,a,h)>0)return!1}else if(_.edgeSign(l,h,a)<0)return!1;return k.debugEvent(e),_.intersect(l,a,d,h,u),v(Math.min(a.t,l.t)<=u.t),v(u.t<=Math.max(h.t,d.t)),v(Math.min(d.s,l.s)<=u.s),v(u.s<=Math.max(h.s,a.s)),_.vertLeq(u,e.event)&&(u.s=e.event.s,u.t=e.event.t),n=_.vertLeq(a,h)?a:h,_.vertLeq(n,u)&&(u.s=n.s,u.t=n.t),_.vertEq(u,a)||_.vertEq(u,h)?(k.checkForRightSplice(e,t),!1):!_.vertEq(l,e.event)&&_.edgeSign(l,e.event,u)>=0||!_.vertEq(d,e.event)&&_.edgeSign(d,e.event,u)<=0?d===e.event?(e.mesh.splitEdge(s.Sym),e.mesh.splice(o.Sym,s),t=k.topLeftRegion(e,t),s=k.regionBelow(t).eUp,k.finishLeftRegions(e,k.regionBelow(t),r),k.addRightEdges(e,t,s.Oprev,s,s,!0),!0):l===e.event?(e.mesh.splitEdge(o.Sym),e.mesh.splice(s.Lnext,o.Oprev),r=t,t=k.topRightRegion(t),i=k.regionBelow(t).eUp.Rprev,r.eUp=o.Oprev,o=k.finishLeftRegions(e,r,null),k.addRightEdges(e,t,o.Onext,s.Rprev,i,!0),!0):(_.edgeSign(l,e.event,u)>=0&&(k.regionAbove(t).dirty=t.dirty=!0,e.mesh.splitEdge(s.Sym),s.Org.s=e.event.s,s.Org.t=e.event.t),_.edgeSign(d,e.event,u)<=0&&(t.dirty=r.dirty=!0,e.mesh.splitEdge(o.Sym),o.Org.s=e.event.s,o.Org.t=e.event.t),!1):(e.mesh.splitEdge(s.Sym),e.mesh.splitEdge(o.Sym),e.mesh.splice(o.Oprev,s),s.Org.s=u.s,s.Org.t=u.t,s.Org.pqHandle=e.pq.insert(s.Org),k.getIntersectData(e,s.Org,a,l,h,d),k.regionAbove(t).dirty=t.dirty=r.dirty=!0,!1)},k.walkDirtyRegions=function(e,t){for(var n,i,r=k.regionBelow(t);;){for(;r.dirty;)t=r,r=k.regionBelow(r);if(!t.dirty&&(r=t,null==(t=k.regionAbove(t))||!t.dirty))return;if(t.dirty=!1,n=t.eUp,i=r.eUp,n.Dst!==i.Dst&&k.checkForLeftSplice(e,t)&&(r.fixUpperEdge?(k.deleteRegion(e,r),e.mesh.delete(i),i=(r=k.regionBelow(t)).eUp):t.fixUpperEdge&&(k.deleteRegion(e,t),e.mesh.delete(n),n=(t=k.regionAbove(r)).eUp)),n.Org!==i.Org)if(n.Dst===i.Dst||t.fixUpperEdge||r.fixUpperEdge||n.Dst!==e.event&&i.Dst!==e.event)k.checkForRightSplice(e,t);else if(k.checkForIntersect(e,t))return;n.Org===i.Org&&n.Dst===i.Dst&&(k.addWinding(i,n),k.deleteRegion(e,t),e.mesh.delete(n),t=k.regionAbove(r))}},k.connectRightVertex=function(e,t,n){var i,r=n.Onext,s=k.regionBelow(t),o=t.eUp,a=s.eUp,h=!1;o.Dst!==a.Dst&&k.checkForIntersect(e,t),_.vertEq(o.Org,e.event)&&(e.mesh.splice(r.Oprev,o),t=k.topLeftRegion(e,t),r=k.regionBelow(t).eUp,k.finishLeftRegions(e,k.regionBelow(t),s),h=!0),_.vertEq(a.Org,e.event)&&(e.mesh.splice(n,a.Oprev),n=k.finishLeftRegions(e,s,null),h=!0),h?k.addRightEdges(e,t,n.Onext,r,r,!0):(i=_.vertLeq(a.Org,o.Org)?a.Oprev:o,i=e.mesh.connect(n.Lprev,i),k.addRightEdges(e,t,i,i.Onext,i.Onext,!1),i.Sym.activeRegion.fixUpperEdge=!0,k.walkDirtyRegions(e,t))},k.connectLeftDegenerate=function(e,t,n){var i,r,s,o,a;return i=t.eUp,_.vertEq(i.Org,n)?(v(!1),void k.spliceMergeVertices(e,i,n.anEdge)):_.vertEq(i.Dst,n)?(v(!1),t=k.topRightRegion(t),r=o=(s=(a=k.regionBelow(t)).eUp.Sym).Onext,a.fixUpperEdge&&(v(r!==s),k.deleteRegion(e,a),e.mesh.delete(s),s=r.Oprev),e.mesh.splice(n.anEdge,s),_.edgeGoesLeft(r)||(r=null),void k.addRightEdges(e,t,s.Onext,o,r,!0)):(e.mesh.splitEdge(i.Sym),t.fixUpperEdge&&(e.mesh.delete(i.Onext),t.fixUpperEdge=!1),e.mesh.splice(n.anEdge,i),void k.sweepEvent(e,n))},k.connectLeftVertex=function(e,t){var n,i,r,s,o,a,h=new A;if(h.eUp=t.anEdge.Sym,n=e.dict.search(h).key,i=k.regionBelow(n))if(s=n.eUp,o=i.eUp,0!==_.edgeSign(s.Dst,t,s.Org))if(r=_.vertLeq(o.Dst,s.Dst)?n:i,n.inside||r.fixUpperEdge){if(r===n)a=e.mesh.connect(t.anEdge.Sym,s.Lnext);else a=e.mesh.connect(o.Dnext,t.anEdge).Sym;r.fixUpperEdge?k.fixUpperEdge(e,r,a):k.computeWinding(e,k.addRegionBelow(e,n,a)),k.sweepEvent(e,t)}else k.addRightEdges(e,n,t.anEdge,t.anEdge,null,!0);else k.connectLeftDegenerate(e,n,t)},k.sweepEvent=function(e,t){e.event=t,k.debugEvent(e);for(var n=t.anEdge;null===n.activeRegion;)if((n=n.Onext)==t.anEdge)return void k.connectLeftVertex(e,t);var i=k.topLeftRegion(e,n.activeRegion);v(null!==i);var r=k.regionBelow(i),s=r.eUp,o=k.finishLeftRegions(e,r,null);o.Onext===s?k.connectRightVertex(e,i,o):k.addRightEdges(e,i,o.Onext,s,s,!0)},k.addSentinel=function(e,t,n,i){var r=new A,s=e.mesh.makeEdge();s.Org.s=n,s.Org.t=i,s.Dst.s=t,s.Dst.t=i,e.event=s.Dst,r.eUp=s,r.windingNumber=0,r.inside=!1,r.fixUpperEdge=!1,r.sentinel=!0,r.dirty=!1,r.nodeUp=e.dict.insert(r)},k.initEdgeDict=function(e){e.dict=new b(e,k.edgeLeq);var t=e.bmax[0]-e.bmin[0],n=e.bmax[1]-e.bmin[1],i=e.bmin[0]-t,r=e.bmax[0]+t,s=e.bmin[1]-n,o=e.bmax[1]+n;k.addSentinel(e,i,r,s),k.addSentinel(e,i,r,o)},k.doneEdgeDict=function(e){for(var t,n=0;null!==(t=e.dict.min().key);)t.sentinel||(v(t.fixUpperEdge),v(1==++n)),v(0==t.windingNumber),k.deleteRegion(e,t)},k.removeDegenerateEdges=function(e){var t,n,i,r=e.mesh.eHead;for(t=r.next;t!==r;t=n)n=t.next,i=t.Lnext,_.vertEq(t.Org,t.Dst)&&t.Lnext.Lnext!==t&&(k.spliceMergeVertices(e,i,t),e.mesh.delete(t),i=(t=i).Lnext),i.Lnext===t&&(i!==t&&(i!==n&&i!==n.Sym||(n=n.next),e.mesh.delete(i)),t!==n&&t!==n.Sym||(n=n.next),e.mesh.delete(t))},k.initPriorityQ=function(e){var t,n,i,r=0;for(n=(i=e.mesh.vHead).next;n!==i;n=n.next)r++;for(r+=8,t=e.pq=new U(r,_.vertLeq),n=(i=e.mesh.vHead).next;n!==i;n=n.next)n.pqHandle=t.insert(n);return n===i&&(t.init(),!0)},k.donePriorityQ=function(e){e.pq=null},k.removeDegenerateFaces=function(e,t){var n,i,r;for(n=t.fHead.next;n!==t.fHead;n=i)i=n.next,r=n.anEdge,v(r.Lnext!==r),r.Lnext.Lnext===r&&(k.addWinding(r.Onext,r),e.mesh.delete(r));return!0},k.computeInterior=function(e){var t,n;if(k.removeDegenerateEdges(e),!k.initPriorityQ(e))return!1;for(k.initEdgeDict(e);null!==(t=e.pq.extractMin());){for(;null!==(n=e.pq.min())&&_.vertEq(n,t);)n=e.pq.extractMin(),k.spliceMergeVertices(e,t.anEdge,n.anEdge);k.sweepEvent(e,t)}return e.event=e.dict.min().key.eUp.Org,k.debugEvent(e),k.doneEdgeDict(e),k.donePriorityQ(e),!!k.removeDegenerateFaces(e,e.mesh)&&(e.mesh.check(),!0)},V.prototype={dot_:function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},normalize_:function(e){var t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2];v(t>0),t=Math.sqrt(t),e[0]/=t,e[1]/=t,e[2]/=t},longAxis_:function(e){var t=0;return Math.abs(e[1])>Math.abs(e[0])&&(t=1),Math.abs(e[2])>Math.abs(e[t])&&(t=2),t},computeNormal_:function(e){var t,n,i,r,s,o,a,h=[0,0,0],l=[0,0,0],d=[0,0,0],u=[0,0,0],c=[0,0,0],f=[null,null,null],g=[null,null,null],p=this.mesh.vHead;for(t=p.next,a=0;a<3;++a)r=t.coords[a],l[a]=r,g[a]=t,h[a]=r,f[a]=t;for(t=p.next;t!==p;t=t.next)for(a=0;a<3;++a)(r=t.coords[a])<l[a]&&(l[a]=r,g[a]=t),r>h[a]&&(h[a]=r,f[a]=t);if(a=0,h[1]-l[1]>h[0]-l[0]&&(a=1),h[2]-l[2]>h[a]-l[a]&&(a=2),l[a]>=h[a])return e[0]=0,e[1]=0,void(e[2]=1);for(o=0,n=g[a],i=f[a],d[0]=n.coords[0]-i.coords[0],d[1]=n.coords[1]-i.coords[1],d[2]=n.coords[2]-i.coords[2],t=p.next;t!==p;t=t.next)u[0]=t.coords[0]-i.coords[0],u[1]=t.coords[1]-i.coords[1],u[2]=t.coords[2]-i.coords[2],c[0]=d[1]*u[2]-d[2]*u[1],c[1]=d[2]*u[0]-d[0]*u[2],c[2]=d[0]*u[1]-d[1]*u[0],(s=c[0]*c[0]+c[1]*c[1]+c[2]*c[2])>o&&(o=s,e[0]=c[0],e[1]=c[1],e[2]=c[2]);o<=0&&(e[0]=e[1]=e[2]=0,e[this.longAxis_(d)]=1)},checkOrientation_:function(){var e,t,n,i,r=this.mesh.fHead,s=this.mesh.vHead;for(e=0,t=r.next;t!==r;t=t.next)if(!((i=t.anEdge).winding<=0))do{e+=(i.Org.s-i.Dst.s)*(i.Org.t+i.Dst.t),i=i.Lnext}while(i!==t.anEdge);if(e<0){for(n=s.next;n!==s;n=n.next)n.t=-n.t;this.tUnit[0]=-this.tUnit[0],this.tUnit[1]=-this.tUnit[1],this.tUnit[2]=-this.tUnit[2]}},projectPolygon_:function(){var e,t,n,i,r,s=this.mesh.vHead,o=[0,0,0],a=!1;for(o[0]=this.normal[0],o[1]=this.normal[1],o[2]=this.normal[2],0===o[0]&&0===o[1]&&0===o[2]&&(this.computeNormal_(o),a=!0),t=this.sUnit,n=this.tUnit,t[i=this.longAxis_(o)]=0,t[(i+1)%3]=1,t[(i+2)%3]=0,n[i]=0,n[(i+1)%3]=0,n[(i+2)%3]=o[i]>0?1:-1,e=s.next;e!==s;e=e.next)e.s=this.dot_(e.coords,t),e.t=this.dot_(e.coords,n);for(a&&this.checkOrientation_(),r=!0,e=s.next;e!==s;e=e.next)r?(this.bmin[0]=this.bmax[0]=e.s,this.bmin[1]=this.bmax[1]=e.t,r=!1):(e.s<this.bmin[0]&&(this.bmin[0]=e.s),e.s>this.bmax[0]&&(this.bmax[0]=e.s),e.t<this.bmin[1]&&(this.bmin[1]=e.t),e.t>this.bmax[1]&&(this.bmax[1]=e.t))},addWinding_:function(e,t){e.winding+=t.winding,e.Sym.winding+=t.Sym.winding},tessellateMonoRegion_:function(e,t){var n,i;for(n=t.anEdge,v(n.Lnext!==n&&n.Lnext.Lnext!==n);_.vertLeq(n.Dst,n.Org);n=n.Lprev);for(;_.vertLeq(n.Org,n.Dst);n=n.Lnext);for(i=n.Lprev;n.Lnext!==i;)if(_.vertLeq(n.Dst,i.Org)){for(;i.Lnext!==n&&(_.edgeGoesLeft(i.Lnext)||_.edgeSign(i.Org,i.Dst,i.Lnext.Dst)<=0);){i=e.connect(i.Lnext,i).Sym}i=i.Lprev}else{for(;i.Lnext!=n&&(_.edgeGoesRight(n.Lprev)||_.edgeSign(n.Dst,n.Org,n.Lprev.Org)>=0);){n=e.connect(n,n.Lprev).Sym}n=n.Lnext}for(v(i.Lnext!==n);i.Lnext.Lnext!==n;){i=e.connect(i.Lnext,i).Sym}return!0},tessellateInterior_:function(e){var t,n;for(t=e.fHead.next;t!==e.fHead;t=n)if(n=t.next,t.inside&&!this.tessellateMonoRegion_(e,t))return!1;return!0},discardExterior_:function(e){var t,n;for(t=e.fHead.next;t!==e.fHead;t=n)n=t.next,t.inside||e.zapFace(t)},setWindingNumber_:function(e,t,n){var i,r;for(i=e.eHead.next;i!==e.eHead;i=r)r=i.next,i.Rface.inside!==i.Lface.inside?i.winding=i.Lface.inside?t:-t:n?e.delete(i):i.winding=0},getNeighbourFace_:function(e){return e.Rface&&e.Rface.inside?e.Rface.n:-1},outputPolymesh_:function(e,t,n,i){var r,s,o,a,h,l=0,d=0;for(n>3&&e.mergeConvexFaces(n),r=e.vHead.next;r!==e.vHead;r=r.next)r.n=-1;for(s=e.fHead.next;s!=e.fHead;s=s.next)if(s.n=-1,s.inside){o=s.anEdge,a=0;do{-1===(r=o.Org).n&&(r.n=d,d++),a++,o=o.Lnext}while(o!==s.anEdge);v(a<=n),s.n=l,++l}for(this.elementCount=l,t==m.CONNECTED_POLYGONS&&(l*=2),this.elements=[],this.elements.length=l*n,this.vertexCount=d,this.vertices=[],this.vertices.length=d*i,this.vertexIndices=[],this.vertexIndices.length=d,r=e.vHead.next;r!==e.vHead;r=r.next)if(-1!=r.n){var u=r.n*i;this.vertices[u+0]=r.coords[0],this.vertices[u+1]=r.coords[1],i>2&&(this.vertices[u+2]=r.coords[2]),this.vertexIndices[r.n]=r.idx}var c=0;for(s=e.fHead.next;s!==e.fHead;s=s.next)if(s.inside){o=s.anEdge,a=0;do{r=o.Org,this.elements[c++]=r.n,a++,o=o.Lnext}while(o!==s.anEdge);for(h=a;h<n;++h)this.elements[c++]=-1;if(t==m.CONNECTED_POLYGONS){o=s.anEdge;do{this.elements[c++]=this.getNeighbourFace_(o),o=o.Lnext}while(o!==s.anEdge);for(h=a;h<n;++h)this.elements[c++]=-1}}},outputContours_:function(e,t){var n,i,r,s=0,o=0;for(this.vertexCount=0,this.elementCount=0,n=e.fHead.next;n!==e.fHead;n=n.next)if(n.inside){r=i=n.anEdge;do{this.vertexCount++,i=i.Lnext}while(i!==r);this.elementCount++}this.elements=[],this.elements.length=2*this.elementCount,this.vertices=[],this.vertices.length=this.vertexCount*t,this.vertexIndices=[],this.vertexIndices.length=this.vertexCount;var a=0,h=0,l=0;for(s=0,n=e.fHead.next;n!==e.fHead;n=n.next)if(n.inside){o=0,r=i=n.anEdge;do{this.vertices[a++]=i.Org.coords[0],this.vertices[a++]=i.Org.coords[1],t>2&&(this.vertices[a++]=i.Org.coords[2]),this.vertexIndices[h++]=i.Org.idx,o++,i=i.Lnext}while(i!==r);this.elements[l++]=s,this.elements[l++]=o,s+=o}},addContour:function(e,t){var n,i;for(null===this.mesh&&(this.mesh=new S),e<2&&(e=2),e>3&&(e=3),n=null,i=0;i<t.length;i+=e)null==n?(n=this.mesh.makeEdge(),this.mesh.splice(n,n.Sym)):(this.mesh.splitEdge(n),n=n.Lnext),n.Org.coords[0]=t[i+0],n.Org.coords[1]=t[i+1],n.Org.coords[2]=e>2?t[i+2]:0,n.Org.idx=this.vertexIndexCounter++,n.winding=1,n.Sym.winding=-1},tesselate:function(e,t,n,i,r){if(this.vertices=[],this.elements=[],this.vertexIndices=[],this.vertexIndexCounter=0,r&&(this.normal[0]=r[0],this.normal[1]=r[1],this.normal[2]=r[2]),this.windingRule=e,i<2&&(i=2),i>3&&(i=3),!this.mesh)return!1;this.projectPolygon_(),k.computeInterior(this);var s=this.mesh;return t==m.BOUNDARY_CONTOURS?this.setWindingNumber_(s,1,!0):this.tessellateInterior_(s),s.check(),t==m.BOUNDARY_CONTOURS?this.outputContours_(s,i):this.outputPolymesh_(s,t,n,i),!0}};const q={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class N{constructor(e,t,n){this.arrayBuffer=e.arrayBuffer,this.length=e.length,this.attributes=t.members,this.itemSize=t.bytesPerElement,this.type=n,this.arrayType=t}static fromStructArray(e,t){return new N(e.serialize(),e.constructor.serialize(),t)}updateData(e,t){this.bind(e),e.bufferSubData(e.ARRAY_BUFFER,0,t.arrayBuffer)}bind(e){const t=e[this.type];this.buffer?e.bindBuffer(t,this.buffer):(this.gl=e,this.buffer=e.createBuffer(),e.bindBuffer(t,this.buffer),e.bufferData(t,this.arrayBuffer,e.STATIC_DRAW),this.arrayBuffer=null)}enableAttributes(e,t){for(let n=0;n<this.attributes.length;n++){const i=t[this.attributes[n].name];void 0!==i&&e.enableVertexAttribArray(i)}}setVertexAttribPointers(e,t,n){for(let i=0;i<this.attributes.length;i++){const r=this.attributes[i],s=t[r.name];void 0!==s&&e.vertexAttribPointer(s,r.components,e[q[r.type]],!1,this.arrayType.bytesPerElement,r.offset+(this.arrayType.bytesPerElement*n||0))}}destroy(){this.buffer&&this.gl.deleteBuffer(this.buffer)}}N.BufferType={VERTEX:"ARRAY_BUFFER",ELEMENT:"ELEMENT_ARRAY_BUFFER"};const B={Int8:Int8Array,Uint8:Uint8Array,Uint8Clamped:Uint8ClampedArray,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array,Float64:Float64Array};const C={};function I(e,t,n,i){const r=JSON.stringify(e);if(C[r])return C[r];i=void 0===e.alignment?1:e.alignment;let s=0,o=0;const a=["Uint8"],h=e.members.map((e=>{a.indexOf(e.type)<0&&a.push(e.type);const t=F(e.type),n=s=M(s,Math.max(i,t)),r=e.components||1;return o=Math.max(o,t),s+=t*r,{name:e.name,type:e.type,components:r,offset:n}})),l=M(s,Math.max(o,i));class d extends class{constructor(e,t){this._structArray=e,this._pos1=t*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}{}d.prototype.alignment=i,d.prototype.size=l;for(const e of h)for(let t=0;t<e.components;t++){const n=e.name+(1===e.components?"":t);Object.defineProperty(d.prototype,n,{get:H(e,t),set:W(e,t)})}class u extends class{constructor(e,t){this.isTransferred=!1,void 0!==e?(this.arrayBuffer=e.arrayBuffer,this.length=e.length,this.capacity=this.arrayBuffer.byteLength/this.bytesPerElement,this._refreshViews()):(this.capacity=-1,this.resize(0))}static serialize(){return{members:this.prototype.members,alignment:this.prototype.StructType.prototype.alignment,bytesPerElement:this.prototype.bytesPerElement}}serialize(e){return this._trim(),e&&(this.isTransferred=!0,e.push(this.arrayBuffer)),{length:this.length,arrayBuffer:this.arrayBuffer}}get(e){return new this.StructType(this,e)}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}resize(e){if(this.length=e,e>this.capacity){this.capacity=Math.max(e,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const t=this.uint8;this._refreshViews(),t&&this.uint8.set(t)}}_refreshViews(){for(const e of this._usedTypes)this[z(e)]=new B[e](this.arrayBuffer)}toArray(e,t){const n=[];for(let i=e;i<t;i++){const e=this.get(i);n.push(e)}return n}}{}return u.prototype.members=h,u.prototype.StructType=d,u.prototype.bytesPerElement=l,u.prototype.emplaceBack=function(e,t){const n=[],i=[];let r="var i = this.length;\nthis.resize(this.length + 1);\n";for(const s of e){const e=F(s.type);n.indexOf(e)<0&&(n.push(e),r+=`var o${e.toFixed(0)} = i * ${(t/e).toFixed(0)};\n`);for(let t=0;t<s.components;t++){const n=`v${i.length}`,o=`o${e.toFixed(0)} + ${(s.offset/e+t).toFixed(0)}`;r+=`this.${z(s.type)}[${o}] = ${n};\n`,i.push(n)}}return r+="return i;",new Function(i.toString(),r)}(h,l),u.prototype._usedTypes=a,C[r]=u,u}function M(e,t){return Math.ceil(e/t)*t}function F(e){return B[e].BYTES_PER_ELEMENT}function z(e){return e.toLowerCase()}function T(e,t){const n=`${`this._pos${F(e.type).toFixed(0)}`} + ${(e.offset/F(e.type)+t).toFixed(0)}`;return`this._structArray.${z(e.type)}[${n}]`}function H(e,t){return new Function(`return ${T(e,t)};`)}function W(e,t){return new Function("x",`${T(e,t)} = x;`)}function G(e){return I({members:[{type:"Uint16",name:"vertices",components:e||3}]})}function P(e){return I({members:e,alignment:4})}const Y=P([{name:"a_pos",components:2,type:"Float32"}]),$=G(3),X=G(2);class Q extends u{constructor(e){super(e),this.overscaling=e.overscaling,this.layoutVertexArray=new Y,this.layoutVertexArray2=new Y,this.indexArray=new $,this.indexArray2=new X,this.segments=new d,this.segments2=new d}isEmpty(){return 0===this.layoutVertexArray.length}destroy(){this.segments.destroy(),this.segments2.destroy()}addFeature(e){for(const n of function(e,t){const n=e.length;if(n<=0)return[];const i=[];let r=[];for(let t=0;t<n;t++){const n=x(e[t]);0!==n&&(e[t].area=Math.abs(n),r.push(e[t]))}if(r&&i.push(r),t>1)for(let e=0;e<i.length;e++)i[e].length<=t||(c(i[e],t,1,i[e].length-1,y),i[e]=i[e].slice(0,t));return i}(e,1500)){let e=0,i=[];for(const e of n){const t=[];if(0===e.length)continue;n[0];const r=this.segments2.prepareSegment(e.length,this.layoutVertexArray2,this.indexArray2),s=r.vertexLength;this.layoutVertexArray2.emplaceBack(e[0].x,e[0].y),this.indexArray2.emplaceBack(s+e.length-1,s),t.push(e[0].x),t.push(e[0].y);for(let n=1;n<e.length;n++)this.layoutVertexArray2.emplaceBack(e[n].x,e[n].y),this.indexArray2.emplaceBack(s+n-1,s+n),t.push(e[n].x),t.push(e[n].y);r.vertexLength+=e.length,r.primitiveLength+=e.length,i.push(t)}var t=m.tesselate({contours:i,windingRule:m.WINDING_ODD,elementType:m.POLYGONS,polySize:3,vertexSize:2});e=t.vertices.length/2;const r=this.segments.prepareSegment(e,this.layoutVertexArray,this.indexArray),s=r.vertexLength;for(let e=0;e<t.vertices.length;e+=2)this.layoutVertexArray.emplaceBack(t.vertices[e],t.vertices[e+1]);const o=t.elements;for(let e=0;e<o.length;e+=3)this.indexArray.emplaceBack(s+o[e],s+o[e+1],s+o[e+2]);r.vertexLength+=e,r.primitiveLength+=o.length/3}}serialize(e){return{type:this.type,style:this.style,tileSize:this.tileSize,layoutVertexArray:this.layoutVertexArray.serialize(e),layoutVertexArray2:this.layoutVertexArray2.serialize(e),indexArray:this.indexArray.serialize(e),indexArray2:this.indexArray2.serialize(e),segments:this.segments,segments2:this.segments2}}static createBuffer(e){e.layoutVertexBuffer=new N(e.layoutVertexArray,Y.serialize(),N.BufferType.VERTEX),e.layoutVertexBuffer2=new N(e.layoutVertexArray2,Y.serialize(),N.BufferType.VERTEX),e.indexBuffer=new N(e.indexArray,$.serialize(),N.BufferType.ELEMENT),e.indexBuffer2=new N(e.indexArray2,X.serialize(),N.BufferType.ELEMENT)}}const J=P([{name:"a_pos",components:2,type:"Float32"},{name:"a_data",components:4,type:"Uint8"},{name:"a_txy",components:2,type:"Int16"}]),j=G(3),K=Math.cos(Math.PI/180*37.5),Z=Math.pow(2,14)/.5;function ee(e,t,n,i,r,s,o){e.emplaceBack(t.x,t.y,Math.round(63*n.x)+128,Math.round(63*n.y)+128,1+(0===s?0:s<0?-1:1)|(.5*o&63)<<2,.5*o>>6,i,r)}class te extends u{constructor(e){super(e),this.overscaling=this.tileSize/512,this.layoutVertexArray=new J,this.indexArray=new j,this.segments=new d}upload(e){this.uploaded=!0}destroy(){this.segments.destroy()}addFeature(e){const t=this.style.lineCap?this.style.lineCap:"butt";for(const n of e)this.addLine(n,e,"round",t,0,0)}addLine(e,t,n,i,r,s){let o=e.length;for(;o>=2&&e[o-1].equals(e[o-2]);)o--;let a=0;for(;a<o-1&&e[a].equals(e[a+1]);)a++;if(o<2)return;"bevel"===n&&(r=1.05);const h=8192/(512*this.overscaling)*15,l=(e[a],this.segments.prepareSegment(10*o,this.layoutVertexArray,this.indexArray));this.distance=0;const d=i,u=i;let c,f,g,p,x,y,m,v=!0;this.e1=this.e2=this.e3=-1;for(let t=a;t<o;t++){if(g=e[t+1],g&&e[t].equals(g))continue;x&&(p=x),c&&(f=c),c=e[t],x=g?g.sub(c)._unit()._perp():p,p=p||x;let i=p.add(x);0===i.x&&0===i.y||i._unit();const O=i.x*x.x+i.y*x.y,L=0!==O?1/O:1/0,E=O<K&&f&&g;if(E&&t>a){const e=c.dist(f);if(e>2*h){const t=c.sub(c.sub(f)._mult(h/e)._round());this.distance+=t.dist(f),this.addCurrentVertex(t,this.distance,p.mult(1),0,0,!1,l),f=t}}const S=f&&g;let _=S?n:g?d:u;if(S&&"round"===_&&(L<s?_="miter":L<=2&&(_="fakeround")),"miter"===_&&L>r&&(_="bevel"),"bevel"===_&&(L>2&&(_="flipbevel"),L<r&&(_="miter")),f&&(this.distance+=c.dist(f)),"miter"===_)i._mult(L),this.addCurrentVertex(c,this.distance,i,0,0,!1,l);else if("flipbevel"===_){if(L>100)i=x.clone().mult(-1);else{const e=p.x*x.y-p.y*x.x>0?-1:1,t=L*p.add(x).mag()/p.sub(x).mag();i._perp()._mult(t*e)}this.addCurrentVertex(c,this.distance,i,0,0,!1,l),this.addCurrentVertex(c,this.distance,i.mult(-1),0,0,!1,l)}else if("bevel"===_||"fakeround"===_){const e=p.x*x.y-p.y*x.x>0,t=-Math.sqrt(L*L-1);if(e?(m=0,y=t):(y=0,m=t),v||this.addCurrentVertex(c,this.distance,p,y,m,!1,l),"fakeround"===_){const t=Math.floor(8*(.5-(O-.5)));let n;for(let i=0;i<t;i++)n=x.mult((i+1)/(t+1))._add(p)._unit(),this.addPieSliceVertex(c,this.distance,n,e,l);this.addPieSliceVertex(c,this.distance,i,e,l);for(let i=t-1;i>=0;i--)n=p.mult((i+1)/(t+1))._add(x)._unit(),this.addPieSliceVertex(c,this.distance,n,e,l)}g&&this.addCurrentVertex(c,this.distance,x,-y,-m,!1,l)}else"butt"===_?(v||this.addCurrentVertex(c,this.distance,p,0,0,!1,l),g&&this.addCurrentVertex(c,this.distance,x,0,0,!1,l)):"square"===_?(v||(this.addCurrentVertex(c,this.distance,p,1,1,!1,l),this.e1=this.e2=-1),g&&this.addCurrentVertex(c,this.distance,x,-1,-1,!1,l)):"round"===_&&(v||(this.addCurrentVertex(c,this.distance,p,0,0,!1,l),this.addCurrentVertex(c,this.distance,p,1,1,!0,l),this.e1=this.e2=-1),g&&(this.addCurrentVertex(c,this.distance,x,-1,-1,!0,l),this.addCurrentVertex(c,this.distance,x,0,0,!1,l)));if(E&&t<o-1){const e=c.dist(g);if(e>2*h){const t=c.add(g.sub(c)._mult(h/e)._round());this.distance+=t.dist(c),this.addCurrentVertex(t,this.distance,x.mult(1),0,0,!1,l),c=t}}v=!1}}addCurrentVertex(e,t,n,i,r,s,o){const a=s?1:0;let h;h=n.clone(),i&&h._sub(n.perp()._mult(i)),ee(this.layoutVertexArray,e,h,a,0,i,t),this.e3=o.vertexLength++,this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,this.e3),o.primitiveLength++),this.e1=this.e2,this.e2=this.e3,h=n.mult(-1),r&&h._sub(n.perp()._mult(r)),ee(this.layoutVertexArray,e,h,a,1,-r,t),this.e3=o.vertexLength++,this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,this.e3),o.primitiveLength++),this.e1=this.e2,this.e2=this.e3,t>Z/2&&(this.distance=0,this.addCurrentVertex(e,this.distance,n,i,r,s,o))}addPieSliceVertex(e,t,n,i,r){const s=i?1:0;n=n.mult(i?-1:1),ee(this.layoutVertexArray,e,n,0,s,0,t),this.e3=r.vertexLength++,this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,this.e3),r.primitiveLength++),i?this.e2=this.e3:this.e1=this.e3}serialize(e){return{type:this.type,style:this.style,tileSize:this.tileSize,layoutVertexArray:this.layoutVertexArray.serialize(e),indexArray:this.indexArray.serialize(e),segments:this.segments}}static createBuffer(e){e.layoutVertexBuffer=new N(e.layoutVertexArray,J.serialize(),N.BufferType.VERTEX),e.indexBuffer=new N(e.indexArray,j.serialize(),N.BufferType.ELEMENT)}}function ne(e,t,n,i,r,s){var o=n,a=i,h=r-o,l=s-a;if(0!==h||0!==l){var d=((e-o)*h+(t-a)*l)/(h*h+l*l);d>1?(o=r,a=s):d>0&&(o+=h*d,a+=l*d)}return(h=e-o)*h+(l=t-a)*l}function ie(e,t,n,i,r){for(var s,o=i,a=t+1;a<n;a++){var h=ne(e[2*a],e[2*a+1],e[2*t],e[2*t+1],e[2*n],e[2*n+1]);h>o&&(s=a,o=h)}o>i&&(s-t>1&&ie(e,t,s,i,r),r.push(e[2*s]),r.push(e[2*s+1]),n-s>1&&ie(e,s,n,i,r))}function re(e,t){var n=e.length/2-1,i=[e[0],e[1]];return ie(e,0,n,t,i),i.push(e[2*n],e[2*n+1]),i}function se(e,t,n){if(e.length<=4)return e;var i=void 0!==t?t*t:1;return e=re(e=n?e:function(e,t){for(var n,i,r,s,o=e[0],a=e[1],h=[e[0],e[1]],l=e.length/2,d=1;d<l;d++)n=e[2*d],i=e[2*d+1],r=void 0,s=void 0,(r=n-o)*r+(s=i-a)*s>t&&(h.push(n),h.push(i),o=n,a=i);return o!==n&&a!==i&&(h.push(n),h.push(i)),h}(e,i),i)}function oe(e,t){this.x=e,this.y=t}let ae;oe.prototype={clone:function(){return new oe(this.x,this.y)},add:function(e){return this.clone()._add(e)},sub:function(e){return this.clone()._sub(e)},mult:function(e){return this.clone()._mult(e)},div:function(e){return this.clone()._div(e)},rotate:function(e){return this.clone()._rotate(e)},matMult:function(e){return this.clone()._matMult(e)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(e){return this.x===e.x&&this.y===e.y},dist:function(e){return Math.sqrt(this.distSqr(e))},distSqr:function(e){var t=e.x-this.x,n=e.y-this.y;return t*t+n*n},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(e){return Math.atan2(this.y-e.y,this.x-e.x)},angleWith:function(e){return this.angleWithSep(e.x,e.y)},angleWithSep:function(e,t){return Math.atan2(this.x*t-this.y*e,this.x*e+this.y*t)},_matMult:function(e){var t=e[0]*this.x+e[1]*this.y,n=e[2]*this.x+e[3]*this.y;return this.x=t,this.y=n,this},_add:function(e){return this.x+=e.x,this.y+=e.y,this},_sub:function(e){return this.x-=e.x,this.y-=e.y,this},_mult:function(e){return this.x*=e,this.y*=e,this},_div:function(e){return this.x/=e,this.y/=e,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var e=this.y;return this.y=this.x,this.x=-e,this},_rotate:function(e){var t=Math.cos(e),n=Math.sin(e),i=t*this.x-n*this.y,r=n*this.x+t*this.y;return this.x=i,this.y=r,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},oe.convert=function(e){return e instanceof oe?e:Array.isArray(e)?new oe(e[0],e[1]):e};let he=512,le="";function de(e){let t=[],n=0,i=0;for(;n<e.length;){let r=e[n++];if(r<128)t[i++]=r;else if(r>191&&r<224){let s=e[n++];t[i++]=(31&r)<<6|63&s}else if(r>239&&r<365){let s=((7&r)<<18|(63&e[n++])<<12|(63&e[n++])<<6|63&e[n++])-65536;t[i++]=55296+(s>>10),t[i++]=56320+(1023&s)}else{let s=e[n++],o=e[n++];t[i++]=(15&r)<<12|(63&s)<<6|63&o}}let r=[],s=0,o=0,a=0,h=5e4,l=t.length/h-1;for(s=0;s<l;s++)o=s*h,a=(s+1)*h,r.push(String.fromCharCode.apply({},t.slice(o,a)));return o=s*h,a=t.length,r.push(String.fromCharCode.apply({},t.slice(o,a))),r=r.join(""),r}function ue(e,t){if(e&&e.layer){(function(e,t){for(let n in e){let i=e[n].features;i||(i=e[n].datas);for(let e=0;e<i.length;e++)ce(i[e][2],t)}})(e=e.layer,t.needDecode);let n={},i=new l([e],t.level,n,t.controlVector,t.highLightVector,t.filterLayerId);return ae.call({},i,t.level),n}return{}}function ce(e,t){if("F"!=e[0])if(Array.isArray(e[0])){let n=e.length;for(let i=0;i<n;i++){ce(e[i],t)}}else t&&function(e){let t=[e[0],e[1]];for(let n=2;n<e.length;n++){let i=t[0]+e[n],r=t[1]+e[n+1];e[n]=i,e[n+1]=r,t=[i,r],n++}}(e);else e[0]=[.05*-he,.05*-he,1.05*he,.05*-he,1.05*he,1.05*he,.05*-he,1.05*he]}function fe(e,t){let n=[];for(let i=0;i<e.keyArr.length;i++){let r=e[e.keyArr[i]],s=r.style;if(xe(s),r.lineFeatues.length>0){let e=new te({style:s,type:"line",tileSize:he});for(let t of r.lineFeatues){ge(t,s);let n=pe(t);e.addFeature(n)}e=e.serialize(t),n.push(e)}else if(r.fillFeatures.length>0){let e=new Q({style:s,type:"fill",tileSize:he}),i=new te({style:s,type:"line",tileSize:he});for(let t of r.fillFeatures){ge(t,s);let n=pe(t);e.addFeature(n),s.stroke&&i.addFeature(n)}e=e.serialize(t),n.push(e),s.stroke&&(i=i.serialize(t),n.push(i))}}return n}function ge(e,t,n){if(!t.sparsity)return;let i=parseFloat(t.sparsity);for(let t=0;t<e.data.length;t++){let n=e.data[t];null==i&&1==i||(e.data[t]=se(n,i/4,!0))}}function pe(e){let t=256/he*32,n=[];for(let i=0;i<e.data.length;i++){n[i]=[];let r=e.data[i];for(let e=0;e<r.length;e++)if(e%2==0){let s=r[e]*t,o=r[e+1]*t;n[i].push(new oe(s,o))}}return n}function xe(t){let n=new e;if(t.fillColor){n.fromHex(t.fillColor);let e=[n.rgb[0]/255,n.rgb[1]/255,n.rgb[2]/255,1];t.fillColor=e}if(t.strokeColor){n=new e,n.fromHex(t.strokeColor);let i=[n.rgb[0]/255,n.rgb[1]/255,n.rgb[2]/255,1];t.strokeColor=i}}return a((function(e,t){if(1==e.init)return ae=new Function("drawer","level",e.styleStr),he=e.tileSize,le=e.return_type,!0;if(1==e.changeStyle){let n=de(new Uint8Array(e.tileData));return fe(ue(JSON.parse(n),e),t)}var n,i=e.url,r=new s.Resource({url:i});return r.request.throttle=!1,r.request.throttleByServer=!0,r.request.type=1,!(n="stream_snappy"==le?r.fetchArrayBuffer():r.fetchJson())||n.then((function(n){let i=null;if("stream_snappy"==le){n=h(n),t.push(n);let e=new Uint8Array(n);i=e.buffer;let r=de(e);n=JSON.parse(r)}return{tileData:i,buckets:fe(ue(n,e),t)}}))}))}));
