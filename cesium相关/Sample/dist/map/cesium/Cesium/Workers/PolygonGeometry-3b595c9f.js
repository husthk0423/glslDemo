define(["exports","./when-c2e8ef35","./Check-c4f3a3fc","./Math-d30358ed","./Cartesian2-f9492f23","./BoundingSphere-dcb1d5fc","./Transforms-8b7e0d39","./Rectangle-3285eeb3","./ComponentDatatype-5d3f6452","./GeometryAttribute-a5c051b9","./GeometryPipeline-01c9df66","./IndexDatatype-e3260434","./GeometryOffsetAttribute-e6e9672c","./VertexFormat-ad523db1","./GeometryInstance-b1e4a9ef","./BoundingRectangle-f5c8097c","./EllipsoidTangentPlane-98a8a37e","./ArcType-29cf2197","./PolygonPipeline-db004fe0","./PolygonGeometryLibrary-d78156f9","./EllipsoidGeodesic-c0017f17"],(function(e,t,r,a,o,i,n,s,l,u,p,c,y,g,m,d,h,f,v,b,_){"use strict";var P=new o.Cartographic,w=new o.Cartographic;function x(e,t,r,a){var o=a.cartesianToCartographic(e,P).height,i=a.cartesianToCartographic(t,w);i.height=o,a.cartographicToCartesian(i,t);var n=a.cartesianToCartographic(r,w);n.height=o-100,a.cartographicToCartesian(n,r)}var C=new d.BoundingRectangle,T=new o.Cartesian3,I=new o.Cartesian3,A=new o.Cartesian3,E=new o.Cartesian3,G=new o.Cartesian3,O=new o.Cartesian3,V=new o.Cartesian3,F=new o.Cartesian3,N=new o.Cartesian3,D=new o.Cartesian2,H=new o.Cartesian2,L=new o.Cartesian3,R=new n.Quaternion,M=new n.Matrix3,S=new n.Matrix3;function B(e){var r=e.vertexFormat,i=e.geometry,s=e.shadowVolume,p=i.attributes.position.values,c=p.length,g=e.wall,m=e.top||g,d=e.bottom||g;if(r.st||r.normal||r.tangent||r.bitangent||s){var h=e.boundingRectangle,f=e.tangentPlane,v=e.ellipsoid,b=e.stRotation,_=e.perPositionHeight,P=D;P.x=h.x,P.y=h.y;var w,C=r.st?new Float32Array(c/3*2):void 0;r.normal&&(w=_&&m&&!g?i.attributes.normal.values:new Float32Array(c));var B=r.tangent?new Float32Array(c):void 0,k=r.bitangent?new Float32Array(c):void 0,z=s?new Float32Array(c):void 0,W=0,Y=0,U=I,j=A,Q=E,q=!0,K=M,Z=S;if(0!==b){var J=n.Quaternion.fromAxisAngle(f._plane.normal,b,R);K=n.Matrix3.fromQuaternion(J,K),J=n.Quaternion.fromAxisAngle(f._plane.normal,-b,R),Z=n.Matrix3.fromQuaternion(J,Z)}else K=n.Matrix3.clone(n.Matrix3.IDENTITY,K),Z=n.Matrix3.clone(n.Matrix3.IDENTITY,Z);var X=0,$=0;m&&d&&(X=c/2,$=c/3,c/=2);for(var ee=0;ee<c;ee+=3){var te=o.Cartesian3.fromArray(p,ee,L);if(r.st){var re=n.Matrix3.multiplyByVector(K,te,T);re=v.scaleToGeodeticSurface(re,re);var ae=f.projectPointOntoPlane(re,H);o.Cartesian2.subtract(ae,P,ae);var oe=a.CesiumMath.clamp(ae.x/h.width,0,1),ie=a.CesiumMath.clamp(ae.y/h.height,0,1);d&&(C[W+$]=oe,C[W+1+$]=ie),m&&(C[W]=oe,C[W+1]=ie),W+=2}if(r.normal||r.tangent||r.bitangent||s){var ne=Y+1,se=Y+2;if(g){if(ee+3<c){var le=o.Cartesian3.fromArray(p,ee+3,G);if(q){var ue=o.Cartesian3.fromArray(p,ee+c,O);_&&x(te,le,ue,v),o.Cartesian3.subtract(le,te,le),o.Cartesian3.subtract(ue,te,ue),U=o.Cartesian3.normalize(o.Cartesian3.cross(ue,le,U),U),q=!1}o.Cartesian3.equalsEpsilon(le,te,a.CesiumMath.EPSILON10)&&(q=!0)}(r.tangent||r.bitangent)&&(Q=v.geodeticSurfaceNormal(te,Q),r.tangent&&(j=o.Cartesian3.normalize(o.Cartesian3.cross(Q,U,j),j)))}else U=v.geodeticSurfaceNormal(te,U),(r.tangent||r.bitangent)&&(_&&(V=o.Cartesian3.fromArray(w,Y,V),F=o.Cartesian3.cross(o.Cartesian3.UNIT_Z,V,F),F=o.Cartesian3.normalize(n.Matrix3.multiplyByVector(Z,F,F),F),r.bitangent&&(N=o.Cartesian3.normalize(o.Cartesian3.cross(V,F,N),N))),j=o.Cartesian3.cross(o.Cartesian3.UNIT_Z,U,j),j=o.Cartesian3.normalize(n.Matrix3.multiplyByVector(Z,j,j),j),r.bitangent&&(Q=o.Cartesian3.normalize(o.Cartesian3.cross(U,j,Q),Q)));r.normal&&(e.wall?(w[Y+X]=U.x,w[ne+X]=U.y,w[se+X]=U.z):d&&(w[Y+X]=-U.x,w[ne+X]=-U.y,w[se+X]=-U.z),(m&&!_||g)&&(w[Y]=U.x,w[ne]=U.y,w[se]=U.z)),s&&(g&&(U=v.geodeticSurfaceNormal(te,U)),z[Y+X]=-U.x,z[ne+X]=-U.y,z[se+X]=-U.z),r.tangent&&(e.wall?(B[Y+X]=j.x,B[ne+X]=j.y,B[se+X]=j.z):d&&(B[Y+X]=-j.x,B[ne+X]=-j.y,B[se+X]=-j.z),m&&(_?(B[Y]=F.x,B[ne]=F.y,B[se]=F.z):(B[Y]=j.x,B[ne]=j.y,B[se]=j.z))),r.bitangent&&(d&&(k[Y+X]=Q.x,k[ne+X]=Q.y,k[se+X]=Q.z),m&&(_?(k[Y]=N.x,k[ne]=N.y,k[se]=N.z):(k[Y]=Q.x,k[ne]=Q.y,k[se]=Q.z))),Y+=3}}r.st&&(i.attributes.st=new u.GeometryAttribute({componentDatatype:l.ComponentDatatype.FLOAT,componentsPerAttribute:2,values:C})),r.normal&&(i.attributes.normal=new u.GeometryAttribute({componentDatatype:l.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:w})),r.tangent&&(i.attributes.tangent=new u.GeometryAttribute({componentDatatype:l.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:B})),r.bitangent&&(i.attributes.bitangent=new u.GeometryAttribute({componentDatatype:l.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:k})),s&&(i.attributes.extrudeDirection=new u.GeometryAttribute({componentDatatype:l.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:z}))}if(e.extrude&&t.defined(e.offsetAttribute)){var pe=p.length/3,ce=new Uint8Array(pe);if(e.offsetAttribute===y.GeometryOffsetAttribute.TOP)m&&d||g?ce=y.arrayFill(ce,1,0,pe/2):m&&(ce=y.arrayFill(ce,1));else{var ye=e.offsetAttribute===y.GeometryOffsetAttribute.NONE?0:1;ce=y.arrayFill(ce,ye)}i.attributes.applyOffset=new u.GeometryAttribute({componentDatatype:l.ComponentDatatype.UNSIGNED_BYTE,componentsPerAttribute:1,values:ce})}return i}var k=new o.Cartographic,z=new o.Cartographic,W={westOverIDL:0,eastOverIDL:0},Y=new _.EllipsoidGeodesic;function U(e,r,o,i,n){if(n=t.defaultValue(n,new s.Rectangle),!t.defined(e)||e.length<3)return n.west=0,n.north=0,n.south=0,n.east=0,n;if(o===f.ArcType.RHUMB)return s.Rectangle.fromCartesianArray(e,r,n);Y.ellipsoid.equals(r)||(Y=new _.EllipsoidGeodesic(void 0,void 0,r)),n.west=Number.POSITIVE_INFINITY,n.east=Number.NEGATIVE_INFINITY,n.south=Number.POSITIVE_INFINITY,n.north=Number.NEGATIVE_INFINITY,W.westOverIDL=Number.POSITIVE_INFINITY,W.eastOverIDL=Number.NEGATIVE_INFINITY;for(var l,u=1/a.CesiumMath.chordLength(i,r.maximumRadius),p=e.length,c=r.cartesianToCartographic(e[0],z),y=k,g=1;g<p;g++)l=y,y=c,c=r.cartesianToCartographic(e[g],l),Y.setEndPoints(y,c),Q(Y,u,n,W);return l=y,y=c,c=r.cartesianToCartographic(e[0],l),Y.setEndPoints(y,c),Q(Y,u,n,W),n.east-n.west>W.eastOverIDL-W.westOverIDL&&(n.west=W.westOverIDL,n.east=W.eastOverIDL,n.east>a.CesiumMath.PI&&(n.east=n.east-a.CesiumMath.TWO_PI),n.west>a.CesiumMath.PI&&(n.west=n.west-a.CesiumMath.TWO_PI)),n}var j=new o.Cartographic;function Q(e,t,r,o){for(var i=e.surfaceDistance,n=Math.ceil(i*t),s=n>0?i/(n-1):Number.POSITIVE_INFINITY,l=0,u=0;u<n;u++){var p=e.interpolateUsingSurfaceDistance(l,j);l+=s;var c=p.longitude,y=p.latitude;r.west=Math.min(r.west,c),r.east=Math.max(r.east,c),r.south=Math.min(r.south,y),r.north=Math.max(r.north,y);var g=c>=0?c:c+a.CesiumMath.TWO_PI;o.westOverIDL=Math.min(o.westOverIDL,g),o.eastOverIDL=Math.max(o.eastOverIDL,g)}}var q=[];function K(e,t,r,a,o,i,n,s,l){var u,p={walls:[]};if(i||n){var y,g,d=b.PolygonGeometryLibrary.createGeometryFromPositions(e,t,r,o,s,l),f=d.attributes.position.values,_=d.indices;if(i&&n){var P=f.concat(f);y=P.length/3,(g=c.IndexDatatype.createTypedArray(y,2*_.length)).set(_);var w=_.length,x=y/2;for(u=0;u<w;u+=3){var C=g[u]+x,T=g[u+1]+x,I=g[u+2]+x;g[u+w]=I,g[u+1+w]=T,g[u+2+w]=C}if(d.attributes.position.values=P,o&&s.normal){var A=d.attributes.normal.values;d.attributes.normal.values=new Float32Array(P.length),d.attributes.normal.values.set(A)}d.indices=g}else if(n){for(y=f.length/3,g=c.IndexDatatype.createTypedArray(y,_.length),u=0;u<_.length;u+=3)g[u]=_[u+2],g[u+1]=_[u+1],g[u+2]=_[u];d.indices=g}p.topAndBottom=new m.GeometryInstance({geometry:d})}var E=a.outerRing,G=h.EllipsoidTangentPlane.fromPoints(E,e),O=G.projectPointsOntoPlane(E,q),V=v.PolygonPipeline.computeWindingOrder2D(O);V===v.WindingOrder.CLOCKWISE&&(E=E.slice().reverse());var F=b.PolygonGeometryLibrary.computeWallGeometry(E,e,r,o,l);p.walls.push(new m.GeometryInstance({geometry:F}));var N=a.holes;for(u=0;u<N.length;u++){var D=N[u];O=(G=h.EllipsoidTangentPlane.fromPoints(D,e)).projectPointsOntoPlane(D,q),(V=v.PolygonPipeline.computeWindingOrder2D(O))===v.WindingOrder.COUNTER_CLOCKWISE&&(D=D.slice().reverse()),F=b.PolygonGeometryLibrary.computeWallGeometry(D,e,r,o,l),p.walls.push(new m.GeometryInstance({geometry:F}))}return p}function Z(e){var r=e.polygonHierarchy,i=t.defaultValue(e.vertexFormat,g.VertexFormat.DEFAULT),n=t.defaultValue(e.ellipsoid,o.Ellipsoid.WGS84),s=t.defaultValue(e.granularity,a.CesiumMath.RADIANS_PER_DEGREE),l=t.defaultValue(e.stRotation,0),u=t.defaultValue(e.perPositionHeight,!1),p=u&&t.defined(e.extrudedHeight),c=t.defaultValue(e.height,0),y=t.defaultValue(e.extrudedHeight,c);if(!p){var m=Math.max(c,y);y=Math.min(c,y),c=m}this._vertexFormat=g.VertexFormat.clone(i),this._ellipsoid=o.Ellipsoid.clone(n),this._granularity=s,this._stRotation=l,this._height=c,this._extrudedHeight=y,this._closeTop=t.defaultValue(e.closeTop,!0),this._closeBottom=t.defaultValue(e.closeBottom,!0),this._polygonHierarchy=r,this._perPositionHeight=u,this._perPositionHeightExtrude=p,this._shadowVolume=t.defaultValue(e.shadowVolume,!1),this._workerName="createPolygonGeometry",this._offsetAttribute=e.offsetAttribute,this._arcType=t.defaultValue(e.arcType,f.ArcType.GEODESIC),this._rectangle=void 0,this._textureCoordinateRotationPoints=void 0,this.packedLength=b.PolygonGeometryLibrary.computeHierarchyPackedLength(r)+o.Ellipsoid.packedLength+g.VertexFormat.packedLength+12}Z.fromPositions=function(e){return new Z({polygonHierarchy:{positions:(e=t.defaultValue(e,t.defaultValue.EMPTY_OBJECT)).positions},height:e.height,extrudedHeight:e.extrudedHeight,vertexFormat:e.vertexFormat,stRotation:e.stRotation,ellipsoid:e.ellipsoid,granularity:e.granularity,perPositionHeight:e.perPositionHeight,closeTop:e.closeTop,closeBottom:e.closeBottom,offsetAttribute:e.offsetAttribute,arcType:e.arcType})},Z.pack=function(e,r,a){return a=t.defaultValue(a,0),a=b.PolygonGeometryLibrary.packPolygonHierarchy(e._polygonHierarchy,r,a),o.Ellipsoid.pack(e._ellipsoid,r,a),a+=o.Ellipsoid.packedLength,g.VertexFormat.pack(e._vertexFormat,r,a),a+=g.VertexFormat.packedLength,r[a++]=e._height,r[a++]=e._extrudedHeight,r[a++]=e._granularity,r[a++]=e._stRotation,r[a++]=e._perPositionHeightExtrude?1:0,r[a++]=e._perPositionHeight?1:0,r[a++]=e._closeTop?1:0,r[a++]=e._closeBottom?1:0,r[a++]=e._shadowVolume?1:0,r[a++]=t.defaultValue(e._offsetAttribute,-1),r[a++]=e._arcType,r[a]=e.packedLength,r};var J=o.Ellipsoid.clone(o.Ellipsoid.UNIT_SPHERE),X=new g.VertexFormat,$={polygonHierarchy:{}};Z.unpack=function(e,r,a){r=t.defaultValue(r,0);var i=b.PolygonGeometryLibrary.unpackPolygonHierarchy(e,r);r=i.startingIndex,delete i.startingIndex;var n=o.Ellipsoid.unpack(e,r,J);r+=o.Ellipsoid.packedLength;var s=g.VertexFormat.unpack(e,r,X);r+=g.VertexFormat.packedLength;var l=e[r++],u=e[r++],p=e[r++],c=e[r++],y=1===e[r++],m=1===e[r++],d=1===e[r++],h=1===e[r++],f=1===e[r++],v=e[r++],_=e[r++],P=e[r];return t.defined(a)||(a=new Z($)),a._polygonHierarchy=i,a._ellipsoid=o.Ellipsoid.clone(n,a._ellipsoid),a._vertexFormat=g.VertexFormat.clone(s,a._vertexFormat),a._height=l,a._extrudedHeight=u,a._granularity=p,a._stRotation=c,a._perPositionHeightExtrude=y,a._perPositionHeight=m,a._closeTop=d,a._closeBottom=h,a._shadowVolume=f,a._offsetAttribute=-1===v?void 0:v,a._arcType=_,a.packedLength=P,a},Z.computeRectangle=function(e,r){var i=t.defaultValue(e.granularity,a.CesiumMath.RADIANS_PER_DEGREE),n=t.defaultValue(e.arcType,f.ArcType.GEODESIC),s=e.polygonHierarchy,l=t.defaultValue(e.ellipsoid,o.Ellipsoid.WGS84);return U(s.positions,l,n,i,r)},Z.createGeometry=function(e){var r=e._vertexFormat,o=e._ellipsoid,n=e._granularity,s=e._stRotation,g=e._polygonHierarchy,d=e._perPositionHeight,f=e._closeTop,_=e._closeBottom,P=e._arcType,w=g.positions;if(!(w.length<3)){var x=h.EllipsoidTangentPlane.fromPoints(w,o),T=b.PolygonGeometryLibrary.polygonsFromHierarchy(g,x.projectPointsOntoPlane.bind(x),!d,o),I=T.hierarchy,A=T.polygons;if(0!==I.length){w=I[0].outerRing;var E,G=b.PolygonGeometryLibrary.computeBoundingRectangle(x.plane.normal,x.projectPointOntoPlane.bind(x),w,s,C),O=[],V=e._height,F=e._extrudedHeight,N={perPositionHeight:d,vertexFormat:r,geometry:void 0,tangentPlane:x,boundingRectangle:G,ellipsoid:o,stRotation:s,bottom:!1,top:!0,wall:!1,extrude:!1,arcType:P};if(e._perPositionHeightExtrude||!a.CesiumMath.equalsEpsilon(V,F,0,a.CesiumMath.EPSILON2))for(N.extrude=!0,N.top=f,N.bottom=_,N.shadowVolume=e._shadowVolume,N.offsetAttribute=e._offsetAttribute,E=0;E<A.length;E++){var D,H=K(o,A[E],n,I[E],d,f,_,r,P);f&&_?(D=H.topAndBottom,N.geometry=b.PolygonGeometryLibrary.scaleToGeodeticHeightExtruded(D.geometry,V,F,o,d)):f?((D=H.topAndBottom).geometry.attributes.position.values=v.PolygonPipeline.scaleToGeodeticHeight(D.geometry.attributes.position.values,V,o,!d),N.geometry=D.geometry):_&&((D=H.topAndBottom).geometry.attributes.position.values=v.PolygonPipeline.scaleToGeodeticHeight(D.geometry.attributes.position.values,F,o,!0),N.geometry=D.geometry),(f||_)&&(N.wall=!1,D.geometry=B(N),O.push(D));var L=H.walls;N.wall=!0;for(var R=0;R<L.length;R++){var M=L[R];N.geometry=b.PolygonGeometryLibrary.scaleToGeodeticHeightExtruded(M.geometry,V,F,o,d),M.geometry=B(N),O.push(M)}}else for(E=0;E<A.length;E++){var S=new m.GeometryInstance({geometry:b.PolygonGeometryLibrary.createGeometryFromPositions(o,A[E],n,d,r,P)});if(S.geometry.attributes.position.values=v.PolygonPipeline.scaleToGeodeticHeight(S.geometry.attributes.position.values,V,o,!d),N.geometry=S.geometry,S.geometry=B(N),t.defined(e._offsetAttribute)){var k=S.geometry.attributes.position.values.length,z=new Uint8Array(k/3),W=e._offsetAttribute===y.GeometryOffsetAttribute.NONE?0:1;y.arrayFill(z,W),S.geometry.attributes.applyOffset=new u.GeometryAttribute({componentDatatype:l.ComponentDatatype.UNSIGNED_BYTE,componentsPerAttribute:1,values:z})}O.push(S)}var Y=p.GeometryPipeline.combineInstances(O)[0];Y.attributes.position.values=new Float64Array(Y.attributes.position.values),Y.indices=c.IndexDatatype.createTypedArray(Y.attributes.position.values.length/3,Y.indices);var U=Y.attributes,j=i.BoundingSphere.fromVertices(U.position.values);return r.position||delete U.position,new u.Geometry({attributes:U,indices:Y.indices,primitiveType:Y.primitiveType,boundingSphere:j,offsetAttribute:e._offsetAttribute})}}},Z.createShadowVolume=function(e,t,r){var a=e._granularity,o=e._ellipsoid,i=t(a,o),n=r(a,o);return new Z({polygonHierarchy:e._polygonHierarchy,ellipsoid:o,stRotation:e._stRotation,granularity:a,perPositionHeight:!1,extrudedHeight:i,height:n,vertexFormat:g.VertexFormat.POSITION_ONLY,shadowVolume:!0,arcType:e._arcType})},Object.defineProperties(Z.prototype,{rectangle:{get:function(){if(!t.defined(this._rectangle)){var e=this._polygonHierarchy.positions;this._rectangle=U(e,this._ellipsoid,this._arcType,this._granularity)}return this._rectangle}},textureCoordinateRotationPoints:{get:function(){return t.defined(this._textureCoordinateRotationPoints)||(this._textureCoordinateRotationPoints=function(e){var t=-e._stRotation;if(0===t)return[0,0,0,1,1,0];var r=e._ellipsoid,a=e._polygonHierarchy.positions,o=e.rectangle;return u.Geometry._textureCoordinateRotationPoints(a,t,r,o)}(this)),this._textureCoordinateRotationPoints}}}),e.PolygonGeometry=Z}));
