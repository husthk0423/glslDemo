define(["./when-c2e8ef35","./Check-c4f3a3fc","./Math-d30358ed","./Cartesian2-f9492f23","./BoundingSphere-dcb1d5fc","./Transforms-8b7e0d39","./RuntimeError-6122571f","./Rectangle-3285eeb3","./WebGLConstants-4ae0db90","./ComponentDatatype-5d3f6452","./AttributeCompression-72a6590f","./IndexDatatype-e3260434","./IntersectionTests-525ff5aa","./Plane-dbdf17bf","./WebMercatorProjection-6d7fb40a","./createTaskProcessorWorker","./EllipsoidTangentPlane-98a8a37e","./OrientedBoundingBox-fd425b2c","./TerrainEncoding-dc4d155b"],(function(e,t,r,n,i,o,a,s,d,c,u,h,l,I,m,g,T,f,p){"use strict";function E(){t.DeveloperError.throwInstantiationError()}Object.defineProperties(E.prototype,{errorEvent:{get:t.DeveloperError.throwInstantiationError},credit:{get:t.DeveloperError.throwInstantiationError},tilingScheme:{get:t.DeveloperError.throwInstantiationError},ready:{get:t.DeveloperError.throwInstantiationError},readyPromise:{get:t.DeveloperError.throwInstantiationError},hasWaterMask:{get:t.DeveloperError.throwInstantiationError},hasVertexNormals:{get:t.DeveloperError.throwInstantiationError},availability:{get:t.DeveloperError.throwInstantiationError}});var v=[];E.getRegularGridIndices=function(t,n){var i=v[t];e.defined(i)||(v[t]=i=[]);var o=i[n];return e.defined(o)||x(t,n,o=t*n<r.CesiumMath.SIXTY_FOUR_KILOBYTES?i[n]=new Uint16Array((t-1)*(n-1)*6):i[n]=new Uint32Array((t-1)*(n-1)*6),0),o};var y=[];E.getRegularGridIndicesAndEdgeIndices=function(t,r){var n=y[t];e.defined(n)||(y[t]=n=[]);var i=n[r];if(!e.defined(i)){var o=E.getRegularGridIndices(t,r),a=w(t,r),s=a.westIndicesSouthToNorth,d=a.southIndicesEastToWest,c=a.eastIndicesNorthToSouth,u=a.northIndicesWestToEast;i=n[r]={indices:o,westIndicesSouthToNorth:s,southIndicesEastToWest:d,eastIndicesNorthToSouth:c,northIndicesWestToEast:u}}return i};var N=[];function w(e,t){var r,n=new Array(t),i=new Array(e),o=new Array(t),a=new Array(e);for(r=0;r<e;++r)a[r]=r,i[r]=e*t-1-r;for(r=0;r<t;++r)o[r]=(r+1)*e-1,n[r]=(t-r-1)*e;return{westIndicesSouthToNorth:n,southIndicesEastToWest:i,eastIndicesNorthToSouth:o,northIndicesWestToEast:a}}function x(e,t,r,n){for(var i=0,o=0;o<t-1;++o){for(var a=0;a<e-1;++a){var s=i,d=s+e,c=d+1,u=s+1;r[n++]=s,r[n++]=d,r[n++]=u,r[n++]=u,r[n++]=d,r[n++]=c,++i}++i}}function M(e,t,r,n){for(var i=e[0],o=e.length,a=1;a<o;++a){var s=e[a];r[n++]=i,r[n++]=s,r[n++]=t,r[n++]=t,r[n++]=s,r[n++]=t+1,i=s,++t}return n}E.getRegularGridAndSkirtIndicesAndEdgeIndices=function(t,r){var n=N[t];e.defined(n)||(N[t]=n=[]);var i=n[r];if(!e.defined(i)){var o=t*r,a=(t-1)*(r-1)*6,s=2*t+2*r,d=o+s,c=a+6*Math.max(0,s-4),u=w(t,r),l=u.westIndicesSouthToNorth,I=u.southIndicesEastToWest,m=u.eastIndicesNorthToSouth,g=u.northIndicesWestToEast,T=h.IndexDatatype.createTypedArray(d,c);x(t,r,T,0),E.addSkirtIndices(l,I,m,g,o,T,a),i=n[r]={indices:T,westIndicesSouthToNorth:l,southIndicesEastToWest:I,eastIndicesNorthToSouth:m,northIndicesWestToEast:g,indexCountWithoutSkirts:a}}return i},E.addSkirtIndices=function(e,t,r,n,i,o,a){var s=i;a=M(e,s,o,a),a=M(t,s+=e.length,o,a),a=M(r,s+=t.length,o,a),M(n,s+=r.length,o,a)},E.heightmapTerrainQuality=.25,E.getEstimatedLevelZeroGeometricErrorForAHeightmap=function(e,t,r){return 2*e.maximumRadius*Math.PI*E.heightmapTerrainQuality/(t*r)},E.prototype.requestTileGeometry=t.DeveloperError.throwInstantiationError,E.prototype.getLevelMaximumGeometricError=t.DeveloperError.throwInstantiationError,E.prototype.getTileDataAvailable=t.DeveloperError.throwInstantiationError,E.prototype.loadTileDataAvailability=t.DeveloperError.throwInstantiationError;var b=32767,C=new n.Cartesian3,S=new n.Cartesian3,A=new n.Cartesian3,P=new n.Cartographic,W=new n.Cartesian2,B=new n.Cartesian3,D=new o.Matrix4,F=new o.Matrix4;function k(e,t,i,a,s,d,c,u,h){var l=Number.POSITIVE_INFINITY,I=s.north,m=s.south,g=s.east,T=s.west;g<T&&(g+=r.CesiumMath.TWO_PI);for(var f=e.length,p=0;p<f;++p){var E=e[p],v=i[E],y=a[E];P.longitude=r.CesiumMath.lerp(T,g,y.x),P.latitude=r.CesiumMath.lerp(m,I,y.y),P.height=v-t;var N=d.cartographicToCartesian(P,C);o.Matrix4.multiplyByPoint(c,N,N),n.Cartesian3.minimumByComponent(N,u,u),n.Cartesian3.maximumByComponent(N,h,h),l=Math.min(l,P.height)}return l}function V(t,i,a,s,d,c,h,l,I,g,T,f,p,E,v){var y=e.defined(h),N=I.north,w=I.south,x=I.east,M=I.west;x<M&&(x+=r.CesiumMath.TWO_PI);for(var b=a.length,S=0;S<b;++S){var A=a[S],k=d[A],V=c[A];P.longitude=r.CesiumMath.lerp(M,x,V.x)+E,P.latitude=r.CesiumMath.lerp(w,N,V.y)+v,P.height=k-g;var _,H=l.cartographicToCartesian(P,C);if(y){var O=2*A;if(W.x=h[O],W.y=h[O+1],1!==T){var G=u.AttributeCompression.octDecode(W.x,W.y,B),Y=o.Transforms.eastNorthUpToFixedFrame(C,l,F),z=o.Matrix4.inverseTransformation(Y,D);o.Matrix4.multiplyByPointAsVector(z,G,G),G.z*=T,n.Cartesian3.normalize(G,G),o.Matrix4.multiplyByPointAsVector(Y,G,G),n.Cartesian3.normalize(G,G),u.AttributeCompression.octEncode(G,W)}}s.hasWebMercatorT&&(_=(m.WebMercatorProjection.geodeticLatitudeToMercatorAngle(P.latitude)-f)*p),i=s.encode(t,i,H,V,P.height,W,_)}}function _(t,r){var n;return"function"==typeof t.slice&&"function"!=typeof(n=t.slice()).sort&&(n=void 0),e.defined(n)||(n=Array.prototype.slice.call(t)),n.sort(r),n}return g((function(t,a){var d,c,l=t.quantizedVertices,I=l.length/3,g=t.octEncodedNormals,v=t.westIndices.length+t.eastIndices.length+t.southIndices.length+t.northIndices.length,y=t.includeWebMercatorT,N=s.Rectangle.clone(t.rectangle),w=N.west,x=N.south,M=N.east,H=N.north,O=n.Ellipsoid.clone(t.ellipsoid),G=t.exaggeration,Y=t.minimumHeight*G,z=t.maximumHeight*G,R=t.relativeToCenter,L=o.Transforms.eastNorthUpToFixedFrame(R,O),U=o.Matrix4.inverseTransformation(L,new o.Matrix4);y&&(d=m.WebMercatorProjection.geodeticLatitudeToMercatorAngle(x),c=1/(m.WebMercatorProjection.geodeticLatitudeToMercatorAngle(H)-d));var j=l.subarray(0,I),q=l.subarray(I,2*I),Q=l.subarray(2*I,3*I),K=e.defined(g),X=new Array(I),Z=new Array(I),J=new Array(I),$=y?new Array(I):[],ee=S;ee.x=Number.POSITIVE_INFINITY,ee.y=Number.POSITIVE_INFINITY,ee.z=Number.POSITIVE_INFINITY;var te=A;te.x=Number.NEGATIVE_INFINITY,te.y=Number.NEGATIVE_INFINITY,te.z=Number.NEGATIVE_INFINITY;for(var re=Number.POSITIVE_INFINITY,ne=Number.NEGATIVE_INFINITY,ie=Number.POSITIVE_INFINITY,oe=Number.NEGATIVE_INFINITY,ae=0;ae<I;++ae){var se=j[ae],de=q[ae],ce=se/b,ue=de/b,he=r.CesiumMath.lerp(Y,z,Q[ae]/b);P.longitude=r.CesiumMath.lerp(w,M,ce),P.latitude=r.CesiumMath.lerp(x,H,ue),P.height=he,re=Math.min(P.longitude,re),ne=Math.max(P.longitude,ne),ie=Math.min(P.latitude,ie),oe=Math.max(P.latitude,oe);var le=O.cartographicToCartesian(P);X[ae]=new n.Cartesian2(ce,ue),Z[ae]=he,J[ae]=le,y&&($[ae]=(m.WebMercatorProjection.geodeticLatitudeToMercatorAngle(P.latitude)-d)*c),o.Matrix4.multiplyByPoint(U,le,C),n.Cartesian3.minimumByComponent(C,ee,ee),n.Cartesian3.maximumByComponent(C,te,te)}var Ie,me,ge,Te=_(t.westIndices,(function(e,t){return X[e].y-X[t].y})),fe=_(t.eastIndices,(function(e,t){return X[t].y-X[e].y})),pe=_(t.southIndices,(function(e,t){return X[t].x-X[e].x})),Ee=_(t.northIndices,(function(e,t){return X[e].x-X[t].x}));1!==G&&(me=i.BoundingSphere.fromPoints(J),Ie=f.OrientedBoundingBox.fromRectangle(N,Y,z,O)),(1!==G||Y<0)&&(ge=new p.EllipsoidalOccluder(O).computeHorizonCullingPointPossiblyUnderEllipsoid(R,J,Y));var ve=Y;ve=Math.min(ve,k(t.westIndices,t.westSkirtHeight,Z,X,N,O,U,ee,te)),ve=Math.min(ve,k(t.southIndices,t.southSkirtHeight,Z,X,N,O,U,ee,te)),ve=Math.min(ve,k(t.eastIndices,t.eastSkirtHeight,Z,X,N,O,U,ee,te)),ve=Math.min(ve,k(t.northIndices,t.northSkirtHeight,Z,X,N,O,U,ee,te));for(var ye=new T.AxisAlignedBoundingBox(ee,te,R),Ne=new p.TerrainEncoding(ye,ve,z,L,K,y),we=Ne.getStride(),xe=new Float32Array(I*we+v*we),Me=0,be=0;be<I;++be){if(K){var Ce=2*be;if(W.x=g[Ce],W.y=g[Ce+1],1!==G){var Se=u.AttributeCompression.octDecode(W.x,W.y,B),Ae=o.Transforms.eastNorthUpToFixedFrame(J[be],O,F),Pe=o.Matrix4.inverseTransformation(Ae,D);o.Matrix4.multiplyByPointAsVector(Pe,Se,Se),Se.z*=G,n.Cartesian3.normalize(Se,Se),o.Matrix4.multiplyByPointAsVector(Ae,Se,Se),n.Cartesian3.normalize(Se,Se),u.AttributeCompression.octEncode(Se,W)}}Me=Ne.encode(xe,Me,J[be],X[be],Z[be],W,$[be])}var We=Math.max(0,2*(v-4)),Be=t.indices.length+3*We,De=h.IndexDatatype.createTypedArray(I+v,Be);De.set(t.indices,0);var Fe=1e-4,ke=(ne-re)*Fe,Ve=(oe-ie)*Fe,_e=-ke,He=ke,Oe=Ve,Ge=-Ve,Ye=I*we;return V(xe,Ye,Te,Ne,Z,X,g,O,N,t.westSkirtHeight,G,d,c,_e,0),V(xe,Ye+=t.westIndices.length*we,pe,Ne,Z,X,g,O,N,t.southSkirtHeight,G,d,c,0,Ge),V(xe,Ye+=t.southIndices.length*we,fe,Ne,Z,X,g,O,N,t.eastSkirtHeight,G,d,c,He,0),V(xe,Ye+=t.eastIndices.length*we,Ee,Ne,Z,X,g,O,N,t.northSkirtHeight,G,d,c,0,Oe),E.addSkirtIndices(Te,pe,fe,Ee,I,De,t.indices.length),a.push(xe.buffer,De.buffer),{vertices:xe.buffer,indices:De.buffer,westIndicesSouthToNorth:Te,southIndicesEastToWest:pe,eastIndicesNorthToSouth:fe,northIndicesWestToEast:Ee,vertexStride:we,center:R,minimumHeight:Y,maximumHeight:z,boundingSphere:me,orientedBoundingBox:Ie,occludeePointInScaledSpace:ge,encoding:Ne,indexCountWithoutSkirts:t.indices.length}}))}));
