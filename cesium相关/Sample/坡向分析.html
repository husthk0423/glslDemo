<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">  <!-- Use Chrome Frame in IE -->
    <meta name="viewport"
          content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <meta name="description" content="A sample Vector dataset on terrain rendered with 3D Tiles.">
    <meta name="cesium-sandcastle-labels" content="Showcases, 3D Tiles">
    <title>坡向分析</title>
    <link rel="stylesheet" href="../Build/bootstrap.css">
   <script type="text/javascript" src="../Build/CesiumUnminified/Cesium.js"></script>
    <script type="text/javascript" src="../Build/CustomCesiumSDK.js"></script>
    <script type="text/javascript" src="./config.js"></script>
</head>
<body class="sandcastle-loading" data-sandcastle-bucket="bucket-requirejs.html">
<style>
    html, body, #cesiumContainer {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }

    .cesium-viewer, .cesium-viewer-cesiumWidgetContainer, .cesium-widget {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }

    canvas {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }
</style>

<span style="position: absolute;top:10px;left:10px;">
    <button class="btn btn-info" onclick="clip()">破向分析</button>
    <button class="btn btn-success" onclick="removeClip()">移除</button>
    <button class="btn btn-info" onclick="am()">上午阴影</button>
    <button class="btn btn-success" onclick="pm()">下午阴影</button>
</span>
<div id="cesiumContainer" class="fullSize"></div>
<div id="loadingOverlay"><h1>Loading...</h1></div>
<div id="toolbar"></div>
<script id="cesium_sandcastle_script">
    var viewer;
    var pickedFeature;
    var aspectPolygon;
    var aspectAnalysis;
    function startup(Cesium) {
        'use strict';
        createMap();
    }


    function removeClip(e){
        if(aspectPolygon){
            aspectAnalysis.removePolygon(aspectPolygon);
            aspectPolygon = null;
        }
    }

    function clip(e){
        viewer.scene.globe.terrainExaggeration = 1;
        aspectAnalysis = new Custom.AspectAnalysis(viewer,{
            minHeight:600,
            maxHeight:1250
        });

        aspectPolygon = aspectAnalysis.addPolygon(
            [
                Cesium.Cartesian3.fromDegrees(119.237751, 28.371917, 1000),
                Cesium.Cartesian3.fromDegrees(119.177946, 28.372862, 1000),
                Cesium.Cartesian3.fromDegrees(119.175999, 28.442828, 1000),
                Cesium.Cartesian3.fromDegrees(119.212809, 28.444119, 1000)
            ],
        );
    }

    function am(){
        viewer.shadows = true;
        var start = Cesium.JulianDate.fromDate(new Date("2021/11/26 8:00:00"));
        var end = Cesium.JulianDate.fromDate(new Date("2021/11/26 12:00:00"));
        var clock = viewer.clock;
        clock.startTime = start;
        clock.currentTime = start;
        clock.stopTime = end;
        clock.clockRange = Cesium.ClockRange.CLAMPED;
        clock.multiplier = 1000;
        clock.shouldAnimate = true;
    }

    function pm(){
        viewer.shadows = true;
        var start = Cesium.JulianDate.fromDate(new Date("2021/11/26 12:00:00"));
        var end = Cesium.JulianDate.fromDate(new Date("2021/11/26 16:00:00"));
        var clock = viewer.clock;
        clock.startTime = start;
        clock.currentTime = start;
        clock.stopTime = end;
        clock.clockRange = Cesium.ClockRange.CLAMPED;
        clock.multiplier = 1000;
        clock.shouldAnimate = true;
    }



    function createMap() {
        let cesiumTerrainProvider = new Cesium.CesiumTerrainProvider({
            // url: '../data/zjTerrain'
            url:'http://data.mars3d.cn/terrain'
        });
        viewer  = new Cesium.Viewer('cesiumContainer',{
            terrainProvider : cesiumTerrainProvider,
            tileCacheSize:0,
			useBrowserRecommendedResolution:false,
            baseLayerPicker: false,
            imageryProvider:false
        });

        viewer.scene.globe.depthTestAgainstTerrain = false;
        viewer.scene.primitives.destroyPrimitives = false;
        var imageryLayers = viewer.imageryLayers;

        viewer.scene.postProcessStages.fxaa.enabled = true;


        //天地图影像图层
        var tiandituImageLayer = new Cesium.ImageryLayer(new Cesium.WebMapTileServiceImageryProvider({
            url: baseMapUrl,
            layer: "tdtImg_c",
            style: "default",
            format: "tiles",
            tileMatrixSetID: "c",
            subdomains: ["t0", "t1", "t2", "t3", "t4", "t5", "t6", "t7"],
            tilingScheme: new Cesium.GeographicTilingScheme(),
            tileMatrixLabels: ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19"],
            maximumLevel: 18,
        }));
        viewer.imageryLayers.add(tiandituImageLayer);

        viewer.camera.setView({
            destination:Cesium.Cartesian3.fromDegrees(119.10514093954193,28.49724744269,6199.96958),//设置位置
            orientation:{
                heading:Cesium.Math.toRadians(135.302),
                pitch:Cesium.Math.toRadians(-21.81564),
            }
        });

        viewer.screenSpaceEventHandler.setInputAction(function leftClick(event) {
            var ray = viewer.camera.getPickRay(event.position);
            var c3 = viewer.scene.globe.pick(ray,viewer.scene);
            var cartographic= Cesium.Cartographic.fromCartesian(c3);
            var height=cartographic.height;
            alert('您拾取的地形高度为：'+height);
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
    }

    if (typeof Cesium !== 'undefined') {
        startup(Cesium);
    }
</script>
</body>
</html>
