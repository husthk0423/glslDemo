<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>lizi</title>
  <link rel="stylesheet" href="../Build/bootstrap.css">
  <script type="text/javascript" src="../Build/CesiumUnminified/Cesium.js"></script>
  <script type="text/javascript" src="../Build/CustomCesiumSDK.js"></script>
  <script type="text/javascript" src="./config.js"></script>
  <script type="text/javascript" src="../Build/jquery-3.1.1.min.js"></script>
  <style>
      @import url(./CesiumWight.css);
    </style>
</head>

<body>
  <div id="cesiumContainer" class="fullSize"></div>

  <div class="tab-list">
    <div class="btn-content">
      <button type="button" class="btn btn-outline-light btn-item ground-btn" onclick="startRescue()">开始救援</button>
      <button type="button" class="btn btn-outline-light btn-item ground-btn" onclick="endRescue()">结束救援</button>
    </div>
  </div>
</body>

<script>
  var viewer;
  var carEntity;
  var unsubscribeTicks;
  var firePosition;
  var firePrimitives;
  var fireLittleTime;
  var routeLinePrimitives;
  var allPositions = [
    [114.28316049000753, 35.71975445183542], [114.28584095283816, 35.71976289892203], [114.28585647755564, 35.71976655598917], [114.28587200227312, 35.7197702130563], [114.28588672513823, 35.719776347242174], [114.28590144800333, 35.71978248142805], [114.28591497667688, 35.71979092926711], [114.28592850535044, 35.71979937710618], [114.28594047931647, 35.719809913477974], [114.28595245328249, 35.71982044984977], [114.28596255345528, 35.719832793978036], [114.28597265362808, 35.7198451381063], [114.28598061085532, 35.71985896104114], [114.28598856808257, 35.71987278397598], [114.28599417031779, 35.719887717359846], [114.28599977255301, 35.71990265074371], [114.28600287050622, 35.71991829662748], [114.28600596845942, 35.719933942511254], [114.28602368354672, 35.7230739030597], [114.28602441780497, 35.72318148516996]
  ];
  allPositions.forEach(item => {
    item.push(87);
  });
  var path = allPositions.slice(0, allPositions.length - 1);

  function createMap() {
    viewer = new Cesium.Viewer('cesiumContainer', {
      selectionIndicator: false, // 是否获取选择周指示器
      useBrowserRecommendedResolution: false, // 是否以浏览器建议的分辨率渲染
      animation: false, // 是否显示动画控件
      baseLayerPicker: false, // 是否显示图层选择控件
      imageryProvider: false, // 不加载cesium提供的图层
      geocoder: false, // 是否显示地名查找控件
      timeline: false, // 是否显示时间线控件
      sceneModePicker: true, // 是否显示投影方式控件
      navigationHelpButton: false, // 是否显示帮助信息控件
      infoBox: false, // 是否显示点击要素之后显示的信息
      shouldAnimate: true
    });

    var tiandituImageLayer = new Cesium.ImageryLayer(new Cesium.WebMapTileServiceImageryProvider({
      url: baseMapUrl,
      layer: "tdtImg_c",
      style: "default",
      format: "tiles",
      tileMatrixSetID: "c",
      subdomains: ["t0", "t1", "t2", "t3", "t4", "t5", "t6", "t7"],
      tilingScheme: new Cesium.GeographicTilingScheme(),
      tileMatrixLabels: ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19"],
      maximumLevel: 17,
    }));
    viewer.imageryLayers.add(tiandituImageLayer);

    // 添加模型
    const tile3d = new Cesium.Cesium3DTileset({
      url: "http://124.70.104.88:9069/tile/hb3dtiles/tileset.json",
      showFS: false,
      showVS: false,
    });
    //  viewer.scene.primitives.add(tile3d);

    // 设置位置
    viewer.camera.setView({
      destination: Cesium.Cartesian3.fromDegrees(114.285969,35.723305,87.83288263228228),
      orientation: {
        heading: Cesium.Math.toRadians(134.69403878373637),
        pitch: Cesium.Math.toRadians(-18.31712503654326),
        roll: 0
      }
    });


    polygonInstance = new Cesium.GeometryInstance({
            geometry: Cesium.PolygonGeometry.fromPositions({
                positions: Cesium.Cartesian3.fromDegreesArray([
                114.293383,35.724872,
                114.291915,35.718762,
                114.285660,35.719381,
                114.290110,35.724894,
                   

                ]),
                height:-100,
                extrudedHeight: -100,
                vertexFormat: Cesium.VertexFormat.ALL
            }),

            attributes: {
                color: Cesium.ColorGeometryInstanceAttribute.fromColor(Cesium.Color.ANTIQUEWHITE)
            }
        });

    var waterPrimitive= new Cesium.Primitive({
            geometryInstances: [polygonInstance],
            appearance: new Cesium.PerInstanceColorAppearance(),
            asynchronous:false,
        });
  
         viewer.scene.primitives.add(waterPrimitive);

    var handler = new Cesium.ScreenSpaceEventHandler(viewer.canvas);
        handler.setInputAction(function (event) {
            var position = event.position;
            var cartesian =  viewer.scene.pickPosition(position);
            if (!Cesium.defined(cartesian)) {
                return;
            }
            var ellipsoid=viewer.scene.globe.ellipsoid;
            var cartographic=ellipsoid.cartesianToCartographic(cartesian);
            var lat=Cesium.Math.toDegrees(cartographic.latitude);
            var lng=Cesium.Math.toDegrees(cartographic.longitude);
            var height=cartographic.height;
            console.log(lng.toFixed(6)+','+ lat.toFixed(6)+','+height);

        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
  }

  // 开始救援
  function startRescue() {
    // endRescue();
    // addRouteLine();
    addFire();
    // addMoveCar();
    // changeFire();
  }

  // 结束救援
  function endRescue() {
    routeLinePrimitives = removePrimitive(routeLinePrimitives);
    removeFire();
    stopChangeFire();
    removeMove();
    removeCar();
  }

  // 加载消防车并开始移动
  function addMoveCar() {
    var speed = 0.65; // 速度
    var disObj = totalDistances([].concat(...path));
    var start = Cesium.JulianDate.fromDate(new Date(2018, 11, 12, 15));
    var totalSeconds = Math.round(disObj.totalDis * 0.01) / speed;
    var stop = Cesium.JulianDate.addSeconds(start, totalSeconds, new Cesium.JulianDate());
    var position = new Cesium.SampledPositionProperty();
    var positions = disObj.positions;
    var startIndex = 0;
    var totalNumberOfSamples = Math.round(disObj.totalDis * 0.1);

    viewer.clock.startTime = start.clone();
    viewer.clock.stopTime = stop.clone();
    viewer.clock.currentTime = start.clone();
    viewer.clock.clockRange = Cesium.ClockRange.CLAMPED;

    for (var m = 0; m < positions.length - 1; m++) {
      var startPosition = positions[m];
      var endPosition = positions[m + 1];
      var numberOfSamples = Math.round(disObj.disArr[m] * 0.1);
      for (var i = 0; i <= numberOfSamples; ++i) {
        var factor = (i + startIndex) / totalNumberOfSamples;
        var time = Cesium.JulianDate.addSeconds(start, factor * totalSeconds, new Cesium.JulianDate());
        var locationFactor = i / numberOfSamples;
        var location = Cesium.Cartesian3.lerp(startPosition, endPosition, locationFactor, new Cesium.Cartesian3());
        position.addSample(time, location);
      }
      startIndex = startIndex + numberOfSamples;
    }

    carEntity = viewer.entities.add({
      position: position,
      orientation: new Cesium.VelocityOrientationProperty(position),
      model: {
        uri: "../data/gltf/GroundVehicle.glb",
        maximumScale: 0.01,
        runAnimations: false,
      }
    });
    // 插值
    carEntity.position.setInterpolationOptions({
      interpolationDegree: 2,
      interpolationAlgorithm: Cesium.HermitePolynomialApproximation
    });
    unsubscribeTicks = viewer.clock.onTick.addEventListener(trackModel);
  }

  function totalDistances(line) {
    var positions = Cesium.Cartesian3.fromDegreesArrayHeights(line);
    var disArr = [];
    var dis = 0;
    for (var i = 0; i < positions.length - 1; i++) {
      dis = dis + Cesium.Cartesian3.distance(positions[i], positions[i + 1]);
      disArr.push(Cesium.Cartesian3.distance(positions[i], positions[i + 1]));
    }
    return { totalDis: dis, disArr: disArr, positions: positions };
  }

  // 锁定视角
  function trackModel() {
    let center = carEntity.position.getValue(viewer.clock.currentTime);
    if (!center) {
      removeMove();
      return;
    }

    const endPosition = Cesium.Cartesian3.fromDegrees(...path[path.length - 1]);
    if ((center && endPosition.x.toFixed(2) == center.x.toFixed(2) && endPosition.y.toFixed(2) == center.y.toFixed(2) && endPosition.z.toFixed(2) == center.z.toFixed(2))) {
      setTimeout(() => {
        removeMove();
      }, 1000);
      return;
    }


    let orientation = carEntity.orientation.getValue(viewer.clock.currentTime);
    let transform = Cesium.Transforms.eastNorthUpToFixedFrame(center);
    transform = Cesium.Matrix4.fromRotationTranslation(Cesium.Matrix3.fromQuaternion(orientation), center);
    viewer.camera.lookAtTransform(transform, new Cesium.Cartesian3(-100, 0, 20));
  }

  function removeMove() {
    if (unsubscribeTicks) {
      unsubscribeTicks();
      unsubscribeTicks = null;
      viewer.camera.lookAtTransform(Cesium.Matrix4.IDENTITY);
    }
  }

  function removeCar() {
    if (carEntity) {
      viewer.entities.remove(carEntity);
      carEntity = null;
    }
  }

  // 添加路线
  function addRouteLine(positions) {
    var polylineinstance = new Cesium.GeometryInstance({
      geometry: new Cesium.PolylineGeometry({
        positions: Cesium.Cartesian3.fromDegreesArrayHeights([].concat(...path)),
        width: 20
      }),
      vertexFormat: Cesium.PolylineMaterialAppearance.VERTEX_FORMAT,
    });
    routeLinePrimitives = viewer.scene.primitives.add(new Cesium.Primitive({
      geometryInstances: [polylineinstance],
      appearance: new Cesium.PolylineMaterialAppearance({
        material: Cesium.Material.fromType('DynamicGlow', {
          color: Cesium.Color.fromCssColorString('#1E90FF'),
          repeat: new Cesium.Cartesian2(1, 1),
          speed: 10,
          image: 'http://123.249.3.227:8021/developer-center-0828/example/img/line.png',
          axisY: false
        })
      })
    }));
  }

  // 添加火焰
  function addFire() {
    firePosition = viewer.entities.add({
      position: Cesium.Cartesian3.fromDegrees(...allPositions[allPositions.length - 1]),
    });

    firePrimitives = viewer.scene.primitives.add(
      new Cesium.ParticleSystem({
        image: "../image/shuidi.png",
        startScale: 8.5,
        endScale: 10,
        maximumParticleLife: 2,
        minimumParticleLife: 1,
        maximumSpeed: 1.5,
        minimumSpeed: 1,
        maximageSize: new Cesium.Cartesian2(10, 10),
        minimageSize: new Cesium.Cartesian2(1, 1),
        emissionRate: 4,
        lifetime: 600.0,
        emitter: new Cesium.BoxEmitter(new Cesium.Cartesian3(50.0, 50.0, 15.0)),
        modelMatrix: computeModelMatrix(firePosition, Cesium.JulianDate.now()),
        emitterModelMatrix: computeEmitterModelMatrix(),
        sizeInMeters: true
      })
    );
  }

  function computeModelMatrix(entity, time) {
    var position = entity.position._value;
    let modelMatrix = Cesium.Transforms.eastNorthUpToFixedFrame(position);
    return modelMatrix;
  }

  function computeEmitterModelMatrix() {
    let hpr = Cesium.HeadingPitchRoll.fromDegrees(0, 0, 0);
    let trs = new Cesium.TranslationRotationScale();
    trs.translation = Cesium.Cartesian3.fromElements(2.5, 4, 1);
    trs.rotation = Cesium.Quaternion.fromHeadingPitchRoll(hpr);
    let result = Cesium.Matrix4.fromTranslationRotationScale(trs);
    return result;
  }

  function changeFire() {
    var maxSize = 10;
    fireLittleTime = setInterval(() => {
      if (maxSize <= 1) {
        stopChangeFire();
      }
      maxSize -= 1;
      firePrimitives._maximumImageSize = new Cesium.Cartesian2(maxSize, maxSize);
    }, 500);
  }

  function stopChangeFire() {
    if (fireLittleTime) {
      clearInterval(fireLittleTime);
      fireLittleTime = null;
    }
  }

  // 删除火焰
  function removeFire() {
    if (firePosition) {
      viewer.entities.remove(firePosition);
      firePosition = null;
    }
    firePrimitives = removePrimitive(firePrimitives);
  }

  function removePrimitive(primitives) {
    if (primitives) {
      viewer.scene.primitives.remove(primitives);
      primitives.destroy();
      primitives = null;
    }
    return null;
  }

  function startup() {
    'use strict';
    createMap();
    startRescue();
    
  }

  if (typeof Cesium !== 'undefined') {
    startup();
  }
</script>

</html>