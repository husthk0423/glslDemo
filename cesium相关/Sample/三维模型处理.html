<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">  <!-- Use Chrome Frame in IE -->
    <meta name="viewport"
          content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <meta name="description" content="A sample Vector dataset on terrain rendered with 3D Tiles.">
    <meta name="cesium-sandcastle-labels" content="Showcases, 3D Tiles">
    <title>三维模型处理</title>
    <link rel="stylesheet" href="../Build/bootstrap.css">
   <script type="text/javascript" src="../Build/CesiumUnminified/Cesium.js"></script>
    <script type="text/javascript" src="../Build/CustomCesiumSDK.js"></script>
    <script type="text/javascript" src="./config.js"></script>
</head>
<body class="sandcastle-loading" data-sandcastle-bucket="bucket-requirejs.html">
<style>
    html, body, #cesiumContainer {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }

    .cesium-viewer, .cesium-viewer-cesiumWidgetContainer, .cesium-widget {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }

    canvas {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }
    .rotate{
        width:100px;
        line-height: 25px;
        border-radius: 5px;
        font-size: 16px;
        border: 1px solid gray;
        color: rgb(49, 40, 40); 
      }
</style>

<span style="position: absolute;top:10px;left:10px;">
  <div style="display: inline-block;width: 210px;">
      <span id="value1">0</span>
    <input type="range" max="10" min="1" id="range" step="1" value="1" onchange="setScale(this)">
    <span id="value2">10</span>
  </div>

    <input  class="rotate" type="text" onchange="rotate(this)">
    <span  style="color: rgb(65, 63, 63);">Z轴旋转</span></input>
    <button class="btn btn-primary" onclick="reset()">模型复位</button>
    <button class="btn btn-info" onclick="clip()">模型裁切</button>
    <button class="btn btn-success" onclick="extract()">边界提取</button>
</span>
<div id="cesiumContainer" class="fullSize"></div>
<div id="loadingOverlay"><h1>Loading...</h1></div>
<div id="toolbar"></div>
<script id="cesium_sandcastle_script">
    var viewer;
    var pickedFeature;
    var initModelMatrix;
    var model;
    function startup(Cesium) {
        'use strict';
        createMap();
    }

    function rotate(e){
        var value = parseFloat(e.value);
        if(pickedFeature){
            var matrix3 = Cesium.Matrix3.fromRotationZ(Cesium.Math.toRadians(value));
            pickedFeature.primitive.modelMatrix = Cesium.Matrix4.multiplyByMatrix3(pickedFeature.primitive.modelMatrix,
                matrix3,new Cesium.Matrix4());
        }
    }

    function setScale(e){
        var scale = parseFloat(e.value);
        let value1=document.getElementById('value1')
        let value2=document.getElementById('value2')
        value1.innerHTML=scale==1?0:scale
        value2.innerHTML=10-scale==9?10:10-scale
        if(pickedFeature){
            pickedFeature.primitive.scale = scale;
        }
    }

    function reset(){
        if(pickedFeature){
            pickedFeature.primitive.modelMatrix = initModelMatrix;
            pickedFeature.primitive.scale = 1;
        }
    }

    function extract(){
        var silhouetteBlue = Cesium.PostProcessStageLibrary.createEdgeDetectionStage();
        silhouetteBlue.uniforms.color = Cesium.Color.BLUE;
        silhouetteBlue.uniforms.length = 0.1;
        silhouetteBlue.selected = [];

        viewer.scene.postProcessStages.add(Cesium.PostProcessStageLibrary.createSilhouetteStage([silhouetteBlue]));
        silhouetteBlue.selected = [model];
    }






    function clip(){
        var clippingPlanes = new Cesium.ClippingPlaneCollection({
            planes: [
                new Cesium.ClippingPlane(
                    new Cesium.Cartesian3(0.0, 0.0, -1.0),
                    0.0
                ),
            ],
            edgeWidth:  1.0 ,
        });

        var position = Cesium.Cartesian3.fromDegrees(
            109.81731194104569,
            40.69368312146115,
            30.0
        );


        model.clippingPlanes = clippingPlanes;

        var plane = clippingPlanes.get(0);
        var planeEntity = viewer.entities.add({
            position: position,
            plane: {
                dimensions: new Cesium.Cartesian2(800.0, 800.0),
                material: Cesium.Color.WHITE.withAlpha(0.1),
                plane: new Cesium.CallbackProperty(
                    createPlaneUpdateFunction(plane),
                    false
                ),
                outline: true,
                outlineColor: Cesium.Color.WHITE,
            },
        });

        var targetY = 0.0;
        var planeEntities = [];
        var selectedPlane;
        var clippingPlanes;

        // Select plane when mouse down
        var downHandler = new Cesium.ScreenSpaceEventHandler(
            viewer.scene.canvas
        );
        downHandler.setInputAction(function (movement) {
            var pickedObject = viewer.scene.pick(movement.position);
            if (
                Cesium.defined(pickedObject) &&
                Cesium.defined(pickedObject.id) &&
                Cesium.defined(pickedObject.id.plane)
            ) {
                selectedPlane = pickedObject.id.plane;
                selectedPlane.material = Cesium.Color.WHITE.withAlpha(0.05);
                selectedPlane.outlineColor = Cesium.Color.WHITE;
                viewer.scene.screenSpaceCameraController.enableInputs = false;
            }
        }, Cesium.ScreenSpaceEventType.LEFT_DOWN);

        // Release plane on mouse up
        var upHandler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
        upHandler.setInputAction(function () {
            if (Cesium.defined(selectedPlane)) {
                selectedPlane.material = Cesium.Color.WHITE.withAlpha(0.1);
                selectedPlane.outlineColor = Cesium.Color.WHITE;
                selectedPlane = undefined;
            }

            viewer.scene.screenSpaceCameraController.enableInputs = true;
        }, Cesium.ScreenSpaceEventType.LEFT_UP);

        // Update plane on mouse move
        var moveHandler = new Cesium.ScreenSpaceEventHandler(
            viewer.scene.canvas
        );
        moveHandler.setInputAction(function (movement) {
            if (Cesium.defined(selectedPlane)) {
                var deltaY = movement.startPosition.y - movement.endPosition.y;
                targetY += deltaY;
            }
        }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);

        function createPlaneUpdateFunction(plane) {
            return function () {
                plane.distance = targetY;
                return plane;
            };
        }
    }


    function createMap() {
        viewer  = new Cesium.Viewer('cesiumContainer',{
            tileCacheSize:0,
			useBrowserRecommendedResolution:false,
            baseLayerPicker: false,
            imageryProvider:false
        });

        viewer.scene.globe.depthTestAgainstTerrain = false;
        viewer.scene.primitives.destroyPrimitives = false;
        var imageryLayers = viewer.imageryLayers;

        viewer.scene.postProcessStages.fxaa.enabled = true;


        //天地图影像图层
        var tiandituImageLayer = new Cesium.ImageryLayer(new Cesium.WebMapTileServiceImageryProvider({
            url: baseMapUrl,
            layer: "tdtImg_c",
            style: "default",
            format: "tiles",
            tileMatrixSetID: "c",
            subdomains: ["t0", "t1", "t2", "t3", "t4", "t5", "t6", "t7"],
            tilingScheme: new Cesium.GeographicTilingScheme(),
            tileMatrixLabels: ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19"],
            maximumLevel: 18,
        }));
        viewer.imageryLayers.add(tiandituImageLayer);


        var m = Cesium.Matrix4.IDENTITY;
        m = Cesium.Matrix4.setScale(m,new Cesium.Cartesian3(10.0,10.0,10.0),new Cesium.Matrix4());
        initModelMatrix = Cesium.Transforms.eastNorthUpToFixedFrame(Cesium.Cartesian3.fromDegrees( 109.81731194104569,
            40.69368312146115,0));
        initModelMatrix = Cesium.Matrix4.multiply( initModelMatrix,m, new Cesium.Matrix4());

       model =  new Cesium.Model.fromGltf({
           id:'shanghai',
          url : '../data/plane.glb',
           scale:1,
           modelMatrix: initModelMatrix,
           forwardAxis: Cesium.Axis.X,
           upAxis:Cesium.Axis.Y
        });
		
        viewer.scene.primitives.add(model);

        viewer.camera.setView({
            destination:Cesium.Cartesian3.fromDegrees( 109.82081710898898,40.680719741107055,441.6902),//设置位置
            orientation:{
                heading:Cesium.Math.toRadians(348.466684),
                pitch:Cesium.Math.toRadians(-17.91842),
                roll:Cesium.Math.toRadians(0)
            }
        });


        const drag = new Custom.DragModel(viewer);
        drag.enable();

        viewer.screenSpaceEventHandler.setInputAction(function leftClick(movement) {
            pickedFeature = viewer.scene.pick(movement.position);
            if(Cesium.defined(pickedFeature)) {
                var primitive = pickedFeature.primitive;
                primitive.color = Cesium.Color.fromCssColorString('#cc0000');
                //
            }else{
                model.color = Cesium.Color.WHITE;
            }
        }, Cesium.ScreenSpaceEventType.LEFT_DOWN);
    }

    if (typeof Cesium !== 'undefined') {
        startup(Cesium);
    }
</script>
</body>
</html>
