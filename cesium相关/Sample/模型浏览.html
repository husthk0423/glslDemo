<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">  <!-- Use Chrome Frame in IE -->
    <meta name="viewport"
          content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <meta name="description" content="A sample Vector dataset on terrain rendered with 3D Tiles.">
    <meta name="cesium-sandcastle-labels" content="Showcases, 3D Tiles">
    <title>模型浏览</title>
    <link rel="stylesheet" href="../Build/bootstrap.css">
   <script type="text/javascript" src="../Build/CesiumUnminified/Cesium.js"></script>
    <script type="text/javascript" src="../Build/CustomCesiumSDK.js"></script>
    <script type="text/javascript" src="./config.js"></script>
</head>
<body class="sandcastle-loading" data-sandcastle-bucket="bucket-requirejs.html">
<style>
    html, body, #cesiumContainer {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }

    .cesium-viewer, .cesium-viewer-cesiumWidgetContainer, .cesium-widget {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }

    canvas {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }
</style>
<span style="position: absolute;top:10px;left:10px;">
    <button class="btn btn-primary" onclick="intCut()">box内部裁剪</button>
    <button class="btn btn-info" onclick="outCut()">box外部裁剪</button>
    <button class="btn btn-success" onclick="planeCut()">平面裁剪</button>
    <button class="btn btn-warning" onclick="cancelPlaneCut()">取消平面裁剪</button>
</span>
<div id="cesiumContainer" class="fullSize"></div>
<div id="loadingOverlay"><h1>Loading...</h1></div>
<div id="toolbar"></div>
<script id="cesium_sandcastle_script">
    var viewer;
    var tilesetClip;
    var clipPolygon;
    var tile3d;
    function startup(Cesium) {
		createMap();
    }

    function outCut(){
        tilesetClip.clipOutSide = true;
        if(clipPolygon){
            tilesetClip.removePolygon(clipPolygon);
        }

        clipPolygon = tilesetClip.addPolygon([
            Cesium.Cartesian3.fromDegrees(118.938086,31.355033, 0),
            Cesium.Cartesian3.fromDegrees(118.939368,31.355861, 0),
            Cesium.Cartesian3.fromDegrees(118.940346,31.354808, 0),
            Cesium.Cartesian3.fromDegrees(118.939343,31.354141, 0),
        ]);
    }

    function intCut(){
        tilesetClip.clipOutSide = false;
        if(clipPolygon){
            tilesetClip.removePolygon(clipPolygon);
        }

        clipPolygon = tilesetClip.addPolygon([
            Cesium.Cartesian3.fromDegrees(118.938086,31.355033, 0),
            Cesium.Cartesian3.fromDegrees(118.939368,31.355861, 0),
            Cesium.Cartesian3.fromDegrees(118.940346,31.354808, 0),
            Cesium.Cartesian3.fromDegrees(118.939343,31.354141, 0),
        ]);
    }

    function planeCut(){
        if(!tile3d.clippingPlanes || tile3d.clippingPlanes._planes.length == 0){
            var clippingPlanes = new Cesium.ClippingPlaneCollection({
                planes: [
                    new Cesium.ClippingPlane(
                        new Cesium.Cartesian3(0.0, 0.0, -1.0),
                        50.0
                    ),
                ],
                edgeWidth:  1.0 ,
            });

            tile3d.clippingPlanes = clippingPlanes;
        }
    }

    function cancelPlaneCut(){
        tile3d.clippingPlanes.removeAll();
    }

    function createMap() {
        viewer  = new Cesium.Viewer('cesiumContainer',{
            selectionIndicator: false,
            useBrowserRecommendedResolution:false,
            animation: false,  //是否显示动画控件
            baseLayerPicker: false, //是否显示图层选择控件
            geocoder: false, //是否显示地名查找控件
            timeline: false, //是否显示时间线控件
            sceneModePicker: true, //是否显示投影方式控件
            navigationHelpButton: false, //是否显示帮助信息控件
            infoBox: false,  //是否显示点击要素之后显示的信息
            imageryProvider:false,
            fullscreenButton: true});

        viewer.scene.globe.preloadAncestors = false;

		viewer.scene.primitives.destroyPrimitives = false;
        viewer.scene.globe.depthTestAgainstTerrain = true;
        var imageryLayers = viewer.imageryLayers;

        Cesium.viewer = viewer;

        //天地图影像图层
        var tiandituImageLayer = new Cesium.ImageryLayer(new Cesium.WebMapTileServiceImageryProvider({
            url: baseMapUrl,
            layer: "tdtImg_c",
            style: "default",
            format: "tiles",
            tileMatrixSetID: "c",
            subdomains: ["t0", "t1", "t2", "t3", "t4", "t5", "t6", "t7"],
            tilingScheme: new Cesium.GeographicTilingScheme(),
            tileMatrixLabels: ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19"],
            maximumLevel: 18,
        }));
        viewer.imageryLayers.add(tiandituImageLayer);

        tile3d = new Cesium.Cesium3DTileset({
            maximumMemoryUsage:1024,
            url: '../data/寺庙3D/Data/scene.json',
        });

        tile3d.readyPromise.then(function(tileset){
            tilesetClip = new Custom.TilesetClip(viewer,{
                tileset: tile3d,
                clipOutSide: false
            });

            viewer.flyTo(tileset);
        });

        viewer.scene.primitives.add(tile3d);



        var model;
        viewer.screenSpaceEventHandler.setInputAction(function leftClick(movement) {
            pickedFeature = viewer.scene.pick(movement.position);
            if(Cesium.defined(pickedFeature)) {
                if(model){
                    model.color = Cesium.Color.WHITE;
                };
                model = pickedFeature.content._model;
                model.color = Cesium.Color.fromCssColorString('#E9967A');
            }
        }, Cesium.ScreenSpaceEventType.LEFT_DOWN);

        // viewer.camera.setView({
        //     destination:Cesium.Cartesian3.fromDegrees(118.93919493594063,31.349516627158277,543.195136068),
        //     orientation:{
        //         heading:Cesium.Math.toRadians(358.97999),
        //         pitch:Cesium.Math.toRadians(-38.801),
        //         roll:Cesium.Math.toRadians(359.98606702327737)
        //     }
        // });
    }

    if (typeof Cesium !== 'undefined') {
        startup(Cesium);
    }
</script>
</body>
</html>
