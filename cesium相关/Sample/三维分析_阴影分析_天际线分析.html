<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">  <!-- Use Chrome Frame in IE -->
    <meta name="viewport"
          content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <meta name="description" content="A sample Vector dataset on terrain rendered with 3D Tiles.">
    <meta name="cesium-sandcastle-labels" content="Showcases, 3D Tiles">
    <title>倾斜摄影模型操作_分析</title>
    <link rel="stylesheet" href="../Build/bootstrap.css">
    <script type="text/javascript" src="../Build/CesiumUnminified/Cesium.js"></script>
    <script type="text/javascript" src="../Build/CustomCesiumSDK.js"></script>
    <script type="text/javascript" src="./config.js"></script>
</head>
<body class="sandcastle-loading" data-sandcastle-bucket="bucket-requirejs.html">
<style>
    html, body, #cesiumContainer {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }

    .cesium-viewer, .cesium-viewer-cesiumWidgetContainer, .cesium-widget {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }

    canvas {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }
</style>
<span style="position: absolute;top:10px;left:10px;">
    <button class="btn btn-primary" onclick="skyline()">天际线分析</button>
    <button class="btn btn-info" onclick="am()">上午阴影</button>
    <button class="btn btn-success" onclick="pm()">下午阴影</button>
</span>
<div id="cesiumContainer" class="fullSize"></div>
<div id="loadingOverlay"><h1>Loading...</h1></div>
<div id="toolbar"></div>
<script id="cesium_sandcastle_script">
    var viewer;
    var skyLineStage;
    function startup(Cesium) {
        createMap();
    }

    function am(){
        viewer.shadows = true;
        var start = Cesium.JulianDate.fromDate(new Date("2021/11/26 8:00:00"));
        var end = Cesium.JulianDate.fromDate(new Date("2021/11/26 12:00:00"));
        var clock = viewer.clock;
        clock.startTime = start;
        clock.currentTime = start;
        clock.stopTime = end;
        clock.clockRange = Cesium.ClockRange.CLAMPED;
        clock.multiplier = 1000;
        clock.shouldAnimate = true;
    }

    function pm(){
        viewer.shadows = true;
        var start = Cesium.JulianDate.fromDate(new Date("2021/11/26 12:00:00"));
        var end = Cesium.JulianDate.fromDate(new Date("2021/11/26 16:00:00"));
        var clock = viewer.clock;
        clock.startTime = start;
        clock.currentTime = start;
        clock.stopTime = end;
        clock.clockRange = Cesium.ClockRange.CLAMPED;
        clock.multiplier = 1000;
        clock.shouldAnimate = true;
    }

    function skyline(){
        viewer.shadows = false;
        viewer.clock.shouldAnimate = false;
        var edgeDetection = Cesium.PostProcessStageLibrary.createEdgeDetectionStage();
        var postProccessStage = new Cesium.PostProcessStage({
            name: 'czm_skylinetemp',
            fragmentShader: 'uniform sampler2D colorTexture;' +
                'uniform sampler2D depthTexture;' +

                'varying vec2 v_textureCoordinates;' +

                'void main(void)' +
                '{' +
                'float depth = czm_readDepth(depthTexture, v_textureCoordinates);' +
                'vec4 color = texture2D(colorTexture, v_textureCoordinates);' +
                'if(depth<1.0 - 0.000001){'+
                'gl_FragColor = color;' +
                '}'+
                'else{'+
                'gl_FragColor = vec4(1.0,0.0,0.0,1.0);'+
                '}'+
                '}'
        });

        var postProccessStage1 = new Cesium.PostProcessStage({
            name: 'czm_skylinetemp1',
            fragmentShader: 'uniform sampler2D colorTexture;' +
                'uniform sampler2D redTexture;' +
                'uniform sampler2D silhouetteTexture;' +

                'varying vec2 v_textureCoordinates;' +

                'void main(void)' +
                '{' +
                'vec4 redcolor=texture2D(redTexture, v_textureCoordinates);'+
                'vec4 silhouetteColor = texture2D(silhouetteTexture, v_textureCoordinates);' +
                'vec4 color = texture2D(colorTexture, v_textureCoordinates);' +
                'if(redcolor.r == 1.0){'+
                'gl_FragColor = mix(color, vec4(1.0,0.0,0.0,1.0), silhouetteColor.a);' +
                '}'+
                'else{'+
                'gl_FragColor = color;'+
                '}'+
                '}',
            uniforms: {
                redTexture: postProccessStage.name,
                silhouetteTexture: edgeDetection.name
            }
        });

        var collection = viewer.scene.postProcessStages;
        if(skyLineStage){
            collection.remove(skyLineStage);
        }

        skyLineStage = new Cesium.PostProcessStageComposite({
            name: 'czm_skyline',
            stages: [edgeDetection, postProccessStage, postProccessStage1],
            inputPreviousStageTexture: false,
            uniforms: edgeDetection.uniforms
        });
        collection.add(skyLineStage);
    }

    function createMap() {
        viewer  = new Cesium.Viewer('cesiumContainer',{
            selectionIndicator: false,
            useBrowserRecommendedResolution:false,
            animation: false,  //是否显示动画控件
            baseLayerPicker: false, //是否显示图层选择控件
            geocoder: false, //是否显示地名查找控件
            timeline: false, //是否显示时间线控件
            sceneModePicker: true, //是否显示投影方式控件
            navigationHelpButton: false, //是否显示帮助信息控件
            infoBox: false,  //是否显示点击要素之后显示的信息
            imageryProvider:false,
            fullscreenButton: true});

        viewer.scene.globe.preloadAncestors = false;

        viewer.scene.primitives.destroyPrimitives = false;
        viewer.scene.globe.depthTestAgainstTerrain = true;
        var imageryLayers = viewer.imageryLayers;

        Cesium.viewer = viewer;

        //天地图影像图层
        var tiandituImageLayer = new Cesium.ImageryLayer(new Cesium.WebMapTileServiceImageryProvider({
            url: baseMapUrl,
            layer: "tdtImg_c",
            style: "default",
            format: "tiles",
            tileMatrixSetID: "c",
            subdomains: ["t0", "t1", "t2", "t3", "t4", "t5", "t6", "t7"],
            tilingScheme: new Cesium.GeographicTilingScheme(),
            tileMatrixLabels: ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19"],
            maximumLevel: 18,
        }));
        viewer.imageryLayers.add(tiandituImageLayer);


        var m = Cesium.Matrix4.IDENTITY;
        m = Cesium.Matrix4.setScale(m,new Cesium.Cartesian3(5.0,5.0,5.0),new Cesium.Matrix4());
        var initModelMatrix = Cesium.Transforms.eastNorthUpToFixedFrame(Cesium.Cartesian3.fromDegrees(118.942905,31.358873,0));
        initModelMatrix = Cesium.Matrix4.multiply( initModelMatrix,m, new Cesium.Matrix4());

        var model =  new Cesium.Model.fromGltf({
            id:'shanghai',
            url : '../data/Tower.glb',
            scale:1,
            modelMatrix: initModelMatrix,
            forwardAxis: Cesium.Axis.X,
            upAxis:Cesium.Axis.Y
        });

        viewer.scene.primitives.add(model);

        viewer.camera.setView({
            destination:Cesium.Cartesian3.fromDegrees(118.94793619425768,31.347461684159914,228.290),
            orientation:{
                heading:Cesium.Math.toRadians(340.0809),
                pitch:Cesium.Math.toRadians(-9.86),
                roll:Cesium.Math.toRadians(359.98606702327737)
            }
        });
    }

    if (typeof Cesium !== 'undefined') {
        startup(Cesium);
    }
</script>
</body>
</html>
