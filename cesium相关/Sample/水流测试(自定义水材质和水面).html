<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"> <!-- Use Chrome Frame in IE -->
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <meta name="description" content="A sample Vector dataset on terrain rendered with 3D Tiles.">
    <meta name="cesium-sandcastle-labels" content="Showcases, 3D Tiles">
    <title>水流测试(鹤壁)</title>
    <link rel="stylesheet" href="../Build/bootstrap.css">
    <script type="text/javascript" src="../Build/CesiumUnminified/Cesium.js"></script>
    <script type="text/javascript" src="../Build/CustomCesiumSDK.js"></script>
    <script type="text/javascript" src="./config.js"></script>
    <script type="text/javascript" src="../Build/jquery-3.1.1.min.js"></script>
</head>
<style>
    html,
    body,
    #cesiumContainer {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }

    .cesium-viewer,
    .cesium-viewer-cesiumWidgetContainer,
    .cesium-widget {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }

    canvas {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }
</style>
<span style="position: absolute;top:10px;left:10px;">
    <button class="btn btn-primary" onclick="flood()">淹没分析</button>
</span>
<div id="cesiumContainer" class="fullSize"></div>
<div id="loadingOverlay">
    <h1>Loading...</h1>
</div>
<div id="toolbar"></div>
<script id="cesium_sandcastle_script">
    var viewer;
    var waterPrimitive;
    function startup(Cesium) {
        createMap();
    }

    function flood() {
        waterPrimitive.show = true;
        var startHeight = 190;
        var targetHeight = 220;
        var waterHeight = startHeight;
        var timer = setInterval(() => {
            if (waterHeight < targetHeight) {
                waterHeight += 5;
                if (waterHeight > targetHeight) {
                    waterHeight = targetHeight
                }
                updateHeight(waterPrimitive, waterHeight / startHeight, [114.13765317673011,35.66575173734317]);
            }
        }, 100);
    }


    function updateHeight(waterPrimitive, scale, center) {
        var cc = Cesium.Cartesian3.fromDegrees(center[0], center[1], 0);
        let m = Cesium.Transforms.eastNorthUpToFixedFrame(cc);
        let inverse = Cesium.Matrix4.inverse(m, new Cesium.Matrix4);
        
        let mScale = Cesium.Matrix4.fromScale(new Cesium.Cartesian3(1.0, 1.0, scale));
        let tt = Cesium.Matrix4.multiply(mScale, inverse, new Cesium.Matrix4);
        waterPrimitive.modelMatrix = Cesium.Matrix4.multiply(m, tt, new Cesium.Matrix4);
    }
    function createMap() {
        let cesiumTerrainProvider = new Cesium.CesiumTerrainProvider({
            url:'http://data.mars3d.cn/terrain'

        });
        viewer = new Cesium.Viewer('cesiumContainer', {
             selectionIndicator: false,
            terrainProvider: cesiumTerrainProvider,
            animation: false,  //是否显示动画控件
            baseLayerPicker: true, //是否显示图层选择控件x
            geocoder: false, //是否显示地名查找控件
            timeline: true, //是否显示时间线控件
            sceneModePicker: true, //是否显示投影方式控件
            navigationHelpButton: false, //是否显示帮助信息控件
            infoBox: false,  //是否显示点击要素之后显示的信息
            imageryProvider: false,
            vrButton: true,
            useBrowserRecommendedResolution: false,
            fullscreenButton: true
        });
        
        viewer.scene.primitives.destroyPrimitives = false;
        viewer.scene.globe.preloadAncestors = true;
        viewer.scene.globe.depthTestAgainstTerrain = true;
        var imageryLayers = viewer.imageryLayers;
        var scene = viewer.scene;
        //天地图影像图层
        var tiandituImageLayer = new Cesium.ImageryLayer(new Cesium.WebMapTileServiceImageryProvider({
            url: baseMapUrl,
            layer: "",
            style: "",
            format: "",
            tileMatrixSetID: "",
            subdomains: ["t0", "t1", "t2", "t3", "t4", "t5", "t6", "t7"],
            tilingScheme: new Cesium.GeographicTilingScheme(),
            tileMatrixLabels: ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19"],
            maximumLevel: 18,
        }));
        viewer.imageryLayers.add(tiandituImageLayer);

        viewer.clock.currentTime = Cesium.JulianDate.addHours(Cesium.JulianDate.now(new Date()),6, new Cesium.JulianDate());
        viewer.scene.postProcessStages._fxaa.enabled = true;    
        viewer.camera.setView({
            destination:Cesium.Cartesian3.fromDegrees(114.12702529214672,35.66597899518117,1200),//设置位置
            orientation:{
                heading:Cesium.Math.toRadians(358),
                pitch:Cesium.Math.toRadians(-74),
            }
        });

        $.getJSON("../data/shuiyu(1).json",function(result){
           let arr = []
           result.features.forEach(item=>{
             if(item&&item.geometry.coordinates){
              item.geometry.coordinates[0].forEach(obj=>{
                arr.push(Number(obj[0]),Number(obj[1]))
             })
             }
           })
           var positions = Cesium.Cartesian3.fromDegreesArray(arr);

           var polygonInstance = new Cesium.GeometryInstance({
            geometry: Cesium.PolygonGeometry.fromPositions({
                positions:positions,
                height:125,
                extrudedHeight: 125,
                vertexFormat: Cesium.VertexFormat.ALL
            }),

            attributes: {
                color: Cesium.ColorGeometryInstanceAttribute.fromColor(Cesium.Color.fromCssColorString('#ff0000').withAlpha(0.5))
            }
          });
    waterPrimitive = new Cesium.GroundPrimitive({
            show: false,
            geometryInstances: [polygonInstance],
            appearance: new Cesium.EllipsoidSurfaceAppearance({
                material: Cesium.Material.fromType(Custom.PieWaterMaterialType, {
                    WaveImage: "../image/water.jpg",
                    bottomImage: "../image/shazi.jpeg",
            })
         })
       });
        
        viewer.scene.primitives.add(waterPrimitive);
         })

        // var handler = new Cesium.ScreenSpaceEventHandler(viewer.canvas);
        // handler.setInputAction(function (event) {
        //     var ray = viewer.camera.getPickRay(event.position);
        //     var c3 = scene.globe.pick(ray,scene);
        //     var cartographic= Cesium.Cartographic.fromCartesian(c3);
        //     var lat=Cesium.Math.toDegrees(cartographic.latitude);
        //     var lng=Cesium.Math.toDegrees(cartographic.longitude);
        //     var height=cartographic.height;
        //      alert(lng.toFixed(6)+','+ lat.toFixed(6)+','+height);

        // }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
       

    }

    if (typeof Cesium !== 'undefined') {
        startup(Cesium);
    }
</script>
</body>

</html>